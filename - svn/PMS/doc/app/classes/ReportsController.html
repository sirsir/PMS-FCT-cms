<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: ReportsController</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">ReportsController</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/controllers/reports_controller_rb.html">
                app/controllers/reports_controller.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                <a href="ApplicationController.html">
                ApplicationController
               </a>
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000586">action_daily</a>&nbsp;&nbsp;
      <a href="#M000595">action_daily_rank_1</a>&nbsp;&nbsp;
      <a href="#M000596">action_daily_rank_2</a>&nbsp;&nbsp;
      <a href="#M000587">action_daily_report</a>&nbsp;&nbsp;
      <a href="#M000597">action_daily_rpt_1</a>&nbsp;&nbsp;
      <a href="#M000598">action_daily_rpt_2</a>&nbsp;&nbsp;
      <a href="#M000592">action_daily_type1_1</a>&nbsp;&nbsp;
      <a href="#M000591">action_daily_type1_2</a>&nbsp;&nbsp;
      <a href="#M000590">action_daily_type1_3</a>&nbsp;&nbsp;
      <a href="#M000589">action_daily_type1_4</a>&nbsp;&nbsp;
      <a href="#M000588">action_daily_type1_5</a>&nbsp;&nbsp;
      <a href="#M000594">action_daily_type2_4</a>&nbsp;&nbsp;
      <a href="#M000593">action_daily_type2_5</a>&nbsp;&nbsp;
      <a href="#M000556">cache_hack</a>&nbsp;&nbsp;
      <a href="#M000555">clean_field_filters</a>&nbsp;&nbsp;
      <a href="#M000574">company_branch</a>&nbsp;&nbsp;
      <a href="#M000573">company_branch_hash</a>&nbsp;&nbsp;
      <a href="#M000575">company_branch_id</a>&nbsp;&nbsp;
      <a href="#M000603">compare_action</a>&nbsp;&nbsp;
      <a href="#M000604">compare_action_report</a>&nbsp;&nbsp;
      <a href="#M000543">create</a>&nbsp;&nbsp;
      <a href="#M000564">csv</a>&nbsp;&nbsp;
      <a href="#M000561">csv_report</a>&nbsp;&nbsp;
      <a href="#M000576">cust_new</a>&nbsp;&nbsp;
      <a href="#M000572">cust_rank</a>&nbsp;&nbsp;
      <a href="#M000545">destroy</a>&nbsp;&nbsp;
      <a href="#M000539">edit</a>&nbsp;&nbsp;
      <a href="#M000553">edit_filter</a>&nbsp;&nbsp;
      <a href="#M000551">edit_format</a>&nbsp;&nbsp;
      <a href="#M000560">excel_report</a>&nbsp;&nbsp;
      <a href="#M000557">export</a>&nbsp;&nbsp;
      <a href="#M000599">export_action_daily</a>&nbsp;&nbsp;
      <a href="#M000605">export_compare_action</a>&nbsp;&nbsp;
      <a href="#M000584">export_grand_total</a>&nbsp;&nbsp;
      <a href="#M000585">export_grand_total_billcount</a>&nbsp;&nbsp;
      <a href="#M000602">export_rank_history</a>&nbsp;&nbsp;
      <a href="#M000537">fetch_report</a>&nbsp;&nbsp;
      <a href="#M000549">formats</a>&nbsp;&nbsp;
      <a href="#M000558">generate</a>&nbsp;&nbsp;
      <a href="#M000567">get_all_customfield</a>&nbsp;&nbsp;
      <a href="#M000566">get_all_screen</a>&nbsp;&nbsp;
      <a href="#M000569">get_custom_field_id_by_name</a>&nbsp;&nbsp;
      <a href="#M000568">get_name_for_rank_value</a>&nbsp;&nbsp;
      <a href="#M000570">get_reference</a>&nbsp;&nbsp;
      <a href="#M000532">get_session_report_results</a>&nbsp;&nbsp;
      <a href="#M000577">gtotal</a>&nbsp;&nbsp;
      <a href="#M000580">gtotal_by_area</a>&nbsp;&nbsp;
      <a href="#M000583">gtotal_by_bill_count</a>&nbsp;&nbsp;
      <a href="#M000581">gtotal_by_rank</a>&nbsp;&nbsp;
      <a href="#M000579">gtotal_by_rpt</a>&nbsp;&nbsp;
      <a href="#M000582">gtotal_by_sales_product</a>&nbsp;&nbsp;
      <a href="#M000578">gtotal_report</a>&nbsp;&nbsp;
      <a href="#M000535">index</a>&nbsp;&nbsp;
      <a href="#M000538">new</a>&nbsp;&nbsp;
      <a href="#M000559">pdf_report</a>&nbsp;&nbsp;
      <a href="#M000571">product_type</a>&nbsp;&nbsp;
      <a href="#M000600">rank_history</a>&nbsp;&nbsp;
      <a href="#M000601">rank_history_report</a>&nbsp;&nbsp;
      <a href="#M000565">remove_reserve_character</a>&nbsp;&nbsp;
      <a href="#M000534">screen_from_action</a>&nbsp;&nbsp;
      <a href="#M000606">search</a>&nbsp;&nbsp;
      <a href="#M000540">select_alias</a>&nbsp;&nbsp;
      <a href="#M000541">select_criterias</a>&nbsp;&nbsp;
      <a href="#M000542">select_fields</a>&nbsp;&nbsp;
      <a href="#M000550">select_filters</a>&nbsp;&nbsp;
      <a href="#M000547">set_criterias</a>&nbsp;&nbsp;
      <a href="#M000548">set_fields</a>&nbsp;&nbsp;
      <a href="#M000563">set_max_col</a>&nbsp;&nbsp;
      <a href="#M000546">set_reference_screen_alias</a>&nbsp;&nbsp;
      <a href="#M000536">show</a>&nbsp;&nbsp;
      <a href="#M000533">store_session_report_results</a>&nbsp;&nbsp;
      <a href="#M000544">update</a>&nbsp;&nbsp;
      <a href="#M000554">update_filter</a>&nbsp;&nbsp;
      <a href="#M000552">update_format</a>&nbsp;&nbsp;
      <a href="#M000562">xls</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->
    <div id="includes">
      <h3 class="section-bar">Included Modules</h3>

      <div id="includes-list">
        <span class="include-name"><a href="SendDocHelper.html">SendDocHelper</a></span>
      </div>
    </div>

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000532" class="method-detail">
        <a name="M000532"></a>

        <div class="method-heading">
          <a href="#M000532" class="method-signature">
          <span class="method-name">get_session_report_results</span><span class="method-args">(session_id, report_timestamp)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000532-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000532-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 10</span>
10:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_session_report_results</span>(<span class="ruby-identifier">session_id</span>, <span class="ruby-identifier">report_timestamp</span>)
11:       <span class="ruby-identifier">vm</span> = <span class="ruby-constant">VirtualMemory</span><span class="ruby-operator">::</span><span class="ruby-identifier">load</span>(<span class="ruby-identifier">:session</span>, <span class="ruby-identifier">session_id</span>)
12: 
13:       <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_results</span>] <span class="ruby-operator">||=</span> {}
14:       <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_results</span>][<span class="ruby-identifier">report_timestamp</span>] <span class="ruby-operator">||</span> {}
15:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000533" class="method-detail">
        <a name="M000533"></a>

        <div class="method-heading">
          <a href="#M000533" class="method-signature">
          <span class="method-name">store_session_report_results</span><span class="method-args">(session_id, report_timestamp, report_results)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000533-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000533-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 17</span>
17:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">store_session_report_results</span>(<span class="ruby-identifier">session_id</span>, <span class="ruby-identifier">report_timestamp</span>, <span class="ruby-identifier">report_results</span>)
18:       <span class="ruby-identifier">vm</span> = <span class="ruby-constant">VirtualMemory</span><span class="ruby-operator">::</span><span class="ruby-identifier">load</span>(<span class="ruby-identifier">:session</span>, <span class="ruby-identifier">session_id</span>)
19: 
20:       <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_results</span>] <span class="ruby-operator">||=</span> {}
21:       <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_results</span>][<span class="ruby-identifier">report_timestamp</span>] = <span class="ruby-identifier">report_results</span>
22: 
23:       <span class="ruby-constant">VirtualMemory</span><span class="ruby-operator">::</span><span class="ruby-identifier">store</span>(<span class="ruby-identifier">:session</span>, <span class="ruby-identifier">session_id</span>, <span class="ruby-identifier">vm</span>)
24:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000586" class="method-detail">
        <a name="M000586"></a>

        <div class="method-heading">
          <a href="#M000586" class="method-signature">
          <span class="method-name">action_daily</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>Action Daily <a href="Report.html">Report</a> with Export ======</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000586-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000586-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1732</span>
1732:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">action_daily</span>
1733:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1734:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1735: 
1736:     
1737:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000595" class="method-detail">
        <a name="M000595"></a>

        <div class="method-heading">
          <a href="#M000595" class="method-signature">
          <span class="method-name">action_daily_rank_1</span><span class="method-args">(date_from, date_to)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000595-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000595-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 3298</span>
3298:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">action_daily_rank_1</span>(<span class="ruby-identifier">date_from</span>, <span class="ruby-identifier">date_to</span>)
3299:     <span class="ruby-comment cmt">#Potential Rank -&gt; Customer -&gt; Product Type</span>
3300:     <span class="ruby-ivar">@date_from</span> = <span class="ruby-identifier">date_from</span>
3301:     <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">date_to</span>
3302:     <span class="ruby-identifier">screen_all</span> = <span class="ruby-identifier">get_all_screen</span>
3303:     <span class="ruby-identifier">cf_all</span> = <span class="ruby-identifier">get_all_customfield</span>
3304: 
3305:     <span class="ruby-comment cmt">#Potential Rank</span>
3306:     <span class="ruby-identifier">rank_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'potential rank'</span>]
3307: 
3308:     <span class="ruby-comment cmt">#Action</span>
3309:     <span class="ruby-identifier">action_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'action_revision'</span>]
3310: 
3311:     <span class="ruby-comment cmt">#Task</span>
3312:     <span class="ruby-identifier">task_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'task_detail'</span>]
3313: 
3314:     <span class="ruby-comment cmt">#Business Record</span>
3315:     <span class="ruby-identifier">business_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'business record'</span>]
3316: 
3317:     <span class="ruby-comment cmt">#Product Type</span>
3318:     <span class="ruby-identifier">product_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'product_type'</span>]
3319: 
3320:     <span class="ruby-comment cmt">#Customer</span>
3321:     <span class="ruby-identifier">customer_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'customer'</span>]
3322: 
3323:     <span class="ruby-identifier">cf_product_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'production_type_ref'</span>]
3324:     <span class="ruby-identifier">cf_customer</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'customer_ref'</span>]
3325:     <span class="ruby-identifier">cf_issue_tracking</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'issue tracking'</span>]
3326:     <span class="ruby-identifier">cf_action_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'action type'</span>]
3327:     <span class="ruby-identifier">cf_visit_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'visit purpose'</span>]
3328:     <span class="ruby-identifier">cf_task_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'task purpose'</span>]
3329:     <span class="ruby-identifier">cf_salesman</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'salesman_ref'</span>]
3330:     <span class="ruby-identifier">cf_quotation_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation date'</span>]
3331:     <span class="ruby-identifier">cf_po_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po date'</span>]
3332:     <span class="ruby-identifier">cf_invoice_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice date'</span>]
3333:     <span class="ruby-identifier">cf_delivery_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery date'</span>]
3334:     <span class="ruby-identifier">cf_payment_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment date'</span>]
3335:     <span class="ruby-identifier">cf_quotation_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation amount'</span>]
3336:     <span class="ruby-identifier">cf_po_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po amount'</span>]
3337:     <span class="ruby-identifier">cf_invoice_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice amount'</span>]
3338:     <span class="ruby-identifier">cf_delivery_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery amount'</span>]
3339:     <span class="ruby-identifier">cf_payment_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment amount'</span>]
3340:     <span class="ruby-identifier">cf_rank</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'potential_rank_ref'</span>]
3341: 
3342:     <span class="ruby-identifier">action_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>]
3343:     <span class="ruby-identifier">task_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>]
3344:     <span class="ruby-identifier">business_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
3345: 
3346:     <span class="ruby-ivar">@result</span> = {} <span class="ruby-comment cmt">#Keep amount of all activity</span>
3347:     <span class="ruby-ivar">@total</span> = {} <span class="ruby-comment cmt">#Keep total amount of all activity</span>
3348:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3349:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3350:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3351: 
3352:     <span class="ruby-identifier">all_ref</span> = <span class="ruby-identifier">gen_ref_values</span>([<span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>], [])
3353:     <span class="ruby-identifier">custrank_ref</span> = <span class="ruby-identifier">gen_ref_values</span>(<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_rank</span>.<span class="ruby-identifier">id</span>)
3354: 
3355:     <span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
3356:       <span class="ruby-identifier">rank_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>]
3357:       <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
3358:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
3359:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3360:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3361:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3362:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Potential Rank</span>
3363: 
3364:     <span class="ruby-comment cmt"># ------ Action ------</span>
3365:     <span class="ruby-identifier">action_rows</span> = <span class="ruby-identifier">get_action_rows</span>(<span class="ruby-identifier">action_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)[<span class="ruby-value">0</span>]
3366: 
3367:     <span class="ruby-identifier">a_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">action_rows</span>, <span class="ruby-identifier">action_field_ids</span>)
3368: 
3369:     <span class="ruby-identifier">action_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fa</span><span class="ruby-operator">|</span>
3370:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3371:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3372: 
3373:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
3374: 
3375:       <span class="ruby-identifier">action_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>])
3376:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
3377:       <span class="ruby-identifier">customer_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">customer_id</span>]
3378: 
3379:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3380:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
3381:       <span class="ruby-keyword kw">else</span>
3382:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">action_type_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
3383:       <span class="ruby-keyword kw">end</span>
3384: 
3385:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Visit&quot;</span>
3386:         <span class="ruby-identifier">visit_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>])
3387:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">visit_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3388:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Routine&quot;</span>
3389:         <span class="ruby-keyword kw">else</span>
3390:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">visit_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
3391:         <span class="ruby-keyword kw">end</span>
3392:       <span class="ruby-keyword kw">end</span>
3393: 
3394:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>].<span class="ruby-identifier">nil?</span>
3395:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
3396:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
3397:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3398:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3399:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3400:       <span class="ruby-keyword kw">end</span>
3401:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>].<span class="ruby-identifier">nil?</span>
3402:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
3403:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
3404:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3405:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3406:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3407:       <span class="ruby-keyword kw">end</span>
3408:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>].<span class="ruby-identifier">nil?</span>
3409:         <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
3410:           <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
3411:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
3412:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3413:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3414:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3415:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
3416:       <span class="ruby-keyword kw">end</span>
3417: 
3418:       <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>,<span class="ruby-identifier">ptype</span>], <span class="ruby-identifier">:action</span>, <span class="ruby-identifier">action_type_name</span>)
3419: 
3420:       <span class="ruby-comment cmt"># ------ Task ------</span>
3421:       <span class="ruby-identifier">task_rows</span> = <span class="ruby-identifier">fa</span>.<span class="ruby-identifier">detail_rows</span>
3422: 
3423:       <span class="ruby-identifier">t_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">task_rows</span>, <span class="ruby-identifier">task_field_ids</span>)
3424:       <span class="ruby-identifier">task_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ft</span><span class="ruby-operator">|</span>
3425:         <span class="ruby-identifier">task_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">RadioButton</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">t_rows</span>[<span class="ruby-identifier">ft</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>])
3426: 
3427:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3428:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
3429:         <span class="ruby-keyword kw">else</span>
3430:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">task_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
3431:         <span class="ruby-keyword kw">end</span>
3432: 
3433:         <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>,<span class="ruby-identifier">ptype</span>], <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">action_type_name</span>)
3434:       <span class="ruby-keyword kw">end</span>
3435:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of @action_screen.rows.each</span>
3436:     <span class="ruby-comment cmt"># ------ Business Record ------</span>
3437:     <span class="ruby-identifier">row_ids</span> = []
3438:     <span class="ruby-identifier">sql_head</span> = <span class="ruby-value str">&quot;SELECT rows.* FROM rows INNER JOIN CELLS on rows.id = cells.row_id WHERE (rows.screen_id = &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; AND (cells.field_id = &quot;</span>
3439:     <span class="ruby-identifier">sql_last</span> = <span class="ruby-value str">&quot; and cells.value between '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_from</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;' and '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_to</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;'))&quot;</span>
3440:     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3441:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3442:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3443:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3444:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3445: 
3446:     <span class="ruby-identifier">business_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-identifier">sql</span>)
3447:     <span class="ruby-identifier">brows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">business_rows</span>, <span class="ruby-identifier">business_field_ids</span>)
3448:     <span class="ruby-identifier">business_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fb</span><span class="ruby-operator">|</span>
3449:       <span class="ruby-identifier">issue</span> = <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>]
3450: 
3451:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3452:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3453: 
3454:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
3455: 
3456:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
3457:       <span class="ruby-identifier">customer_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">customer_id</span>]
3458: 
3459:       <span class="ruby-identifier">br_date</span> = []
3460:       <span class="ruby-identifier">br_amount</span> = []
3461:       <span class="ruby-identifier">br_name</span> = [<span class="ruby-value str">&quot;Quotation&quot;</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-value str">&quot;Invoice&quot;</span>,<span class="ruby-value str">&quot;Payment&quot;</span>]
3462:       <span class="ruby-identifier">br_count</span> = [<span class="ruby-value str">&quot;Quotation_count&quot;</span>,<span class="ruby-value str">&quot;P/O_count&quot;</span>,<span class="ruby-value str">&quot;Delivery_count&quot;</span>,<span class="ruby-value str">&quot;Invoice_count&quot;</span>,<span class="ruby-value str">&quot;Payment_count&quot;</span>]
3463: 
3464:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>]
3465:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>]
3466:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>]
3467:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>]
3468:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>]
3469: 
3470:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>]
3471:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>]
3472:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>]
3473:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>]
3474:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
3475: 
3476:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>].<span class="ruby-identifier">nil?</span>
3477:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
3478:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
3479:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3480:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3481:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3482:       <span class="ruby-keyword kw">end</span>
3483:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>].<span class="ruby-identifier">nil?</span>
3484:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
3485:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
3486:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3487:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3488:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3489:       <span class="ruby-keyword kw">end</span>
3490:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>].<span class="ruby-identifier">nil?</span>
3491:         <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
3492:           <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
3493:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
3494:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3495:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3496:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3497:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
3498:       <span class="ruby-keyword kw">end</span>
3499: 
3500:       <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
3501:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">br_name</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
3502:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Quotation&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">issue_state</span>(<span class="ruby-identifier">issue</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">:cancelled</span>)
3503:         <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@date_from</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@date_to</span>))
3504:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>,<span class="ruby-identifier">ptype</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>], <span class="ruby-identifier">br_amount</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">to_f</span>, <span class="ruby-value">0</span><span class="ruby-value">.0</span>)
3505:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>,<span class="ruby-identifier">ptype</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_count</span>[<span class="ruby-identifier">i</span>])
3506:         <span class="ruby-keyword kw">end</span>
3507:       <span class="ruby-keyword kw">end</span>
3508:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of business record</span>
3509:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>
3510:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000596" class="method-detail">
        <a name="M000596"></a>

        <div class="method-heading">
          <a href="#M000596" class="method-signature">
          <span class="method-name">action_daily_rank_2</span><span class="method-args">(date_from, date_to)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000596-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000596-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 3512</span>
3512:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">action_daily_rank_2</span>(<span class="ruby-identifier">date_from</span>, <span class="ruby-identifier">date_to</span>)
3513:     <span class="ruby-comment cmt">#Potential Rank -&gt; Product Type -&gt; Customer</span>
3514:     <span class="ruby-ivar">@date_from</span> = <span class="ruby-identifier">date_from</span>
3515:     <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">date_to</span>
3516:     <span class="ruby-identifier">screen_all</span> = <span class="ruby-identifier">get_all_screen</span>
3517:     <span class="ruby-identifier">cf_all</span> = <span class="ruby-identifier">get_all_customfield</span>
3518:     <span class="ruby-comment cmt">#Potential Rank</span>
3519:     <span class="ruby-identifier">rank_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'potential rank'</span>]
3520: 
3521:     <span class="ruby-comment cmt">#Action</span>
3522:     <span class="ruby-identifier">action_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'action_revision'</span>]
3523: 
3524:     <span class="ruby-comment cmt">#Task</span>
3525:     <span class="ruby-identifier">task_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'task_detail'</span>]
3526: 
3527:     <span class="ruby-comment cmt">#Business Record</span>
3528:     <span class="ruby-identifier">business_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'business record'</span>]
3529: 
3530:     <span class="ruby-comment cmt">#Product Type</span>
3531:     <span class="ruby-identifier">product_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'product_type'</span>]
3532: 
3533:     <span class="ruby-comment cmt">#Customer</span>
3534:     <span class="ruby-identifier">customer_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'customer'</span>]
3535: 
3536:     <span class="ruby-identifier">cf_product_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'production_type_ref'</span>]
3537:     <span class="ruby-identifier">cf_customer</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'customer_ref'</span>]
3538:     <span class="ruby-identifier">cf_issue_tracking</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'issue tracking'</span>]
3539:     <span class="ruby-identifier">cf_action_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'action type'</span>]
3540:     <span class="ruby-identifier">cf_visit_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'visit purpose'</span>]
3541:     <span class="ruby-identifier">cf_task_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'task purpose'</span>]
3542:     <span class="ruby-identifier">cf_salesman</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'salesman_ref'</span>]
3543:     <span class="ruby-identifier">cf_quotation_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation date'</span>]
3544:     <span class="ruby-identifier">cf_po_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po date'</span>]
3545:     <span class="ruby-identifier">cf_invoice_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice date'</span>]
3546:     <span class="ruby-identifier">cf_delivery_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery date'</span>]
3547:     <span class="ruby-identifier">cf_payment_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment date'</span>]
3548:     <span class="ruby-identifier">cf_quotation_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation amount'</span>]
3549:     <span class="ruby-identifier">cf_po_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po amount'</span>]
3550:     <span class="ruby-identifier">cf_invoice_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice amount'</span>]
3551:     <span class="ruby-identifier">cf_delivery_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery amount'</span>]
3552:     <span class="ruby-identifier">cf_payment_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment amount'</span>]
3553:     <span class="ruby-identifier">cf_rank</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'potential_rank_ref'</span>]
3554: 
3555:     <span class="ruby-identifier">action_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>]
3556:     <span class="ruby-identifier">task_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>]
3557:     <span class="ruby-identifier">business_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
3558: 
3559:     <span class="ruby-ivar">@result</span> = {} <span class="ruby-comment cmt">#Keep amount of all activity</span>
3560:     <span class="ruby-ivar">@total</span> = {} <span class="ruby-comment cmt">#Keep total amount of all activity</span>
3561:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3562:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3563:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3564: 
3565:     <span class="ruby-identifier">all_ref</span> = <span class="ruby-identifier">gen_ref_values</span>([<span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>], [])
3566:     <span class="ruby-identifier">custrank_ref</span> = <span class="ruby-identifier">gen_ref_values</span>(<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_rank</span>.<span class="ruby-identifier">id</span>)
3567: 
3568:     <span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
3569:       <span class="ruby-identifier">rank_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>]
3570:       <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
3571:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
3572:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3573:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3574:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3575: 
3576:       <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
3577:         <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
3578:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
3579:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
3580:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3581:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3582:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3583:       <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
3584:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Potential Rank</span>
3585: 
3586:     <span class="ruby-comment cmt"># ------ Action ------</span>
3587:     <span class="ruby-identifier">action_rows</span> = <span class="ruby-identifier">get_action_rows</span>(<span class="ruby-identifier">action_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)[<span class="ruby-value">0</span>]
3588: 
3589:     <span class="ruby-identifier">a_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">action_rows</span>, <span class="ruby-identifier">action_field_ids</span>)
3590: 
3591:     <span class="ruby-identifier">action_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fa</span><span class="ruby-operator">|</span>
3592:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3593:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3594: 
3595:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
3596: 
3597:       <span class="ruby-identifier">action_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>])
3598:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
3599:       <span class="ruby-identifier">customer_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">customer_id</span>]
3600: 
3601:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3602:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
3603:       <span class="ruby-keyword kw">else</span>
3604:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">action_type_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
3605:       <span class="ruby-keyword kw">end</span>
3606: 
3607:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Visit&quot;</span>
3608:         <span class="ruby-identifier">visit_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>])
3609:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">visit_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3610:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Routine&quot;</span>
3611:         <span class="ruby-keyword kw">else</span>
3612:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">visit_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
3613:         <span class="ruby-keyword kw">end</span>
3614:       <span class="ruby-keyword kw">end</span>
3615: 
3616:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>].<span class="ruby-identifier">nil?</span>
3617:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
3618:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
3619:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3620:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3621:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3622: 
3623:         <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
3624:           <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
3625:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
3626:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
3627:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3628:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3629:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3630:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
3631:       <span class="ruby-keyword kw">end</span>
3632: 
3633:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>].<span class="ruby-identifier">nil?</span>
3634:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
3635:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3636:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3637:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3638:       <span class="ruby-keyword kw">end</span>
3639: 
3640:       <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:action</span>, <span class="ruby-identifier">action_type_name</span>)
3641: 
3642:       <span class="ruby-comment cmt"># ------ Task ------</span>
3643:       <span class="ruby-identifier">task_rows</span> = <span class="ruby-identifier">fa</span>.<span class="ruby-identifier">detail_rows</span>
3644: 
3645:       <span class="ruby-identifier">t_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">task_rows</span>, <span class="ruby-identifier">task_field_ids</span>)
3646:       <span class="ruby-identifier">task_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ft</span><span class="ruby-operator">|</span>
3647:         <span class="ruby-identifier">task_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">RadioButton</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">t_rows</span>[<span class="ruby-identifier">ft</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>])
3648: 
3649:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3650:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
3651:         <span class="ruby-keyword kw">else</span>
3652:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">task_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
3653:         <span class="ruby-keyword kw">end</span>
3654: 
3655:         <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">action_type_name</span>)
3656:       <span class="ruby-keyword kw">end</span>
3657:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of @action_screen.rows.each</span>
3658:     <span class="ruby-comment cmt"># ------ Business Record ------</span>
3659:     <span class="ruby-identifier">row_ids</span> = []
3660:     <span class="ruby-identifier">sql_head</span> = <span class="ruby-value str">&quot;SELECT rows.* FROM rows INNER JOIN CELLS on rows.id = cells.row_id WHERE (rows.screen_id = &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; AND (cells.field_id = &quot;</span>
3661:     <span class="ruby-identifier">sql_last</span> = <span class="ruby-value str">&quot; and cells.value between '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_from</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;' and '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_to</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;'))&quot;</span>
3662:     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3663:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3664:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3665:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3666:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3667: 
3668:     <span class="ruby-identifier">business_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-identifier">sql</span>)
3669:     <span class="ruby-identifier">brows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">business_rows</span>, <span class="ruby-identifier">business_field_ids</span>)
3670:     <span class="ruby-identifier">business_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fb</span><span class="ruby-operator">|</span>
3671:       <span class="ruby-identifier">issue</span> = <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>]
3672: 
3673:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3674:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3675: 
3676:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
3677: 
3678:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
3679:       <span class="ruby-identifier">customer_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">customer_id</span>]
3680: 
3681:       <span class="ruby-identifier">br_date</span> = []
3682:       <span class="ruby-identifier">br_amount</span> = []
3683:       <span class="ruby-identifier">br_name</span> = [<span class="ruby-value str">&quot;Quotation&quot;</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-value str">&quot;Invoice&quot;</span>,<span class="ruby-value str">&quot;Payment&quot;</span>]
3684:       <span class="ruby-identifier">br_count</span> = [<span class="ruby-value str">&quot;Quotation_count&quot;</span>,<span class="ruby-value str">&quot;P/O_count&quot;</span>,<span class="ruby-value str">&quot;Delivery_count&quot;</span>,<span class="ruby-value str">&quot;Invoice_count&quot;</span>,<span class="ruby-value str">&quot;Payment_count&quot;</span>]
3685: 
3686:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>]
3687:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>]
3688:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>]
3689:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>]
3690:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>]
3691: 
3692:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>]
3693:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>]
3694:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>]
3695:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>]
3696:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
3697: 
3698:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>].<span class="ruby-identifier">nil?</span>
3699:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
3700:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
3701:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3702:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3703:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3704: 
3705:         <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
3706:           <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
3707:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
3708:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
3709:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3710:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3711:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3712:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
3713:       <span class="ruby-keyword kw">end</span>
3714: 
3715:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>].<span class="ruby-identifier">nil?</span>
3716:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
3717:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3718:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3719:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3720:       <span class="ruby-keyword kw">end</span>
3721: 
3722:       <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
3723:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">br_name</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
3724:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Quotation&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">issue_state</span>(<span class="ruby-identifier">issue</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">:cancelled</span>)
3725:         <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@date_from</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@date_to</span>))
3726:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>], <span class="ruby-identifier">br_amount</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">to_f</span>, <span class="ruby-value">0</span><span class="ruby-value">.0</span>)
3727:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_count</span>[<span class="ruby-identifier">i</span>])
3728:         <span class="ruby-keyword kw">end</span>
3729:       <span class="ruby-keyword kw">end</span>
3730:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of business record</span>
3731:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>
3732:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000587" class="method-detail">
        <a name="M000587"></a>

        <div class="method-heading">
          <a href="#M000587" class="method-signature">
          <span class="method-name">action_daily_report</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000587-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000587-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1739</span>
1739:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">action_daily_report</span>
1740:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1741:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1742: 
1743:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'export'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;yes&quot;</span>
1744:       <span class="ruby-ivar">@date_from</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_from</span>]
1745:       <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_to</span>]
1746:       <span class="ruby-ivar">@screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-value str">&quot;Action Report&quot;</span> ])
1747:       <span class="ruby-ivar">@rpt</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:rpt</span>].<span class="ruby-identifier">to_i</span>
1748:       <span class="ruby-ivar">@rpt_type</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:rpt_type</span>].<span class="ruby-identifier">to_i</span>
1749:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@rpt</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">2</span> <span class="ruby-comment cmt">#type 1</span>
1750:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
1751:           <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">action_daily_type1_1</span>(<span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)
1752:           <span class="ruby-ivar">@header</span> = [<span class="ruby-value str">&quot;Product Type&quot;</span>]
1753:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
1754:           <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">action_daily_type1_2</span>(<span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)
1755:           <span class="ruby-ivar">@header</span> = [<span class="ruby-value str">&quot;Product Type&quot;</span>,<span class="ruby-value str">&quot;Sales Office&quot;</span>]
1756:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>
1757:           <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">action_daily_type1_3</span>(<span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)
1758:           <span class="ruby-ivar">@header</span> = [<span class="ruby-value str">&quot;Product Type&quot;</span>,<span class="ruby-value str">&quot;Sales Office&quot;</span>, <span class="ruby-value str">&quot;Salesman&quot;</span>]
1759:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span>
1760:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@rpt</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
1761:             <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">action_daily_type1_4</span>(<span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)
1762:             <span class="ruby-ivar">@header</span> = [<span class="ruby-value str">&quot;Product Type&quot;</span>,<span class="ruby-value str">&quot;Sales Office&quot;</span>, <span class="ruby-value str">&quot;Salesman&quot;</span>, <span class="ruby-value str">&quot;Potential Rank&quot;</span>]
1763:           <span class="ruby-keyword kw">else</span>
1764:             <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">action_daily_type2_4</span>(<span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)
1765:             <span class="ruby-ivar">@header</span> = [<span class="ruby-value str">&quot;Product Type&quot;</span>,<span class="ruby-value str">&quot;Sales Office&quot;</span>, <span class="ruby-value str">&quot;Salesman&quot;</span>, <span class="ruby-value str">&quot;Type&quot;</span>]
1766:           <span class="ruby-keyword kw">end</span>
1767:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">5</span>
1768:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@rpt</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
1769:             <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">action_daily_type1_5</span>(<span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)
1770:             <span class="ruby-ivar">@header</span> = [<span class="ruby-value str">&quot;Product Type&quot;</span>,<span class="ruby-value str">&quot;Sales Office&quot;</span>, <span class="ruby-value str">&quot;Salesman&quot;</span>, <span class="ruby-value str">&quot;Potential Rank&quot;</span>, <span class="ruby-value str">&quot;Customer&quot;</span>]
1771:           <span class="ruby-keyword kw">else</span>
1772:             <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">action_daily_type2_5</span>(<span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)
1773:             <span class="ruby-ivar">@header</span> = [<span class="ruby-value str">&quot;Product Type&quot;</span>,<span class="ruby-value str">&quot;Sales Office&quot;</span>, <span class="ruby-value str">&quot;Salesman&quot;</span>, <span class="ruby-value str">&quot;Type&quot;</span>, <span class="ruby-value str">&quot;Customer&quot;</span>]
1774:           <span class="ruby-keyword kw">end</span>
1775:         <span class="ruby-keyword kw">end</span>
1776: 
1777:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span> <span class="ruby-comment cmt">#type rank</span>
1778:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
1779:           <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">action_daily_rank_1</span>(<span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)
1780:           <span class="ruby-ivar">@header</span> = [<span class="ruby-value str">&quot;Potential Rank&quot;</span>,<span class="ruby-value str">&quot;Customer&quot;</span>, <span class="ruby-value str">&quot;Product Type&quot;</span>]
1781:         <span class="ruby-keyword kw">else</span>
1782:           <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">action_daily_rank_2</span>(<span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)
1783:           <span class="ruby-ivar">@header</span> = [<span class="ruby-value str">&quot;Potential Rank&quot;</span>, <span class="ruby-value str">&quot;Product Type&quot;</span>,<span class="ruby-value str">&quot;Customer&quot;</span>]
1784:         <span class="ruby-keyword kw">end</span>
1785: 
1786:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span> <span class="ruby-comment cmt">#Province</span>
1787:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
1788:           <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">action_daily_rpt_1</span>(<span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>,<span class="ruby-value str">&quot;Province_REF&quot;</span>)
1789:           <span class="ruby-ivar">@header</span> = [<span class="ruby-value str">&quot;Province&quot;</span>,<span class="ruby-value str">&quot;Potential Rank&quot;</span>,<span class="ruby-value str">&quot;Customer&quot;</span>,<span class="ruby-value str">&quot;Product Type&quot;</span>]
1790:         <span class="ruby-keyword kw">else</span>
1791:           <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">action_daily_rpt_2</span>(<span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>,<span class="ruby-value str">&quot;Province_REF&quot;</span>)
1792:           <span class="ruby-ivar">@header</span> = [<span class="ruby-value str">&quot;Province&quot;</span>,<span class="ruby-value str">&quot;Potential Rank&quot;</span>,<span class="ruby-value str">&quot;Product Type&quot;</span>,<span class="ruby-value str">&quot;Customer&quot;</span>]
1793:         <span class="ruby-keyword kw">end</span>
1794: 
1795:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt</span> <span class="ruby-operator">==</span> <span class="ruby-value">5</span> <span class="ruby-comment cmt">#Estate</span>
1796:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
1797:           <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">action_daily_rpt_1</span>(<span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>,<span class="ruby-value str">&quot;Estate_REF&quot;</span>)
1798:           <span class="ruby-ivar">@header</span> = [<span class="ruby-value str">&quot;Industrial Estate&quot;</span>,<span class="ruby-value str">&quot;Potential Rank&quot;</span>,<span class="ruby-value str">&quot;Customer&quot;</span>,<span class="ruby-value str">&quot;Product Type&quot;</span>]
1799:         <span class="ruby-keyword kw">else</span>
1800:           <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">action_daily_rpt_2</span>(<span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>,<span class="ruby-value str">&quot;Estate_REF&quot;</span>)
1801:           <span class="ruby-ivar">@header</span> = [<span class="ruby-value str">&quot;Industrial Estate&quot;</span>,<span class="ruby-value str">&quot;Potential Rank&quot;</span>, <span class="ruby-value str">&quot;Product Type&quot;</span>,<span class="ruby-value str">&quot;Customer&quot;</span>]
1802:         <span class="ruby-keyword kw">end</span>
1803:       <span class="ruby-keyword kw">end</span>
1804:     
1805:       <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">store_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>,
1806:         {
1807:           <span class="ruby-identifier">:result</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@result</span>,
1808:           <span class="ruby-identifier">:total</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@total</span>,
1809:           <span class="ruby-identifier">:date_from</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@date_from</span>,
1810:           <span class="ruby-identifier">:date_to</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@date_to</span>,
1811:           <span class="ruby-identifier">:header</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@header</span>
1812:         })
1813:     <span class="ruby-keyword kw">else</span>
1814:       <span class="ruby-identifier">vm</span> = <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">get_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>)
1815:       <span class="ruby-ivar">@result</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:result</span>]
1816:       <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:total</span>]
1817:       <span class="ruby-ivar">@date_from</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:date_from</span>]
1818:       <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:date_to</span>]
1819:       <span class="ruby-ivar">@header</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:header</span>]
1820: 
1821:       <span class="ruby-identifier">export_action_daily</span>(<span class="ruby-ivar">@result</span>,<span class="ruby-ivar">@total</span>,<span class="ruby-ivar">@date_from</span>,<span class="ruby-ivar">@date_to</span>,<span class="ruby-ivar">@header</span>)
1822:     <span class="ruby-keyword kw">end</span>
1823:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000597" class="method-detail">
        <a name="M000597"></a>

        <div class="method-heading">
          <a href="#M000597" class="method-signature">
          <span class="method-name">action_daily_rpt_1</span><span class="method-args">(date_from, date_to, rpt_ref)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000597-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000597-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 3734</span>
3734:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">action_daily_rpt_1</span>(<span class="ruby-identifier">date_from</span>, <span class="ruby-identifier">date_to</span>, <span class="ruby-identifier">rpt_ref</span>)
3735:     <span class="ruby-comment cmt">#Province -&gt; Potential Rank -&gt; Customer -&gt; Product Type</span>
3736:     <span class="ruby-ivar">@date_from</span> = <span class="ruby-identifier">date_from</span>
3737:     <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">date_to</span>
3738:     <span class="ruby-identifier">screen_all</span> = <span class="ruby-identifier">get_all_screen</span>
3739:     <span class="ruby-identifier">cf_all</span> = <span class="ruby-identifier">get_all_customfield</span>
3740:     <span class="ruby-comment cmt">#Potential Rank</span>
3741:     <span class="ruby-identifier">rank_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'potential rank'</span>]
3742: 
3743:     <span class="ruby-comment cmt">#Action</span>
3744:     <span class="ruby-identifier">action_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'action_revision'</span>]
3745: 
3746:     <span class="ruby-comment cmt">#Task</span>
3747:     <span class="ruby-identifier">task_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'task_detail'</span>]
3748: 
3749:     <span class="ruby-comment cmt">#Business Record</span>
3750:     <span class="ruby-identifier">business_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'business record'</span>]
3751: 
3752:     <span class="ruby-comment cmt">#Product Type</span>
3753:     <span class="ruby-identifier">product_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'product_type'</span>]
3754: 
3755:     <span class="ruby-comment cmt">#Customer</span>
3756:     <span class="ruby-identifier">customer_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'customer'</span>]
3757: 
3758:     <span class="ruby-comment cmt">#item ==&gt; Estate_REF and Province REF</span>
3759:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">rpt_ref</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Estate_REF&quot;</span>
3760:       <span class="ruby-identifier">item_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'industrial estate'</span>]
3761:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">rpt_ref</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Province_REF&quot;</span>
3762:       <span class="ruby-identifier">item_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'province'</span>]
3763:     <span class="ruby-keyword kw">end</span>
3764: 
3765:     <span class="ruby-identifier">cf_product_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'production_type_ref'</span>]
3766:     <span class="ruby-identifier">cf_customer</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'customer_ref'</span>]
3767:     <span class="ruby-identifier">cf_issue_tracking</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'issue tracking'</span>]
3768:     <span class="ruby-identifier">cf_action_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'action type'</span>]
3769:     <span class="ruby-identifier">cf_visit_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'visit purpose'</span>]
3770:     <span class="ruby-identifier">cf_task_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'task purpose'</span>]
3771:     <span class="ruby-identifier">cf_salesman</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'salesman_ref'</span>]
3772:     <span class="ruby-identifier">cf_quotation_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation date'</span>]
3773:     <span class="ruby-identifier">cf_po_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po date'</span>]
3774:     <span class="ruby-identifier">cf_invoice_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice date'</span>]
3775:     <span class="ruby-identifier">cf_delivery_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery date'</span>]
3776:     <span class="ruby-identifier">cf_payment_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment date'</span>]
3777:     <span class="ruby-identifier">cf_quotation_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation amount'</span>]
3778:     <span class="ruby-identifier">cf_po_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po amount'</span>]
3779:     <span class="ruby-identifier">cf_invoice_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice amount'</span>]
3780:     <span class="ruby-identifier">cf_delivery_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery amount'</span>]
3781:     <span class="ruby-identifier">cf_payment_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment amount'</span>]
3782:     <span class="ruby-identifier">cf_rank</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'potential_rank_ref'</span>]
3783:     <span class="ruby-identifier">rpt_custom_field_id</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-identifier">rpt_ref</span>.<span class="ruby-identifier">downcase</span>].<span class="ruby-identifier">id</span>
3784: 
3785:     <span class="ruby-identifier">action_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>]
3786:     <span class="ruby-identifier">task_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>]
3787:     <span class="ruby-identifier">business_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
3788: 
3789:     <span class="ruby-ivar">@result</span> = {} <span class="ruby-comment cmt">#Keep amount of all activity</span>
3790:     <span class="ruby-ivar">@total</span> = {} <span class="ruby-comment cmt">#Keep total amount of all activity</span>
3791:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3792:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3793:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3794: 
3795:     <span class="ruby-identifier">all_ref</span> = <span class="ruby-identifier">gen_ref_values</span>([<span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">item_screen</span>.<span class="ruby-identifier">id</span>], [])
3796:     <span class="ruby-identifier">custrank_ref</span> = <span class="ruby-identifier">gen_ref_values</span>(<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_rank</span>.<span class="ruby-identifier">id</span>)
3797:     <span class="ruby-identifier">rptitem_ref</span> = <span class="ruby-identifier">gen_ref_values</span>(<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">rpt_custom_field_id</span>)
3798: 
3799:     <span class="ruby-comment cmt"># ------ Action ------</span>
3800:     <span class="ruby-identifier">action_rows</span> = <span class="ruby-identifier">get_action_rows</span>(<span class="ruby-identifier">action_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)[<span class="ruby-value">0</span>]
3801: 
3802:     <span class="ruby-identifier">a_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">action_rows</span>, <span class="ruby-identifier">action_field_ids</span>)
3803: 
3804:     <span class="ruby-identifier">action_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fa</span><span class="ruby-operator">|</span>
3805:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3806:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3807: 
3808:       <span class="ruby-identifier">item</span> = <span class="ruby-identifier">rptitem_ref</span>[<span class="ruby-identifier">customer_id</span>]
3809: 
3810:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
3811: 
3812:       <span class="ruby-identifier">action_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>])
3813:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
3814:       <span class="ruby-identifier">customer_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">customer_id</span>]
3815: 
3816:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3817:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
3818:       <span class="ruby-keyword kw">else</span>
3819:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">action_type_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
3820:       <span class="ruby-keyword kw">end</span>
3821: 
3822:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Visit&quot;</span>
3823:         <span class="ruby-identifier">visit_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>])
3824:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">visit_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3825:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Routine&quot;</span>
3826:         <span class="ruby-keyword kw">else</span>
3827:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">visit_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
3828:         <span class="ruby-keyword kw">end</span>
3829:       <span class="ruby-keyword kw">end</span>
3830: 
3831:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>].<span class="ruby-identifier">nil?</span>
3832:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>] <span class="ruby-operator">||=</span>{}
3833:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>] <span class="ruby-operator">||=</span>{}
3834:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3835:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3836:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3837: 
3838:         <span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
3839:           <span class="ruby-identifier">rank_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>]
3840:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
3841:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
3842:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3843:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3844:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3845:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Potential Rank</span>
3846:       <span class="ruby-keyword kw">end</span>
3847: 
3848:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>].<span class="ruby-identifier">nil?</span>
3849:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
3850:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
3851:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3852:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3853:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3854:       <span class="ruby-keyword kw">end</span>
3855:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>].<span class="ruby-identifier">nil?</span>
3856:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
3857:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
3858:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3859:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3860:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3861:       <span class="ruby-keyword kw">end</span>
3862:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>].<span class="ruby-identifier">nil?</span>
3863:         <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
3864:           <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
3865:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
3866:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3867:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3868:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3869:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
3870:       <span class="ruby-keyword kw">end</span>
3871: 
3872:       <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">item</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>,<span class="ruby-identifier">ptype</span>], <span class="ruby-identifier">:action</span>, <span class="ruby-identifier">action_type_name</span>)
3873: 
3874:       <span class="ruby-comment cmt"># ------ Task ------</span>
3875:       <span class="ruby-identifier">task_rows</span> = <span class="ruby-identifier">fa</span>.<span class="ruby-identifier">detail_rows</span>
3876: 
3877:       <span class="ruby-identifier">t_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">task_rows</span>, <span class="ruby-identifier">task_field_ids</span>)
3878:       <span class="ruby-identifier">task_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ft</span><span class="ruby-operator">|</span>
3879:         <span class="ruby-identifier">task_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">RadioButton</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">t_rows</span>[<span class="ruby-identifier">ft</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>])
3880: 
3881:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3882:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
3883:         <span class="ruby-keyword kw">else</span>
3884:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">task_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
3885:         <span class="ruby-keyword kw">end</span>
3886: 
3887:         <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">item</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>,<span class="ruby-identifier">ptype</span>], <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">action_type_name</span>)
3888:       <span class="ruby-keyword kw">end</span>
3889:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of @action_screen.rows.each</span>
3890:     <span class="ruby-comment cmt"># ------ Business Record ------</span>
3891:     <span class="ruby-identifier">row_ids</span> = []
3892:     <span class="ruby-identifier">sql_head</span> = <span class="ruby-value str">&quot;SELECT rows.* FROM rows INNER JOIN CELLS on rows.id = cells.row_id WHERE (rows.screen_id = &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; AND (cells.field_id = &quot;</span>
3893:     <span class="ruby-identifier">sql_last</span> = <span class="ruby-value str">&quot; and cells.value between '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_from</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;' and '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_to</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;'))&quot;</span>
3894:     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3895:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3896:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3897:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3898:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3899: 
3900:     <span class="ruby-identifier">business_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-identifier">sql</span>)
3901:     <span class="ruby-identifier">brows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">business_rows</span>, <span class="ruby-identifier">business_field_ids</span>)
3902:     <span class="ruby-identifier">business_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fb</span><span class="ruby-operator">|</span>
3903:       <span class="ruby-identifier">issue</span> = <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>]
3904: 
3905:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3906:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3907: 
3908:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
3909: 
3910:       <span class="ruby-identifier">item</span> = <span class="ruby-identifier">rptitem_ref</span>[<span class="ruby-identifier">customer_id</span>]
3911: 
3912:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
3913:       <span class="ruby-identifier">customer_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">customer_id</span>]
3914: 
3915:       <span class="ruby-identifier">br_date</span> = []
3916:       <span class="ruby-identifier">br_amount</span> = []
3917:       <span class="ruby-identifier">br_name</span> = [<span class="ruby-value str">&quot;Quotation&quot;</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-value str">&quot;Invoice&quot;</span>,<span class="ruby-value str">&quot;Payment&quot;</span>]
3918:       <span class="ruby-identifier">br_count</span> = [<span class="ruby-value str">&quot;Quotation_count&quot;</span>,<span class="ruby-value str">&quot;P/O_count&quot;</span>,<span class="ruby-value str">&quot;Delivery_count&quot;</span>,<span class="ruby-value str">&quot;Invoice_count&quot;</span>,<span class="ruby-value str">&quot;Payment_count&quot;</span>]
3919: 
3920:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>]
3921:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>]
3922:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>]
3923:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>]
3924:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>]
3925: 
3926:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>]
3927:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>]
3928:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>]
3929:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>]
3930:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
3931: 
3932:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>].<span class="ruby-identifier">nil?</span>
3933:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>] <span class="ruby-operator">||=</span>{}
3934:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>] <span class="ruby-operator">||=</span>{}
3935:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3936:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3937:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3938: 
3939:         <span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
3940:           <span class="ruby-identifier">rank_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>]
3941:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
3942:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
3943:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3944:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3945:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3946:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Potential Rank</span>
3947:       <span class="ruby-keyword kw">end</span>
3948: 
3949:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>].<span class="ruby-identifier">nil?</span>
3950:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
3951:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
3952:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3953:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3954:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3955:       <span class="ruby-keyword kw">end</span>
3956:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>].<span class="ruby-identifier">nil?</span>
3957:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
3958:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
3959:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3960:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3961:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3962:       <span class="ruby-keyword kw">end</span>
3963:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>].<span class="ruby-identifier">nil?</span>
3964:         <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
3965:           <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
3966:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
3967:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3968:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3969:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3970:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
3971:       <span class="ruby-keyword kw">end</span>
3972: 
3973:       <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
3974:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">br_name</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
3975:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Quotation&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">issue_state</span>(<span class="ruby-identifier">issue</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">:cancelled</span>)
3976:         <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@date_from</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@date_to</span>))
3977:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">item</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>,<span class="ruby-identifier">ptype</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>], <span class="ruby-identifier">br_amount</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">to_f</span>, <span class="ruby-value">0</span><span class="ruby-value">.0</span>)
3978:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">item</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>,<span class="ruby-identifier">ptype</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_count</span>[<span class="ruby-identifier">i</span>])
3979:         <span class="ruby-keyword kw">end</span>
3980:       <span class="ruby-keyword kw">end</span>
3981:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of business record</span>
3982:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>
3983:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000598" class="method-detail">
        <a name="M000598"></a>

        <div class="method-heading">
          <a href="#M000598" class="method-signature">
          <span class="method-name">action_daily_rpt_2</span><span class="method-args">(date_from, date_to, rpt_ref)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000598-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000598-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 3985</span>
3985:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">action_daily_rpt_2</span>(<span class="ruby-identifier">date_from</span>, <span class="ruby-identifier">date_to</span>, <span class="ruby-identifier">rpt_ref</span>)
3986:     <span class="ruby-comment cmt">#Province -&gt; Potential Rank -&gt; Product Type -&gt; Customer</span>
3987:     <span class="ruby-ivar">@date_from</span> = <span class="ruby-identifier">date_from</span>
3988:     <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">date_to</span>
3989:     
3990:     <span class="ruby-identifier">screen_all</span> = <span class="ruby-identifier">get_all_screen</span>
3991:     <span class="ruby-identifier">cf_all</span> = <span class="ruby-identifier">get_all_customfield</span>
3992:     <span class="ruby-comment cmt">#Potential Rank</span>
3993:     <span class="ruby-identifier">rank_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'potential rank'</span>]
3994: 
3995:     <span class="ruby-comment cmt">#Action</span>
3996:     <span class="ruby-identifier">action_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'action_revision'</span>]
3997: 
3998:     <span class="ruby-comment cmt">#Task</span>
3999:     <span class="ruby-identifier">task_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'task_detail'</span>]
4000: 
4001:     <span class="ruby-comment cmt">#Business Record</span>
4002:     <span class="ruby-identifier">business_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'business record'</span>]
4003: 
4004:     <span class="ruby-comment cmt">#Product Type</span>
4005:     <span class="ruby-identifier">product_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'product_type'</span>]
4006: 
4007:     <span class="ruby-comment cmt">#Customer</span>
4008:     <span class="ruby-identifier">customer_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'customer'</span>]
4009:     
4010:     <span class="ruby-comment cmt">#item ==&gt; Estate_REF and Province REF</span>
4011:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">rpt_ref</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Estate_REF&quot;</span>
4012:       <span class="ruby-identifier">item_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'industrial estate'</span>]
4013:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">rpt_ref</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Province_REF&quot;</span>
4014:       <span class="ruby-identifier">item_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'province'</span>]
4015:     <span class="ruby-keyword kw">end</span>
4016:     <span class="ruby-identifier">cf_product_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'production_type_ref'</span>]
4017:     <span class="ruby-identifier">cf_customer</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'customer_ref'</span>]
4018:     <span class="ruby-identifier">cf_issue_tracking</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'issue tracking'</span>]
4019:     <span class="ruby-identifier">cf_action_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'action type'</span>]
4020:     <span class="ruby-identifier">cf_visit_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'visit purpose'</span>]
4021:     <span class="ruby-identifier">cf_task_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'task purpose'</span>]
4022:     <span class="ruby-identifier">cf_salesman</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'salesman_ref'</span>]
4023:     <span class="ruby-identifier">cf_quotation_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation date'</span>]
4024:     <span class="ruby-identifier">cf_po_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po date'</span>]
4025:     <span class="ruby-identifier">cf_invoice_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice date'</span>]
4026:     <span class="ruby-identifier">cf_delivery_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery date'</span>]
4027:     <span class="ruby-identifier">cf_payment_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment date'</span>]
4028:     <span class="ruby-identifier">cf_quotation_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation amount'</span>]
4029:     <span class="ruby-identifier">cf_po_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po amount'</span>]
4030:     <span class="ruby-identifier">cf_invoice_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice amount'</span>]
4031:     <span class="ruby-identifier">cf_delivery_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery amount'</span>]
4032:     <span class="ruby-identifier">cf_payment_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment amount'</span>]
4033:     <span class="ruby-identifier">cf_rank</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'potential_rank_ref'</span>]
4034:     <span class="ruby-identifier">rpt_custom_field_id</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-identifier">rpt_ref</span>.<span class="ruby-identifier">downcase</span>].<span class="ruby-identifier">id</span>
4035: 
4036:     <span class="ruby-identifier">action_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>]
4037:     <span class="ruby-identifier">task_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>]
4038:     <span class="ruby-identifier">business_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
4039: 
4040:     <span class="ruby-ivar">@result</span> = {} <span class="ruby-comment cmt">#Keep amount of all activity</span>
4041:     <span class="ruby-ivar">@total</span> = {} <span class="ruby-comment cmt">#Keep total amount of all activity</span>
4042:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
4043:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
4044:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
4045: 
4046:     <span class="ruby-identifier">all_ref</span> = <span class="ruby-identifier">gen_ref_values</span>([<span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">item_screen</span>.<span class="ruby-identifier">id</span>], [])
4047:     <span class="ruby-identifier">custrank_ref</span> = <span class="ruby-identifier">gen_ref_values</span>(<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_rank</span>.<span class="ruby-identifier">id</span>)
4048:     <span class="ruby-identifier">rptitem_ref</span> = <span class="ruby-identifier">gen_ref_values</span>(<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">rpt_custom_field_id</span>)
4049: 
4050:     <span class="ruby-comment cmt"># ------ Action ------</span>
4051:     <span class="ruby-identifier">action_rows</span> = <span class="ruby-identifier">get_action_rows</span>(<span class="ruby-identifier">action_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)[<span class="ruby-value">0</span>]
4052:     
4053:     <span class="ruby-identifier">a_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">action_rows</span>, <span class="ruby-identifier">action_field_ids</span>)
4054:     
4055:     <span class="ruby-identifier">action_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fa</span><span class="ruby-operator">|</span>
4056:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4057:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4058: 
4059:       <span class="ruby-identifier">item</span> = <span class="ruby-identifier">rptitem_ref</span>[<span class="ruby-identifier">customer_id</span>]
4060: 
4061:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
4062: 
4063:       <span class="ruby-identifier">action_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>])
4064:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
4065:       <span class="ruby-identifier">customer_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">customer_id</span>]
4066: 
4067:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4068:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
4069:       <span class="ruby-keyword kw">else</span>
4070:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">action_type_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
4071:       <span class="ruby-keyword kw">end</span>
4072: 
4073:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Visit&quot;</span>
4074:         <span class="ruby-identifier">visit_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>])
4075:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">visit_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4076:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Routine&quot;</span>
4077:         <span class="ruby-keyword kw">else</span>
4078:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">visit_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
4079:         <span class="ruby-keyword kw">end</span>
4080:       <span class="ruby-keyword kw">end</span>
4081: 
4082:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>].<span class="ruby-identifier">nil?</span>
4083:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>] <span class="ruby-operator">||=</span>{}
4084:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>] <span class="ruby-operator">||=</span>{}
4085:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
4086:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
4087:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
4088: 
4089:         <span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
4090:           <span class="ruby-identifier">rank_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>]
4091:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
4092:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
4093:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
4094:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
4095:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
4096: 
4097:           <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
4098:             <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
4099:             <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
4100:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
4101:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
4102:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
4103:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
4104:           <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
4105:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Potential Rank</span>
4106:       <span class="ruby-keyword kw">end</span>
4107: 
4108:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>].<span class="ruby-identifier">nil?</span>
4109:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
4110:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
4111:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
4112:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
4113:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
4114: 
4115:         <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
4116:           <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
4117:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
4118:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
4119:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
4120:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
4121:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
4122:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
4123:       <span class="ruby-keyword kw">end</span>
4124:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>].<span class="ruby-identifier">nil?</span>
4125:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
4126:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
4127:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
4128:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
4129:       <span class="ruby-keyword kw">end</span>
4130: 
4131:       <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">item</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:action</span>, <span class="ruby-identifier">action_type_name</span>)
4132: 
4133:       <span class="ruby-comment cmt"># ------ Task ------</span>
4134:       <span class="ruby-identifier">task_rows</span> = <span class="ruby-identifier">fa</span>.<span class="ruby-identifier">detail_rows</span>
4135: 
4136:       <span class="ruby-identifier">t_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">task_rows</span>, <span class="ruby-identifier">task_field_ids</span>)
4137:       <span class="ruby-identifier">task_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ft</span><span class="ruby-operator">|</span>
4138:         <span class="ruby-identifier">task_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">RadioButton</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">t_rows</span>[<span class="ruby-identifier">ft</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>])
4139: 
4140:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4141:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
4142:         <span class="ruby-keyword kw">else</span>
4143:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">task_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
4144:         <span class="ruby-keyword kw">end</span>
4145: 
4146:         <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">item</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">action_type_name</span>)
4147:       <span class="ruby-keyword kw">end</span>
4148:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of @action_screen.rows.each</span>
4149:     <span class="ruby-comment cmt"># ------ Business Record ------</span>
4150:     <span class="ruby-identifier">row_ids</span> = []
4151:     <span class="ruby-identifier">sql_head</span> = <span class="ruby-value str">&quot;SELECT rows.* FROM rows INNER JOIN CELLS on rows.id = cells.row_id WHERE (rows.screen_id = &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; AND (cells.field_id = &quot;</span>
4152:     <span class="ruby-identifier">sql_last</span> = <span class="ruby-value str">&quot; and cells.value between '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_from</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;' and '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_to</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;'))&quot;</span>
4153:     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
4154:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
4155:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
4156:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
4157:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
4158: 
4159:     <span class="ruby-identifier">business_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-identifier">sql</span>)
4160:     <span class="ruby-identifier">brows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">business_rows</span>, <span class="ruby-identifier">business_field_ids</span>)
4161:     <span class="ruby-identifier">business_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fb</span><span class="ruby-operator">|</span>
4162:       <span class="ruby-identifier">issue</span> = <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>]
4163: 
4164:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4165:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4166: 
4167:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
4168: 
4169:       <span class="ruby-identifier">item</span> = <span class="ruby-identifier">rptitem_ref</span>[<span class="ruby-identifier">customer_id</span>]
4170: 
4171:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
4172:       <span class="ruby-identifier">customer_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">customer_id</span>]
4173: 
4174:       <span class="ruby-identifier">br_date</span> = []
4175:       <span class="ruby-identifier">br_amount</span> = []
4176:       <span class="ruby-identifier">br_name</span> = [<span class="ruby-value str">&quot;Quotation&quot;</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-value str">&quot;Invoice&quot;</span>,<span class="ruby-value str">&quot;Payment&quot;</span>]
4177:       <span class="ruby-identifier">br_count</span> = [<span class="ruby-value str">&quot;Quotation_count&quot;</span>,<span class="ruby-value str">&quot;P/O_count&quot;</span>,<span class="ruby-value str">&quot;Delivery_count&quot;</span>,<span class="ruby-value str">&quot;Invoice_count&quot;</span>,<span class="ruby-value str">&quot;Payment_count&quot;</span>]
4178: 
4179:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>]
4180:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>]
4181:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>]
4182:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>]
4183:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>]
4184: 
4185:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>]
4186:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>]
4187:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>]
4188:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>]
4189:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
4190: 
4191:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>].<span class="ruby-identifier">nil?</span>
4192:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>] <span class="ruby-operator">||=</span>{}
4193:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>] <span class="ruby-operator">||=</span>{}
4194:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
4195:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
4196:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
4197: 
4198:         <span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
4199:           <span class="ruby-identifier">rank_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>]
4200:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
4201:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
4202:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
4203:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
4204:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
4205: 
4206:           <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
4207:             <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
4208:             <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
4209:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
4210:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
4211:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
4212:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
4213:           <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
4214:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Potential Rank</span>
4215:       <span class="ruby-keyword kw">end</span>
4216: 
4217:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>].<span class="ruby-identifier">nil?</span>
4218:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
4219:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
4220:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
4221:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
4222:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
4223: 
4224:         <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
4225:           <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
4226:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
4227:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>] <span class="ruby-operator">||=</span>{}
4228:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
4229:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
4230:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
4231:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
4232:       <span class="ruby-keyword kw">end</span>
4233:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>].<span class="ruby-identifier">nil?</span>
4234:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
4235:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
4236:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
4237:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
4238:       <span class="ruby-keyword kw">end</span>
4239: 
4240:       <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
4241:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">br_name</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
4242:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Quotation&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">issue_state</span>(<span class="ruby-identifier">issue</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">:cancelled</span>)
4243:         <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@date_from</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@date_to</span>))
4244:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">item</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>], <span class="ruby-identifier">br_amount</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">to_f</span>, <span class="ruby-value">0</span><span class="ruby-value">.0</span>)
4245:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">item</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_count</span>[<span class="ruby-identifier">i</span>])
4246:         <span class="ruby-keyword kw">end</span>
4247:       <span class="ruby-keyword kw">end</span>
4248:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of business record</span>
4249:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>
4250:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000592" class="method-detail">
        <a name="M000592"></a>

        <div class="method-heading">
          <a href="#M000592" class="method-signature">
          <span class="method-name">action_daily_type1_1</span><span class="method-args">(date_from, date_to)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000592-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000592-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 2683</span>
2683:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">action_daily_type1_1</span>(<span class="ruby-identifier">date_from</span>, <span class="ruby-identifier">date_to</span>)
2684:     <span class="ruby-comment cmt">#Product Type</span>
2685:     <span class="ruby-ivar">@date_from</span> = <span class="ruby-identifier">date_from</span>
2686:     <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">date_to</span>
2687:     <span class="ruby-identifier">screen_all</span> = <span class="ruby-identifier">get_all_screen</span>
2688:     <span class="ruby-identifier">cf_all</span> = <span class="ruby-identifier">get_all_customfield</span>
2689:     <span class="ruby-comment cmt">#Action</span>
2690:     <span class="ruby-identifier">action_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'action_revision'</span>]
2691: 
2692:     <span class="ruby-comment cmt">#Task</span>
2693:     <span class="ruby-identifier">task_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'task_detail'</span>]
2694: 
2695:     <span class="ruby-comment cmt">#Business Record</span>
2696:     <span class="ruby-identifier">business_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'business record'</span>]
2697: 
2698:     <span class="ruby-comment cmt">#Product Type</span>
2699:     <span class="ruby-identifier">product_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'product_type'</span>]
2700: 
2701:     <span class="ruby-identifier">cf_product_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'production_type_ref'</span>]
2702:     <span class="ruby-identifier">cf_customer</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'customer_ref'</span>]
2703:     <span class="ruby-identifier">cf_issue_tracking</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'issue tracking'</span>]
2704:     <span class="ruby-identifier">cf_action_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'action type'</span>]
2705:     <span class="ruby-identifier">cf_visit_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'visit purpose'</span>]
2706:     <span class="ruby-identifier">cf_task_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'task purpose'</span>]
2707:     <span class="ruby-identifier">cf_salesman</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'salesman_ref'</span>]
2708:     <span class="ruby-identifier">cf_quotation_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation date'</span>]
2709:     <span class="ruby-identifier">cf_po_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po date'</span>]
2710:     <span class="ruby-identifier">cf_invoice_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice date'</span>]
2711:     <span class="ruby-identifier">cf_delivery_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery date'</span>]
2712:     <span class="ruby-identifier">cf_payment_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment date'</span>]
2713:     <span class="ruby-identifier">cf_quotation_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation amount'</span>]
2714:     <span class="ruby-identifier">cf_po_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po amount'</span>]
2715:     <span class="ruby-identifier">cf_invoice_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice amount'</span>]
2716:     <span class="ruby-identifier">cf_delivery_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery amount'</span>]
2717:     <span class="ruby-identifier">cf_payment_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment amount'</span>]
2718: 
2719:     <span class="ruby-identifier">action_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>]
2720:     <span class="ruby-identifier">task_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>]
2721:     <span class="ruby-identifier">business_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
2722: 
2723:     <span class="ruby-ivar">@result</span> = {} <span class="ruby-comment cmt">#Keep amount of all activity</span>
2724:     <span class="ruby-ivar">@total</span> = {} <span class="ruby-comment cmt">#Keep total amount of all activity</span>
2725:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2726:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2727:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2728: 
2729:     <span class="ruby-identifier">ptype_ref</span> = <span class="ruby-identifier">gen_ref_values</span>(<span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">id</span>)
2730:     
2731:     <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
2732:       <span class="ruby-identifier">product_type</span> = <span class="ruby-identifier">ptype_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
2733:       <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>] <span class="ruby-operator">||=</span>{}
2734:       <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2735:       <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2736:       <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2737:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>] <span class="ruby-operator">||=</span>{}
2738:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2739:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2740:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2741: 
2742:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
2743: 
2744:     <span class="ruby-comment cmt"># ------ Action ------</span>
2745:     <span class="ruby-identifier">action_rows</span> = <span class="ruby-identifier">get_action_rows</span>(<span class="ruby-identifier">action_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)[<span class="ruby-value">0</span>]
2746: 
2747:     <span class="ruby-identifier">a_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">action_rows</span>, <span class="ruby-identifier">action_field_ids</span>)
2748: 
2749:     <span class="ruby-identifier">action_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fa</span><span class="ruby-operator">|</span>
2750:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2751: 
2752:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">ptype_ref</span>[<span class="ruby-identifier">product_type_id</span>]
2753: 
2754:       <span class="ruby-identifier">action_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>])
2755: 
2756:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2757:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
2758:       <span class="ruby-keyword kw">else</span>
2759:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">action_type_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2760:       <span class="ruby-keyword kw">end</span>
2761: 
2762:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Visit&quot;</span>
2763:         <span class="ruby-identifier">visit_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>])
2764:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">visit_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2765:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Routine&quot;</span>
2766:         <span class="ruby-keyword kw">else</span>
2767:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">visit_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2768:         <span class="ruby-keyword kw">end</span>
2769:       <span class="ruby-keyword kw">end</span>
2770: 
2771:       <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>], <span class="ruby-identifier">:action</span>, <span class="ruby-identifier">action_type_name</span>)
2772: 
2773:       <span class="ruby-comment cmt"># ------ Task ------</span>
2774:       <span class="ruby-identifier">task_rows</span> = <span class="ruby-identifier">fa</span>.<span class="ruby-identifier">detail_rows</span>
2775: 
2776:       <span class="ruby-identifier">t_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">task_rows</span>, <span class="ruby-identifier">task_field_ids</span>)
2777:       <span class="ruby-identifier">task_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ft</span><span class="ruby-operator">|</span>
2778:         <span class="ruby-identifier">task_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">RadioButton</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">t_rows</span>[<span class="ruby-identifier">ft</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>])
2779: 
2780:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2781:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
2782:         <span class="ruby-keyword kw">else</span>
2783:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">task_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2784:         <span class="ruby-keyword kw">end</span>
2785:         
2786:         <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>], <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">action_type_name</span>)
2787:       <span class="ruby-keyword kw">end</span>
2788:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of @action_screen.rows.each</span>
2789:     <span class="ruby-comment cmt"># ------ Business Record ------</span>
2790:     <span class="ruby-identifier">row_ids</span> = []
2791:     <span class="ruby-identifier">sql_head</span> = <span class="ruby-value str">&quot;SELECT rows.* FROM rows INNER JOIN CELLS on rows.id = cells.row_id WHERE (rows.screen_id = &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; AND (cells.field_id = &quot;</span>
2792:     <span class="ruby-identifier">sql_last</span> = <span class="ruby-value str">&quot; and cells.value between '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_from</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;' and '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_to</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;'))&quot;</span>
2793:     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2794:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2795:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2796:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2797:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2798: 
2799:     <span class="ruby-identifier">business_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-identifier">sql</span>)
2800:     <span class="ruby-identifier">brows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">business_rows</span>, <span class="ruby-identifier">business_field_ids</span>)
2801:     <span class="ruby-identifier">business_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fb</span><span class="ruby-operator">|</span>
2802:       <span class="ruby-identifier">issue</span> = <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>]
2803: 
2804:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2805: 
2806:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">ptype_ref</span>[<span class="ruby-identifier">product_type_id</span>]
2807: 
2808:       <span class="ruby-identifier">br_date</span> = []
2809:       <span class="ruby-identifier">br_amount</span> = []
2810:       <span class="ruby-identifier">br_name</span> = [<span class="ruby-value str">&quot;Quotation&quot;</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-value str">&quot;Invoice&quot;</span>,<span class="ruby-value str">&quot;Payment&quot;</span>]
2811:       <span class="ruby-identifier">br_count</span> = [<span class="ruby-value str">&quot;Quotation_count&quot;</span>,<span class="ruby-value str">&quot;P/O_count&quot;</span>,<span class="ruby-value str">&quot;Delivery_count&quot;</span>,<span class="ruby-value str">&quot;Invoice_count&quot;</span>,<span class="ruby-value str">&quot;Payment_count&quot;</span>]
2812: 
2813:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>]
2814:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>]
2815:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>]
2816:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>]
2817:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>]
2818: 
2819:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>]
2820:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>]
2821:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>]
2822:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>]
2823:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
2824: 
2825:       <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
2826:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">br_name</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
2827:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Quotation&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">issue_state</span>(<span class="ruby-identifier">issue</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">:cancelled</span>)
2828:         <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@date_from</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@date_to</span>))
2829:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>], <span class="ruby-identifier">br_amount</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">to_f</span>, <span class="ruby-value">0</span><span class="ruby-value">.0</span>)
2830:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_count</span>[<span class="ruby-identifier">i</span>])
2831:         <span class="ruby-keyword kw">end</span>
2832:       <span class="ruby-keyword kw">end</span>
2833:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of business record</span>
2834:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>
2835:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000591" class="method-detail">
        <a name="M000591"></a>

        <div class="method-heading">
          <a href="#M000591" class="method-signature">
          <span class="method-name">action_daily_type1_2</span><span class="method-args">(date_from, date_to)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000591-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000591-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 2514</span>
2514:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">action_daily_type1_2</span>(<span class="ruby-identifier">date_from</span>, <span class="ruby-identifier">date_to</span>)
2515:     <span class="ruby-comment cmt">#Product Type -&gt; Sales Office</span>
2516:     <span class="ruby-ivar">@date_from</span> = <span class="ruby-identifier">date_from</span>
2517:     <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">date_to</span>
2518:     <span class="ruby-identifier">screen_all</span> = <span class="ruby-identifier">get_all_screen</span>
2519:     <span class="ruby-identifier">cf_all</span> = <span class="ruby-identifier">get_all_customfield</span>
2520:     <span class="ruby-comment cmt">#Branch</span>
2521:     <span class="ruby-identifier">branch_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'sales office'</span>]
2522: 
2523:     <span class="ruby-comment cmt">#Action</span>
2524:     <span class="ruby-identifier">action_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'action_revision'</span>]
2525: 
2526:     <span class="ruby-comment cmt">#Task</span>
2527:     <span class="ruby-identifier">task_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'task_detail'</span>]
2528: 
2529:     <span class="ruby-comment cmt">#Business Record</span>
2530:     <span class="ruby-identifier">business_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'business record'</span>]
2531: 
2532:     <span class="ruby-comment cmt">#Product Type</span>
2533:     <span class="ruby-identifier">product_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'product_type'</span>]
2534: 
2535:     <span class="ruby-identifier">cf_product_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'production_type_ref'</span>]
2536:     <span class="ruby-identifier">cf_customer</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'customer_ref'</span>]
2537:     <span class="ruby-identifier">cf_issue_tracking</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'issue tracking'</span>]
2538:     <span class="ruby-identifier">cf_action_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'action type'</span>]
2539:     <span class="ruby-identifier">cf_visit_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'visit purpose'</span>]
2540:     <span class="ruby-identifier">cf_task_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'task purpose'</span>]
2541:     <span class="ruby-identifier">cf_salesman</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'salesman_ref'</span>]
2542:     <span class="ruby-identifier">cf_quotation_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation date'</span>]
2543:     <span class="ruby-identifier">cf_po_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po date'</span>]
2544:     <span class="ruby-identifier">cf_invoice_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice date'</span>]
2545:     <span class="ruby-identifier">cf_delivery_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery date'</span>]
2546:     <span class="ruby-identifier">cf_payment_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment date'</span>]
2547:     <span class="ruby-identifier">cf_quotation_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation amount'</span>]
2548:     <span class="ruby-identifier">cf_po_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po amount'</span>]
2549:     <span class="ruby-identifier">cf_invoice_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice amount'</span>]
2550:     <span class="ruby-identifier">cf_delivery_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery amount'</span>]
2551:     <span class="ruby-identifier">cf_payment_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment amount'</span>]
2552: 
2553:     <span class="ruby-identifier">action_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>]
2554:     <span class="ruby-identifier">task_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>]
2555:     <span class="ruby-identifier">business_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
2556: 
2557:     <span class="ruby-ivar">@result</span> = {} <span class="ruby-comment cmt">#Keep amount of all activity</span>
2558:     <span class="ruby-ivar">@total</span> = {} <span class="ruby-comment cmt">#Keep total amount of all activity</span>
2559:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2560:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2561:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2562: 
2563:     <span class="ruby-identifier">all_ref</span> = <span class="ruby-identifier">gen_ref_values</span>([<span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">id</span>], [])
2564: 
2565:     <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
2566:       <span class="ruby-identifier">product_type</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
2567:       <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>] <span class="ruby-operator">||=</span>{}
2568:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>] <span class="ruby-operator">||=</span>{}
2569:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2570:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2571:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2572: 
2573:       <span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span>
2574:         <span class="ruby-identifier">b_descr</span> = <span class="ruby-identifier">b</span>.<span class="ruby-identifier">description</span>
2575:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>] <span class="ruby-operator">||=</span>{}
2576:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2577:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2578:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2579:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>] <span class="ruby-operator">||=</span>{}
2580:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2581:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2582:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2583: 
2584:       <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End @branch_screen.rows.each</span>
2585:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
2586: 
2587:     <span class="ruby-comment cmt"># ------ Action ------</span>
2588:     <span class="ruby-identifier">action_rows</span> = <span class="ruby-identifier">get_action_rows</span>(<span class="ruby-identifier">action_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)[<span class="ruby-value">0</span>]
2589: 
2590:     <span class="ruby-identifier">a_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">action_rows</span>, <span class="ruby-identifier">action_field_ids</span>)
2591: 
2592:     <span class="ruby-identifier">action_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fa</span><span class="ruby-operator">|</span>
2593:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2594:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2595: 
2596:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
2597:       <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">salesman_id</span>, <span class="ruby-identifier">all_ref</span>, <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>], <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>])
2598: 
2599:       <span class="ruby-identifier">action_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>])
2600: 
2601:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2602:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
2603:       <span class="ruby-keyword kw">else</span>
2604:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">action_type_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2605:       <span class="ruby-keyword kw">end</span>
2606: 
2607:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Visit&quot;</span>
2608:         <span class="ruby-identifier">visit_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>])
2609:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">visit_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2610:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Routine&quot;</span>
2611:         <span class="ruby-keyword kw">else</span>
2612:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">visit_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2613:         <span class="ruby-keyword kw">end</span>
2614:       <span class="ruby-keyword kw">end</span>
2615: 
2616:       <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>], <span class="ruby-identifier">:action</span>, <span class="ruby-identifier">action_type_name</span>)
2617: 
2618:       <span class="ruby-comment cmt"># ------ Task ------</span>
2619:       <span class="ruby-identifier">task_rows</span> = <span class="ruby-identifier">fa</span>.<span class="ruby-identifier">detail_rows</span>
2620: 
2621:       <span class="ruby-identifier">t_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">task_rows</span>, <span class="ruby-identifier">task_field_ids</span>)
2622:       <span class="ruby-identifier">task_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ft</span><span class="ruby-operator">|</span>
2623:         <span class="ruby-identifier">task_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">RadioButton</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">t_rows</span>[<span class="ruby-identifier">ft</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>])
2624: 
2625:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2626:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
2627:         <span class="ruby-keyword kw">else</span>
2628:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">task_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2629:         <span class="ruby-keyword kw">end</span>
2630: 
2631:         <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>], <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">action_type_name</span>)
2632:       <span class="ruby-keyword kw">end</span>
2633:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of @action_screen.rows.each</span>
2634:     <span class="ruby-comment cmt"># ------ Business Record ------</span>
2635:     <span class="ruby-identifier">row_ids</span> = []
2636:     <span class="ruby-identifier">sql_head</span> = <span class="ruby-value str">&quot;SELECT rows.* FROM rows INNER JOIN CELLS on rows.id = cells.row_id WHERE (rows.screen_id = &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; AND (cells.field_id = &quot;</span>
2637:     <span class="ruby-identifier">sql_last</span> = <span class="ruby-value str">&quot; and cells.value between '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_from</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;' and '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_to</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;'))&quot;</span>
2638:     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2639:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2640:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2641:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2642:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2643: 
2644:     <span class="ruby-identifier">business_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-identifier">sql</span>)
2645:     <span class="ruby-identifier">brows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">business_rows</span>, <span class="ruby-identifier">business_field_ids</span>)
2646:     <span class="ruby-identifier">business_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fb</span><span class="ruby-operator">|</span>
2647:       <span class="ruby-identifier">issue</span> = <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>]
2648: 
2649:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2650:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2651: 
2652:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
2653:       <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">salesman_id</span>, <span class="ruby-identifier">all_ref</span>, <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>], <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>])
2654: 
2655:       <span class="ruby-identifier">br_date</span> = []
2656:       <span class="ruby-identifier">br_amount</span> = []
2657:       <span class="ruby-identifier">br_name</span> = [<span class="ruby-value str">&quot;Quotation&quot;</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-value str">&quot;Invoice&quot;</span>,<span class="ruby-value str">&quot;Payment&quot;</span>]
2658:       <span class="ruby-identifier">br_count</span> = [<span class="ruby-value str">&quot;Quotation_count&quot;</span>,<span class="ruby-value str">&quot;P/O_count&quot;</span>,<span class="ruby-value str">&quot;Delivery_count&quot;</span>,<span class="ruby-value str">&quot;Invoice_count&quot;</span>,<span class="ruby-value str">&quot;Payment_count&quot;</span>]
2659: 
2660:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>]
2661:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>]
2662:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>]
2663:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>]
2664:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>]
2665: 
2666:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>]
2667:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>]
2668:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>]
2669:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>]
2670:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
2671: 
2672:       <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
2673:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">br_name</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
2674:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Quotation&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">issue_state</span>(<span class="ruby-identifier">issue</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">:cancelled</span>)
2675:         <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@date_from</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@date_to</span>))
2676:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>], <span class="ruby-identifier">br_amount</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">to_f</span>, <span class="ruby-value">0</span><span class="ruby-value">.0</span>)
2677:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_count</span>[<span class="ruby-identifier">i</span>])
2678:         <span class="ruby-keyword kw">end</span>
2679:       <span class="ruby-keyword kw">end</span>
2680:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of business record</span>
2681:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>
2682:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000590" class="method-detail">
        <a name="M000590"></a>

        <div class="method-heading">
          <a href="#M000590" class="method-signature">
          <span class="method-name">action_daily_type1_3</span><span class="method-args">(date_from, date_to)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000590-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000590-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 2318</span>
2318:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">action_daily_type1_3</span>(<span class="ruby-identifier">date_from</span>, <span class="ruby-identifier">date_to</span>)
2319:     <span class="ruby-comment cmt">#Product Type -&gt; Sales Office -&gt; Salesman</span>
2320:     <span class="ruby-ivar">@date_from</span> = <span class="ruby-identifier">date_from</span>
2321:     <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">date_to</span>
2322:     <span class="ruby-identifier">screen_all</span> = <span class="ruby-identifier">get_all_screen</span>
2323:     <span class="ruby-identifier">cf_all</span> = <span class="ruby-identifier">get_all_customfield</span>
2324:     <span class="ruby-comment cmt">#Branch</span>
2325:     <span class="ruby-identifier">branch_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'sales office'</span>]
2326: 
2327:     <span class="ruby-comment cmt">#Staff</span>
2328:     <span class="ruby-identifier">sales_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>]
2329: 
2330:     <span class="ruby-comment cmt">#Action</span>
2331:     <span class="ruby-identifier">action_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'action_revision'</span>]
2332: 
2333:     <span class="ruby-comment cmt">#Task</span>
2334:     <span class="ruby-identifier">task_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'task_detail'</span>]
2335: 
2336:     <span class="ruby-comment cmt">#Business Record</span>
2337:     <span class="ruby-identifier">business_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'business record'</span>]
2338: 
2339:     <span class="ruby-comment cmt">#Product Type</span>
2340:     <span class="ruby-identifier">product_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'product_type'</span>]
2341: 
2342:     <span class="ruby-identifier">cf_branch</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>]
2343:     <span class="ruby-identifier">cf_product_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'production_type_ref'</span>]
2344:     <span class="ruby-identifier">cf_customer</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'customer_ref'</span>]
2345:     <span class="ruby-identifier">cf_issue_tracking</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'issue tracking'</span>]
2346:     <span class="ruby-identifier">cf_action_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'action type'</span>]
2347:     <span class="ruby-identifier">cf_visit_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'visit purpose'</span>]
2348:     <span class="ruby-identifier">cf_task_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'task purpose'</span>]
2349:     <span class="ruby-identifier">cf_salesman</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'salesman_ref'</span>]
2350:     <span class="ruby-identifier">cf_quotation_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation date'</span>]
2351:     <span class="ruby-identifier">cf_po_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po date'</span>]
2352:     <span class="ruby-identifier">cf_invoice_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice date'</span>]
2353:     <span class="ruby-identifier">cf_delivery_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery date'</span>]
2354:     <span class="ruby-identifier">cf_payment_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment date'</span>]
2355:     <span class="ruby-identifier">cf_quotation_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation amount'</span>]
2356:     <span class="ruby-identifier">cf_po_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po amount'</span>]
2357:     <span class="ruby-identifier">cf_invoice_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice amount'</span>]
2358:     <span class="ruby-identifier">cf_delivery_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery amount'</span>]
2359:     <span class="ruby-identifier">cf_payment_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment amount'</span>]
2360:     <span class="ruby-identifier">cf_login</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'login'</span>]
2361: 
2362:     <span class="ruby-identifier">action_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>]
2363:     <span class="ruby-identifier">task_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>]
2364:     <span class="ruby-identifier">business_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
2365: 
2366:     <span class="ruby-ivar">@result</span> = {} <span class="ruby-comment cmt">#Keep amount of all activity</span>
2367:     <span class="ruby-ivar">@total</span> = {} <span class="ruby-comment cmt">#Keep total amount of all activity</span>
2368:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2369:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2370:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2371: 
2372:     <span class="ruby-identifier">all_ref</span> = <span class="ruby-identifier">gen_ref_values</span>([<span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>], [])
2373: 
2374:     <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
2375:       <span class="ruby-identifier">product_type</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
2376:       <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>] <span class="ruby-operator">||=</span>{}
2377:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>] <span class="ruby-operator">||=</span>{}
2378:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2379:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2380:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2381: 
2382:       <span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span>
2383:         <span class="ruby-identifier">b_descr</span> = <span class="ruby-identifier">b</span>.<span class="ruby-identifier">description</span>
2384:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>] <span class="ruby-operator">||=</span>{}
2385:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>] <span class="ruby-operator">||=</span>{}
2386:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2387:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2388:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2389: 
2390:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
2391:           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
2392:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.value like ? and cells.field_id = ? and rows.screen_id = ?&quot;</span>, <span class="ruby-node">&quot;%#{b.id.to_s}%&quot;</span>, <span class="ruby-identifier">cf_branch</span>.<span class="ruby-identifier">id</span> , <span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>])
2393:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">cf_branch</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">value</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">compact</span>
2394:         <span class="ruby-identifier">row_ids</span> = []
2395:         <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">id</span>}
2396:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
2397:           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
2398:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.value != '' and cells.field_id = ? and rows.screen_id = ? and rows.id in (?)&quot;</span>, <span class="ruby-identifier">cf_login</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">row_ids</span>])
2399:         <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fs</span><span class="ruby-operator">|</span>
2400:           <span class="ruby-identifier">sales_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">fs</span>.<span class="ruby-identifier">id</span>]
2401:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>] <span class="ruby-operator">||=</span>{}
2402:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2403:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2404:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2405:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>] <span class="ruby-operator">||=</span>{}
2406:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2407:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2408:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2409: 
2410:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of sales_rows.each</span>
2411:       <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End @branch_screen.rows.each</span>
2412:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
2413: 
2414:     <span class="ruby-comment cmt"># ------ Action ------</span>
2415:     <span class="ruby-identifier">action_rows</span> = <span class="ruby-identifier">get_action_rows</span>(<span class="ruby-identifier">action_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)[<span class="ruby-value">0</span>]
2416: 
2417:     <span class="ruby-identifier">a_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">action_rows</span>, <span class="ruby-identifier">action_field_ids</span>)
2418: 
2419:     <span class="ruby-identifier">action_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fa</span><span class="ruby-operator">|</span>
2420:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2421:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2422: 
2423:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
2424:       <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">salesman_id</span>, <span class="ruby-identifier">all_ref</span>, <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>], <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>])
2425:       <span class="ruby-identifier">salesman</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">salesman_id</span>]
2426: 
2427:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>].<span class="ruby-identifier">nil?</span>
2428: 
2429:       <span class="ruby-identifier">action_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>])
2430:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2431:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
2432:       <span class="ruby-keyword kw">else</span>
2433:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">action_type_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2434:       <span class="ruby-keyword kw">end</span>
2435: 
2436:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Visit&quot;</span>
2437:         <span class="ruby-identifier">visit_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>])
2438:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">visit_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2439:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Routine&quot;</span>
2440:         <span class="ruby-keyword kw">else</span>
2441:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">visit_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2442:         <span class="ruby-keyword kw">end</span>
2443:       <span class="ruby-keyword kw">end</span>
2444:         
2445:       <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>], <span class="ruby-identifier">:action</span>, <span class="ruby-identifier">action_type_name</span>)
2446: 
2447:       <span class="ruby-comment cmt"># ------ Task ------</span>
2448:       <span class="ruby-identifier">task_rows</span> =  <span class="ruby-identifier">fa</span>.<span class="ruby-identifier">detail_rows</span>
2449: 
2450:       <span class="ruby-identifier">t_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">task_rows</span>, <span class="ruby-identifier">task_field_ids</span>)
2451:       <span class="ruby-identifier">task_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ft</span><span class="ruby-operator">|</span>
2452:         <span class="ruby-identifier">task_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">RadioButton</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">t_rows</span>[<span class="ruby-identifier">ft</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>])
2453:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2454:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
2455:         <span class="ruby-keyword kw">else</span>
2456:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">task_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2457:         <span class="ruby-keyword kw">end</span>
2458: 
2459:         <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>], <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">action_type_name</span>)
2460:       <span class="ruby-keyword kw">end</span>
2461:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of @action_screen.rows.each</span>
2462:     <span class="ruby-comment cmt"># ------ Business Record ------</span>
2463:     <span class="ruby-identifier">row_ids</span> = []
2464:     <span class="ruby-identifier">sql_head</span> = <span class="ruby-value str">&quot;SELECT rows.* FROM rows INNER JOIN CELLS on rows.id = cells.row_id WHERE (rows.screen_id = &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; AND (cells.field_id = &quot;</span>
2465:     <span class="ruby-identifier">sql_last</span> = <span class="ruby-value str">&quot; and cells.value between '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_from</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;' and '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_to</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;'))&quot;</span>
2466:     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2467:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2468:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2469:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2470:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2471: 
2472:     <span class="ruby-identifier">business_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-identifier">sql</span>)
2473:     <span class="ruby-identifier">brows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">business_rows</span>, <span class="ruby-identifier">business_field_ids</span>)
2474:     <span class="ruby-identifier">business_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fb</span><span class="ruby-operator">|</span>
2475:       <span class="ruby-identifier">issue</span> = <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>]
2476: 
2477:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2478:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2479: 
2480:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
2481:       <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">salesman_id</span>, <span class="ruby-identifier">all_ref</span>, <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>], <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>])
2482:       <span class="ruby-identifier">salesman</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">salesman_id</span>]
2483: 
2484:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>].<span class="ruby-identifier">nil?</span>
2485: 
2486:       <span class="ruby-identifier">br_date</span> = []
2487:       <span class="ruby-identifier">br_amount</span> = []
2488:       <span class="ruby-identifier">br_name</span> = [<span class="ruby-value str">&quot;Quotation&quot;</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-value str">&quot;Invoice&quot;</span>,<span class="ruby-value str">&quot;Payment&quot;</span>]
2489:       <span class="ruby-identifier">br_count</span> = [<span class="ruby-value str">&quot;Quotation_count&quot;</span>,<span class="ruby-value str">&quot;P/O_count&quot;</span>,<span class="ruby-value str">&quot;Delivery_count&quot;</span>,<span class="ruby-value str">&quot;Invoice_count&quot;</span>,<span class="ruby-value str">&quot;Payment_count&quot;</span>]
2490: 
2491:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>]
2492:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>]
2493:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>]
2494:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>]
2495:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>]
2496: 
2497:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>]
2498:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>]
2499:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>]
2500:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>]
2501:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
2502: 
2503:       <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
2504:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">br_name</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
2505:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Quotation&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">issue_state</span>(<span class="ruby-identifier">issue</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">:cancelled</span>)
2506:         <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@date_from</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@date_to</span>))
2507:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>], <span class="ruby-identifier">br_amount</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">to_f</span>, <span class="ruby-value">0</span><span class="ruby-value">.0</span>)
2508:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_count</span>[<span class="ruby-identifier">i</span>])
2509:         <span class="ruby-keyword kw">end</span>
2510:       <span class="ruby-keyword kw">end</span>
2511:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of business record</span>
2512:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>
2513:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000589" class="method-detail">
        <a name="M000589"></a>

        <div class="method-heading">
          <a href="#M000589" class="method-signature">
          <span class="method-name">action_daily_type1_4</span><span class="method-args">(date_from, date_to)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000589-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000589-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 2085</span>
2085:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">action_daily_type1_4</span>(<span class="ruby-identifier">date_from</span>, <span class="ruby-identifier">date_to</span>)
2086:     <span class="ruby-comment cmt">#Product Type -&gt; Sales Office -&gt; Salesman -&gt; Potential Rank</span>
2087:     <span class="ruby-ivar">@date_from</span> = <span class="ruby-identifier">date_from</span>
2088:     <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">date_to</span>
2089:     <span class="ruby-identifier">screen_all</span> = <span class="ruby-identifier">get_all_screen</span>
2090:     <span class="ruby-identifier">cf_all</span> = <span class="ruby-identifier">get_all_customfield</span>
2091:     <span class="ruby-comment cmt">#Branch</span>
2092:     <span class="ruby-identifier">branch_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'sales office'</span>]
2093: 
2094:     <span class="ruby-comment cmt">#Staff</span>
2095:     <span class="ruby-identifier">sales_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>]
2096: 
2097:     <span class="ruby-comment cmt">#Potential Rank</span>
2098:     <span class="ruby-identifier">rank_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'potential rank'</span>]
2099: 
2100:     <span class="ruby-comment cmt">#Action</span>
2101:     <span class="ruby-identifier">action_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'action_revision'</span>]
2102: 
2103:     <span class="ruby-comment cmt">#Task</span>
2104:     <span class="ruby-identifier">task_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'task_detail'</span>]
2105: 
2106:     <span class="ruby-comment cmt">#Business Record</span>
2107:     <span class="ruby-identifier">business_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'business record'</span>]
2108: 
2109:     <span class="ruby-comment cmt">#Product Type</span>
2110:     <span class="ruby-identifier">product_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'product_type'</span>]
2111: 
2112:     <span class="ruby-comment cmt">#Customer</span>
2113:     <span class="ruby-identifier">customer_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'customer'</span>]
2114: 
2115:     <span class="ruby-identifier">cf_branch</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>]
2116:     <span class="ruby-identifier">cf_product_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'production_type_ref'</span>]
2117:     <span class="ruby-identifier">cf_customer</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'customer_ref'</span>]
2118:     <span class="ruby-identifier">cf_issue_tracking</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'issue tracking'</span>]
2119:     <span class="ruby-identifier">cf_action_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'action type'</span>]
2120:     <span class="ruby-identifier">cf_visit_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'visit purpose'</span>]
2121:     <span class="ruby-identifier">cf_task_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'task purpose'</span>]
2122:     <span class="ruby-identifier">cf_salesman</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'salesman_ref'</span>]
2123:     <span class="ruby-identifier">cf_quotation_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation date'</span>]
2124:     <span class="ruby-identifier">cf_po_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po date'</span>]
2125:     <span class="ruby-identifier">cf_invoice_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice date'</span>]
2126:     <span class="ruby-identifier">cf_delivery_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery date'</span>]
2127:     <span class="ruby-identifier">cf_payment_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment date'</span>]
2128:     <span class="ruby-identifier">cf_quotation_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation amount'</span>]
2129:     <span class="ruby-identifier">cf_po_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po amount'</span>]
2130:     <span class="ruby-identifier">cf_invoice_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice amount'</span>]
2131:     <span class="ruby-identifier">cf_delivery_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery amount'</span>]
2132:     <span class="ruby-identifier">cf_payment_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment amount'</span>]
2133:     <span class="ruby-identifier">cf_login</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'login'</span>]
2134:     <span class="ruby-identifier">cf_rank</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'potential_rank_ref'</span>]
2135: 
2136:     <span class="ruby-identifier">action_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>]
2137:     <span class="ruby-identifier">task_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>]
2138:     <span class="ruby-identifier">business_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
2139: 
2140:     <span class="ruby-ivar">@result</span> = {} <span class="ruby-comment cmt">#Keep amount of all activity</span>
2141:     <span class="ruby-ivar">@total</span> = {} <span class="ruby-comment cmt">#Keep total amount of all activity</span>
2142:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2143:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2144:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2145: 
2146:     <span class="ruby-identifier">all_ref</span> = <span class="ruby-identifier">gen_ref_values</span>([<span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">id</span>], [])
2147:     <span class="ruby-identifier">custrank_ref</span> = <span class="ruby-identifier">gen_ref_values</span>(<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_rank</span>.<span class="ruby-identifier">id</span>)
2148: 
2149:     <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
2150:       <span class="ruby-identifier">product_type</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
2151:       <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>] <span class="ruby-operator">||=</span>{}
2152:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>] <span class="ruby-operator">||=</span>{}
2153:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2154:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2155:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2156: 
2157:       <span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span>
2158:         <span class="ruby-identifier">b_descr</span> = <span class="ruby-identifier">b</span>.<span class="ruby-identifier">description</span>
2159:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>] <span class="ruby-operator">||=</span>{}
2160:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>] <span class="ruby-operator">||=</span>{}
2161:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2162:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2163:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2164: 
2165:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
2166:           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
2167:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.value like ? and cells.field_id = ? and rows.screen_id = ?&quot;</span>, <span class="ruby-node">&quot;%#{b.id.to_s}%&quot;</span>, <span class="ruby-identifier">cf_branch</span>.<span class="ruby-identifier">id</span> , <span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>])
2168:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">cf_branch</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">value</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">compact</span>
2169:         <span class="ruby-identifier">row_ids</span> = []
2170:         <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">id</span>}
2171:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
2172:           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
2173:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.value != '' and cells.field_id = ? and rows.screen_id = ? and rows.id in (?)&quot;</span>, <span class="ruby-identifier">cf_login</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">row_ids</span>])
2174:         <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fs</span><span class="ruby-operator">|</span>
2175:           <span class="ruby-identifier">sales_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">fs</span>.<span class="ruby-identifier">id</span>]
2176:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>] <span class="ruby-operator">||=</span>{}
2177: 
2178:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>] <span class="ruby-operator">||=</span>{}
2179:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2180:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2181:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2182: 
2183:           <span class="ruby-comment cmt"># ----- Potential Rank ------</span>
2184:           <span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
2185:             <span class="ruby-identifier">rank_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>]
2186:             <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
2187:             <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2188:             <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2189:             <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2190:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
2191:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2192:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2193:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2194:           <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Potential Rank</span>
2195:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of sales_rows.each</span>
2196:       <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End @branch_screen.rows.each</span>
2197:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
2198: 
2199:     <span class="ruby-comment cmt"># ------ Action ------</span>
2200:     <span class="ruby-identifier">action_rows</span> = <span class="ruby-identifier">get_action_rows</span>(<span class="ruby-identifier">action_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)[<span class="ruby-value">0</span>]
2201: 
2202:     <span class="ruby-identifier">a_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">action_rows</span>, <span class="ruby-identifier">action_field_ids</span>)
2203:     
2204:     <span class="ruby-identifier">action_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fa</span><span class="ruby-operator">|</span>
2205:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2206:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2207:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2208: 
2209:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
2210:       <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">salesman_id</span>, <span class="ruby-identifier">all_ref</span>, <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>], <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>])
2211:       <span class="ruby-identifier">salesman</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">salesman_id</span>]
2212: 
2213:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>].<span class="ruby-identifier">nil?</span>
2214: 
2215:       <span class="ruby-identifier">action_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>])
2216:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
2217:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2218:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
2219:       <span class="ruby-keyword kw">else</span>
2220:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">action_type_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2221:       <span class="ruby-keyword kw">end</span>
2222: 
2223:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Visit&quot;</span>
2224:         <span class="ruby-identifier">visit_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>])
2225:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">visit_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2226:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Routine&quot;</span>
2227:         <span class="ruby-keyword kw">else</span>
2228:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">visit_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2229:         <span class="ruby-keyword kw">end</span>
2230:       <span class="ruby-keyword kw">end</span>
2231: 
2232:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>].<span class="ruby-identifier">nil?</span>
2233:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
2234:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2235:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2236:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2237:       <span class="ruby-keyword kw">end</span>
2238: 
2239:       <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>], <span class="ruby-identifier">:action</span>, <span class="ruby-identifier">action_type_name</span>)
2240: 
2241:       <span class="ruby-comment cmt"># ------ Task ------</span>
2242:       <span class="ruby-identifier">task_rows</span> =  <span class="ruby-identifier">fa</span>.<span class="ruby-identifier">detail_rows</span>
2243: 
2244:       <span class="ruby-identifier">t_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">task_rows</span>, <span class="ruby-identifier">task_field_ids</span>)
2245:       <span class="ruby-identifier">task_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ft</span><span class="ruby-operator">|</span>
2246:         <span class="ruby-identifier">task_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">RadioButton</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">t_rows</span>[<span class="ruby-identifier">ft</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>])
2247:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2248:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
2249:         <span class="ruby-keyword kw">else</span>
2250:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">task_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2251:         <span class="ruby-keyword kw">end</span>
2252:         <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
2253: 
2254:         <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>], <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">action_type_name</span>)
2255:       <span class="ruby-keyword kw">end</span>
2256:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of @action_screen.rows.each</span>
2257:     <span class="ruby-comment cmt"># ------ Business Record ------</span>
2258:     <span class="ruby-identifier">row_ids</span> = []
2259:     <span class="ruby-identifier">sql_head</span> = <span class="ruby-value str">&quot;SELECT rows.* FROM rows INNER JOIN CELLS on rows.id = cells.row_id WHERE (rows.screen_id = &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; AND (cells.field_id = &quot;</span>
2260:     <span class="ruby-identifier">sql_last</span> = <span class="ruby-value str">&quot; and cells.value between '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_from</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;' and '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_to</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;'))&quot;</span>
2261:     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2262:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2263:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2264:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2265:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2266:     <span class="ruby-identifier">business_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-identifier">sql</span>)
2267:     <span class="ruby-identifier">brows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">business_rows</span>, <span class="ruby-identifier">business_field_ids</span>)
2268:     <span class="ruby-identifier">business_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fb</span><span class="ruby-operator">|</span>
2269:       <span class="ruby-identifier">issue</span> = <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>]
2270: 
2271:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2272:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2273:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2274: 
2275:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
2276:       <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">salesman_id</span>, <span class="ruby-identifier">all_ref</span>, <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>], <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>])
2277:       <span class="ruby-identifier">salesman</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">salesman_id</span>]
2278: 
2279:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>].<span class="ruby-identifier">nil?</span>
2280: 
2281:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
2282: 
2283:       <span class="ruby-identifier">br_date</span> = []
2284:       <span class="ruby-identifier">br_amount</span> = []
2285:       <span class="ruby-identifier">br_name</span> = [<span class="ruby-value str">&quot;Quotation&quot;</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-value str">&quot;Invoice&quot;</span>,<span class="ruby-value str">&quot;Payment&quot;</span>]
2286:       <span class="ruby-identifier">br_count</span> = [<span class="ruby-value str">&quot;Quotation_count&quot;</span>,<span class="ruby-value str">&quot;P/O_count&quot;</span>,<span class="ruby-value str">&quot;Delivery_count&quot;</span>,<span class="ruby-value str">&quot;Invoice_count&quot;</span>,<span class="ruby-value str">&quot;Payment_count&quot;</span>]
2287: 
2288:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>]
2289:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>]
2290:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>]
2291:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>]
2292:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>]
2293: 
2294:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>]
2295:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>]
2296:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>]
2297:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>]
2298:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
2299: 
2300:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>].<span class="ruby-identifier">nil?</span>
2301:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
2302:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2303:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2304:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2305:       <span class="ruby-keyword kw">end</span>
2306: 
2307:       <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
2308:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">br_name</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
2309:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Quotation&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">issue_state</span>(<span class="ruby-identifier">issue</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">:cancelled</span>)
2310:         <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@date_from</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@date_to</span>))
2311:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>], <span class="ruby-identifier">br_amount</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">to_f</span>, <span class="ruby-value">0</span><span class="ruby-value">.0</span>)
2312:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_count</span>[<span class="ruby-identifier">i</span>])
2313:         <span class="ruby-keyword kw">end</span>
2314:       <span class="ruby-keyword kw">end</span>
2315:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of business record</span>
2316:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>
2317:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000588" class="method-detail">
        <a name="M000588"></a>

        <div class="method-heading">
          <a href="#M000588" class="method-signature">
          <span class="method-name">action_daily_type1_5</span><span class="method-args">(date_from, date_to)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000588-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000588-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1825</span>
1825:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">action_daily_type1_5</span>(<span class="ruby-identifier">date_from</span>, <span class="ruby-identifier">date_to</span>)
1826:     <span class="ruby-comment cmt">#Product Type -&gt; Sales Office -&gt; Salesman -&gt; Potential Rank -&gt; Customer</span>
1827:     <span class="ruby-ivar">@date_from</span> = <span class="ruby-identifier">date_from</span>
1828:     <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">date_to</span>
1829:     <span class="ruby-identifier">screen_all</span> = <span class="ruby-identifier">get_all_screen</span>
1830:     <span class="ruby-identifier">cf_all</span> = <span class="ruby-identifier">get_all_customfield</span>
1831:     <span class="ruby-comment cmt">#Branch</span>
1832:     <span class="ruby-identifier">branch_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'sales office'</span>]
1833: 
1834:     <span class="ruby-comment cmt">#Staff</span>
1835:     <span class="ruby-identifier">sales_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>]
1836: 
1837:     <span class="ruby-comment cmt">#Potential Rank</span>
1838:     <span class="ruby-identifier">rank_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'potential rank'</span>]
1839: 
1840:     <span class="ruby-comment cmt">#Action</span>
1841:     <span class="ruby-identifier">action_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'action_revision'</span>]
1842: 
1843:     <span class="ruby-comment cmt">#Task</span>
1844:     <span class="ruby-identifier">task_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'task_detail'</span>]
1845: 
1846:     <span class="ruby-comment cmt">#Business Record</span>
1847:     <span class="ruby-identifier">business_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'business record'</span>]
1848: 
1849:     <span class="ruby-comment cmt">#Product Type</span>
1850:     <span class="ruby-identifier">product_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'product_type'</span>]
1851: 
1852:     <span class="ruby-comment cmt">#Customer</span>
1853:     <span class="ruby-identifier">customer_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'customer'</span>]
1854: 
1855: 
1856:     <span class="ruby-identifier">cf_branch</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>]
1857:     <span class="ruby-identifier">cf_product_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'production_type_ref'</span>]
1858:     <span class="ruby-identifier">cf_customer</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'customer_ref'</span>]
1859:     <span class="ruby-identifier">cf_issue_tracking</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'issue tracking'</span>]
1860:     <span class="ruby-identifier">cf_action_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'action type'</span>]
1861:     <span class="ruby-identifier">cf_visit_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'visit purpose'</span>]
1862:     <span class="ruby-identifier">cf_task_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'task purpose'</span>]
1863:     <span class="ruby-identifier">cf_salesman</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'salesman_ref'</span>]
1864:     <span class="ruby-identifier">cf_quotation_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation date'</span>]
1865:     <span class="ruby-identifier">cf_po_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po date'</span>]
1866:     <span class="ruby-identifier">cf_invoice_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice date'</span>]
1867:     <span class="ruby-identifier">cf_delivery_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery date'</span>]
1868:     <span class="ruby-identifier">cf_payment_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment date'</span>]
1869:     <span class="ruby-identifier">cf_quotation_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation amount'</span>]
1870:     <span class="ruby-identifier">cf_po_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po amount'</span>]
1871:     <span class="ruby-identifier">cf_invoice_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice amount'</span>]
1872:     <span class="ruby-identifier">cf_delivery_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery amount'</span>]
1873:     <span class="ruby-identifier">cf_payment_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment amount'</span>]
1874:     <span class="ruby-identifier">cf_login</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'login'</span>]
1875:     <span class="ruby-identifier">cf_rank</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'potential_rank_ref'</span>]
1876: 
1877:     <span class="ruby-identifier">action_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>]
1878:     <span class="ruby-identifier">task_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>]
1879:     <span class="ruby-identifier">business_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
1880: 
1881:     <span class="ruby-ivar">@result</span> = {} <span class="ruby-comment cmt">#Keep amount of all activity</span>
1882:     <span class="ruby-ivar">@total</span> = {} <span class="ruby-comment cmt">#Keep total amount of all activity</span>
1883:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
1884:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
1885:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
1886: 
1887:     <span class="ruby-identifier">all_ref</span> = <span class="ruby-identifier">gen_ref_values</span>([<span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>], [])
1888:     <span class="ruby-identifier">custrank_ref</span> = <span class="ruby-identifier">gen_ref_values</span>(<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_rank</span>.<span class="ruby-identifier">id</span>)
1889: 
1890:     <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
1891:       <span class="ruby-identifier">product_type</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
1892:       <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>] <span class="ruby-operator">||=</span>{}
1893:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>] <span class="ruby-operator">||=</span>{}
1894:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
1895:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
1896:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
1897: 
1898:       <span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span>
1899:         <span class="ruby-identifier">b_descr</span> = <span class="ruby-identifier">b</span>.<span class="ruby-identifier">description</span>
1900:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>] <span class="ruby-operator">||=</span>{}
1901:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>] <span class="ruby-operator">||=</span>{}
1902:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
1903:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
1904:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
1905: 
1906:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
1907:           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
1908:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.value like ? and cells.field_id = ? and rows.screen_id = ?&quot;</span>, <span class="ruby-node">&quot;%#{b.id.to_s}%&quot;</span>, <span class="ruby-identifier">cf_branch</span>.<span class="ruby-identifier">id</span> , <span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>])
1909:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">cf_branch</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">value</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">compact</span>
1910:         <span class="ruby-identifier">row_ids</span> = []
1911:         <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">id</span>}
1912:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
1913:           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
1914:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.value != '' and cells.field_id = ? and rows.screen_id = ? and rows.id in (?)&quot;</span>, <span class="ruby-identifier">cf_login</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">row_ids</span>])
1915:         <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fs</span><span class="ruby-operator">|</span>
1916:           <span class="ruby-identifier">sales_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">fs</span>.<span class="ruby-identifier">id</span>]
1917:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>] <span class="ruby-operator">||=</span>{}
1918: 
1919:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>] <span class="ruby-operator">||=</span>{}
1920:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
1921:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
1922:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
1923: 
1924:           <span class="ruby-comment cmt"># ----- Potential Rank ------</span>
1925:           <span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
1926:             <span class="ruby-identifier">rank_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>]
1927:             <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
1928:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
1929:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
1930:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
1931:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
1932:           <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Potential Rank</span>
1933:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of sales_rows.each</span>
1934:       <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End @branch_screen.rows.each</span>
1935:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
1936: 
1937:     <span class="ruby-comment cmt"># ------ Action ------</span>
1938:     <span class="ruby-identifier">action_rows</span> = <span class="ruby-identifier">get_action_rows</span>(<span class="ruby-identifier">action_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)[<span class="ruby-value">0</span>]
1939: 
1940:     <span class="ruby-identifier">a_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">action_rows</span>, <span class="ruby-identifier">action_field_ids</span>)
1941: 
1942:     <span class="ruby-identifier">action_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fa</span><span class="ruby-operator">|</span>
1943:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1944:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1945:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1946: 
1947:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
1948:       <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">salesman_id</span>, <span class="ruby-identifier">all_ref</span>, <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>], <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>])
1949:       <span class="ruby-identifier">salesman</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">salesman_id</span>]
1950: 
1951:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>].<span class="ruby-identifier">nil?</span>
1952: 
1953:       <span class="ruby-identifier">action_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>])
1954:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
1955:       <span class="ruby-identifier">customer_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">customer_id</span>]
1956: 
1957:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1958:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
1959:       <span class="ruby-keyword kw">else</span>
1960:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">action_type_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
1961:       <span class="ruby-keyword kw">end</span>
1962: 
1963:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Visit&quot;</span>
1964:         <span class="ruby-identifier">visit_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>])
1965:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">visit_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1966:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Routine&quot;</span>
1967:         <span class="ruby-keyword kw">else</span>
1968:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">visit_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
1969:         <span class="ruby-keyword kw">end</span>
1970:       <span class="ruby-keyword kw">end</span>
1971: 
1972:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>].<span class="ruby-identifier">nil?</span>
1973:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
1974:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
1975:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
1976:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
1977:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
1978:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
1979:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
1980:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
1981:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
1982:       <span class="ruby-keyword kw">end</span>
1983: 
1984:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>].<span class="ruby-identifier">nil?</span>
1985:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
1986:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
1987:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
1988:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
1989:       <span class="ruby-keyword kw">end</span>
1990: 
1991:       <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:action</span>, <span class="ruby-identifier">action_type_name</span>)
1992: 
1993:       <span class="ruby-comment cmt"># ------ Task ------</span>
1994:       <span class="ruby-identifier">task_rows</span> =  <span class="ruby-identifier">fa</span>.<span class="ruby-identifier">detail_rows</span>
1995: 
1996:       <span class="ruby-identifier">t_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">task_rows</span>, <span class="ruby-identifier">task_field_ids</span>)
1997:       <span class="ruby-identifier">task_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ft</span><span class="ruby-operator">|</span>
1998:         <span class="ruby-identifier">task_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">RadioButton</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">t_rows</span>[<span class="ruby-identifier">ft</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>])
1999:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2000:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
2001:         <span class="ruby-keyword kw">else</span>
2002:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">task_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2003:         <span class="ruby-keyword kw">end</span>
2004:         
2005:         <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>, <span class="ruby-identifier">branch</span>, <span class="ruby-identifier">salesman</span>, <span class="ruby-identifier">customer_rank</span>, <span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">action_type_name</span>)
2006:       <span class="ruby-keyword kw">end</span>
2007:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of @action_screen.rows.each</span>
2008:     <span class="ruby-comment cmt"># ------ Business Record ------</span>
2009:     <span class="ruby-identifier">row_ids</span> = []
2010:     <span class="ruby-identifier">sql_head</span> = <span class="ruby-value str">&quot;SELECT rows.* FROM rows INNER JOIN CELLS on rows.id = cells.row_id WHERE (rows.screen_id = &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; AND (cells.field_id = &quot;</span>
2011:     <span class="ruby-identifier">sql_last</span> = <span class="ruby-value str">&quot; and cells.value between '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_from</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;' and '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_to</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;'))&quot;</span>
2012:     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2013:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2014:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2015:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2016:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
2017: 
2018:     <span class="ruby-identifier">business_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-identifier">sql</span>)
2019:     <span class="ruby-identifier">brows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">business_rows</span>, <span class="ruby-identifier">business_field_ids</span>)
2020: 
2021:     <span class="ruby-identifier">business_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fb</span><span class="ruby-operator">|</span>
2022: 
2023:       <span class="ruby-identifier">issue</span> = <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>]
2024: 
2025:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2026:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2027:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2028: 
2029:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
2030:       <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">salesman_id</span>, <span class="ruby-identifier">all_ref</span>, <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>], <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>])
2031:       <span class="ruby-identifier">salesman</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">salesman_id</span>]
2032: 
2033:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>].<span class="ruby-identifier">nil?</span>
2034: 
2035:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
2036:       <span class="ruby-identifier">customer_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">customer_id</span>]
2037: 
2038:       <span class="ruby-identifier">br_date</span> = []
2039:       <span class="ruby-identifier">br_amount</span> = []
2040:       <span class="ruby-identifier">br_name</span> = [<span class="ruby-value str">&quot;Quotation&quot;</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-value str">&quot;Invoice&quot;</span>,<span class="ruby-value str">&quot;Payment&quot;</span>]
2041:       <span class="ruby-identifier">br_count</span> = [<span class="ruby-value str">&quot;Quotation_count&quot;</span>,<span class="ruby-value str">&quot;P/O_count&quot;</span>,<span class="ruby-value str">&quot;Delivery_count&quot;</span>,<span class="ruby-value str">&quot;Invoice_count&quot;</span>,<span class="ruby-value str">&quot;Payment_count&quot;</span>]
2042: 
2043:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>]
2044:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>]
2045:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>]
2046:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>]
2047:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>]
2048: 
2049:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>]
2050:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>]
2051:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>]
2052:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>]
2053:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
2054: 
2055:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>].<span class="ruby-identifier">nil?</span>
2056:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
2057:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
2058:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2059:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2060:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2061:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
2062:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2063:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2064:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2065:       <span class="ruby-keyword kw">end</span>
2066: 
2067:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>].<span class="ruby-identifier">nil?</span>
2068:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
2069:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2070:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2071:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2072:       <span class="ruby-keyword kw">end</span>
2073: 
2074:       <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
2075:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">br_name</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
2076:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Quotation&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">issue_state</span>(<span class="ruby-identifier">issue</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">:cancelled</span>)
2077:         <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@date_from</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@date_to</span>))
2078:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>], <span class="ruby-identifier">br_amount</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">to_f</span>, <span class="ruby-value">0</span><span class="ruby-value">.0</span>)
2079:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_count</span>[<span class="ruby-identifier">i</span>])
2080:         <span class="ruby-keyword kw">end</span>
2081:       <span class="ruby-keyword kw">end</span>
2082:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of business record</span>
2083:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>
2084:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000594" class="method-detail">
        <a name="M000594"></a>

        <div class="method-heading">
          <a href="#M000594" class="method-signature">
          <span class="method-name">action_daily_type2_4</span><span class="method-args">(date_from, date_to)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000594-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000594-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 3071</span>
3071:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">action_daily_type2_4</span>(<span class="ruby-identifier">date_from</span>, <span class="ruby-identifier">date_to</span>)
3072:     <span class="ruby-comment cmt">#Product Type -&gt; Sales Office -&gt; Salesman -&gt; Potential Rank</span>
3073:     <span class="ruby-ivar">@date_from</span> = <span class="ruby-identifier">date_from</span>
3074:     <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">date_to</span>
3075:     <span class="ruby-identifier">screen_all</span> = <span class="ruby-identifier">get_all_screen</span>
3076:     <span class="ruby-identifier">cf_all</span> = <span class="ruby-identifier">get_all_customfield</span>
3077:     <span class="ruby-comment cmt">#Branch</span>
3078:     <span class="ruby-identifier">branch_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'sales office'</span>]
3079: 
3080:     <span class="ruby-comment cmt">#Staff</span>
3081:     <span class="ruby-identifier">sales_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>]
3082: 
3083:     <span class="ruby-comment cmt">#Action</span>
3084:     <span class="ruby-identifier">action_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'action_revision'</span>]
3085: 
3086:     <span class="ruby-comment cmt">#Task</span>
3087:     <span class="ruby-identifier">task_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'task_detail'</span>]
3088: 
3089:     <span class="ruby-comment cmt">#Business Record</span>
3090:     <span class="ruby-identifier">business_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'business record'</span>]
3091: 
3092:     <span class="ruby-comment cmt">#Product Type</span>
3093:     <span class="ruby-identifier">product_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'product_type'</span>]
3094:     
3095:     <span class="ruby-comment cmt">#Customer</span>
3096:     <span class="ruby-identifier">customer_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'customer'</span>]
3097: 
3098:     <span class="ruby-identifier">cf_branch</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>]
3099:     <span class="ruby-identifier">cf_product_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'production_type_ref'</span>]
3100:     <span class="ruby-identifier">cf_customer</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'customer_ref'</span>]
3101:     <span class="ruby-identifier">cf_issue_tracking</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'issue tracking'</span>]
3102:     <span class="ruby-identifier">cf_action_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'action type'</span>]
3103:     <span class="ruby-identifier">cf_visit_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'visit purpose'</span>]
3104:     <span class="ruby-identifier">cf_task_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'task purpose'</span>]
3105:     <span class="ruby-identifier">cf_salesman</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'salesman_ref'</span>]
3106:     <span class="ruby-identifier">cf_quotation_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation date'</span>]
3107:     <span class="ruby-identifier">cf_po_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po date'</span>]
3108:     <span class="ruby-identifier">cf_invoice_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice date'</span>]
3109:     <span class="ruby-identifier">cf_delivery_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery date'</span>]
3110:     <span class="ruby-identifier">cf_payment_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment date'</span>]
3111:     <span class="ruby-identifier">cf_quotation_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation amount'</span>]
3112:     <span class="ruby-identifier">cf_po_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po amount'</span>]
3113:     <span class="ruby-identifier">cf_invoice_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice amount'</span>]
3114:     <span class="ruby-identifier">cf_delivery_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery amount'</span>]
3115:     <span class="ruby-identifier">cf_payment_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment amount'</span>]
3116:     <span class="ruby-identifier">cf_login</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'login'</span>]
3117:     <span class="ruby-identifier">cf_firstpo</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'first p/o'</span>]
3118: 
3119:     <span class="ruby-identifier">action_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>]
3120:     <span class="ruby-identifier">task_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>]
3121:     <span class="ruby-identifier">business_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
3122: 
3123:     <span class="ruby-ivar">@result</span> = {} <span class="ruby-comment cmt">#Keep amount of all activity</span>
3124:     <span class="ruby-ivar">@total</span> = {} <span class="ruby-comment cmt">#Keep total amount of all activity</span>
3125:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3126:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3127:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3128: 
3129:     <span class="ruby-identifier">all_ref</span> = <span class="ruby-identifier">gen_ref_values</span>([<span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>], [])
3130:     <span class="ruby-identifier">custnew_ref</span> = <span class="ruby-identifier">gen_ref_values</span>(<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_firstpo</span>.<span class="ruby-identifier">id</span>)
3131: 
3132:     <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
3133:       <span class="ruby-identifier">product_type</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
3134:       <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>] <span class="ruby-operator">||=</span>{}
3135:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>] <span class="ruby-operator">||=</span>{}
3136:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3137:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3138:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3139: 
3140:       <span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span>
3141:         <span class="ruby-identifier">b_descr</span> = <span class="ruby-identifier">b</span>.<span class="ruby-identifier">description</span>
3142:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>] <span class="ruby-operator">||=</span>{}
3143:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>] <span class="ruby-operator">||=</span>{}
3144:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3145:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3146:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3147: 
3148:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
3149:           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
3150:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.value like ? and cells.field_id = ? and rows.screen_id = ?&quot;</span>, <span class="ruby-node">&quot;%#{b.id.to_s}%&quot;</span>, <span class="ruby-identifier">cf_branch</span>.<span class="ruby-identifier">id</span> , <span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>])
3151:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">cf_branch</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">value</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">compact</span>
3152:         <span class="ruby-identifier">row_ids</span> = []
3153:         <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">id</span>}
3154:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
3155:           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
3156:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.value != '' and cells.field_id = ? and rows.screen_id = ? and rows.id in (?)&quot;</span>, <span class="ruby-identifier">cf_login</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">row_ids</span>])
3157:         <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fs</span><span class="ruby-operator">|</span>
3158:           <span class="ruby-identifier">sales_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">fs</span>.<span class="ruby-identifier">id</span>]
3159:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>] <span class="ruby-operator">||=</span>{}
3160: 
3161:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>] <span class="ruby-operator">||=</span>{}
3162:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3163:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3164:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3165: 
3166:           <span class="ruby-comment cmt"># ----- Type New/Existing ------</span>
3167:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;Existing&quot;</span>] <span class="ruby-operator">||=</span>{}
3168:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;Existing&quot;</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3169:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;Existing&quot;</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3170:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;Existing&quot;</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3171:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;Existing&quot;</span>] <span class="ruby-operator">||=</span>{}
3172:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;Existing&quot;</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3173:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;Existing&quot;</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3174:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;Existing&quot;</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3175: 
3176:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;New&quot;</span>] <span class="ruby-operator">||=</span>{}
3177:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;New&quot;</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3178:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;New&quot;</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3179:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;New&quot;</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3180:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;New&quot;</span>] <span class="ruby-operator">||=</span>{}
3181:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;New&quot;</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3182:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;New&quot;</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3183:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;New&quot;</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3184: 
3185:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of sales_rows.each</span>
3186:       <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End @branch_screen.rows.each</span>
3187:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
3188: 
3189:     <span class="ruby-comment cmt"># ------ Action ------</span>
3190:     <span class="ruby-identifier">action_rows</span> = <span class="ruby-identifier">get_action_rows</span>(<span class="ruby-identifier">action_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)[<span class="ruby-value">0</span>]
3191: 
3192:     <span class="ruby-identifier">a_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">action_rows</span>, <span class="ruby-identifier">action_field_ids</span>)
3193: 
3194:     <span class="ruby-identifier">action_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fa</span><span class="ruby-operator">|</span>
3195:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3196:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3197:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3198: 
3199:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
3200:       <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">salesman_id</span>, <span class="ruby-identifier">all_ref</span>, <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>], <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>])
3201:       <span class="ruby-identifier">salesman</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">salesman_id</span>]
3202: 
3203:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>].<span class="ruby-identifier">nil?</span>
3204: 
3205:       <span class="ruby-identifier">action_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>])
3206:       <span class="ruby-identifier">firstpo</span> = <span class="ruby-identifier">custnew_ref</span>[<span class="ruby-identifier">customer_id</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;&quot;</span>
3207:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">cust_new</span>(<span class="ruby-identifier">firstpo</span>, <span class="ruby-ivar">@date_from</span>)
3208: 
3209:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3210:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
3211:       <span class="ruby-keyword kw">else</span>
3212:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">action_type_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
3213:       <span class="ruby-keyword kw">end</span>
3214: 
3215:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Visit&quot;</span>
3216:         <span class="ruby-identifier">visit_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>])
3217:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">visit_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3218:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Routine&quot;</span>
3219:         <span class="ruby-keyword kw">else</span>
3220:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">visit_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
3221:         <span class="ruby-keyword kw">end</span>
3222:       <span class="ruby-keyword kw">end</span>
3223: 
3224:       <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>], <span class="ruby-identifier">:action</span>, <span class="ruby-identifier">action_type_name</span>)
3225:       
3226:       <span class="ruby-comment cmt"># ------ Task ------</span>
3227:       <span class="ruby-identifier">task_rows</span> = <span class="ruby-identifier">fa</span>.<span class="ruby-identifier">detail_rows</span>
3228: 
3229:       <span class="ruby-identifier">t_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">task_rows</span>, <span class="ruby-identifier">task_field_ids</span>)
3230:       <span class="ruby-identifier">task_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ft</span><span class="ruby-operator">|</span>
3231:         <span class="ruby-identifier">task_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">RadioButton</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">t_rows</span>[<span class="ruby-identifier">ft</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>])
3232:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3233:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
3234:         <span class="ruby-keyword kw">else</span>
3235:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">task_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
3236:         <span class="ruby-keyword kw">end</span>
3237: 
3238:         <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>], <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">action_type_name</span>)
3239:       <span class="ruby-keyword kw">end</span>
3240:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of @action_screen.rows.each</span>
3241:     <span class="ruby-comment cmt"># ------ Business Record ------</span>
3242:     <span class="ruby-identifier">row_ids</span> = []
3243:     <span class="ruby-identifier">sql_head</span> = <span class="ruby-value str">&quot;SELECT rows.* FROM rows INNER JOIN CELLS on rows.id = cells.row_id WHERE (rows.screen_id = &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; AND (cells.field_id = &quot;</span>
3244:     <span class="ruby-identifier">sql_last</span> = <span class="ruby-value str">&quot; and cells.value between '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_from</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;' and '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_to</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;'))&quot;</span>
3245:     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3246:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3247:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3248:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3249:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3250: 
3251:     <span class="ruby-identifier">business_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-identifier">sql</span>)
3252:     <span class="ruby-identifier">brows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">business_rows</span>, <span class="ruby-identifier">business_field_ids</span>)
3253:     <span class="ruby-identifier">business_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fb</span><span class="ruby-operator">|</span>
3254:       <span class="ruby-identifier">issue</span> = <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>]
3255: 
3256:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3257:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3258:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3259:       
3260:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
3261:       <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">salesman_id</span>, <span class="ruby-identifier">all_ref</span>, <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>], <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>])
3262:       <span class="ruby-identifier">salesman</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">salesman_id</span>]
3263: 
3264:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>].<span class="ruby-identifier">nil?</span>
3265: 
3266:       <span class="ruby-identifier">firstpo</span> = <span class="ruby-identifier">custnew_ref</span>[<span class="ruby-identifier">customer_id</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;&quot;</span>
3267:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">cust_new</span>(<span class="ruby-identifier">firstpo</span>, <span class="ruby-ivar">@date_from</span>)
3268: 
3269:       <span class="ruby-identifier">br_date</span> = []
3270:       <span class="ruby-identifier">br_amount</span> = []
3271:       <span class="ruby-identifier">br_name</span> = [<span class="ruby-value str">&quot;Quotation&quot;</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-value str">&quot;Invoice&quot;</span>,<span class="ruby-value str">&quot;Payment&quot;</span>]
3272:       <span class="ruby-identifier">br_count</span> = [<span class="ruby-value str">&quot;Quotation_count&quot;</span>,<span class="ruby-value str">&quot;P/O_count&quot;</span>,<span class="ruby-value str">&quot;Delivery_count&quot;</span>,<span class="ruby-value str">&quot;Invoice_count&quot;</span>,<span class="ruby-value str">&quot;Payment_count&quot;</span>]
3273: 
3274:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>]
3275:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>]
3276:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>]
3277:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>]
3278:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>]
3279: 
3280:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>]
3281:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>]
3282:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>]
3283:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>]
3284:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
3285: 
3286:       <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
3287:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">br_name</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
3288:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Quotation&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">issue_state</span>(<span class="ruby-identifier">issue</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">:cancelled</span>)
3289:         <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@date_from</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@date_to</span>))
3290:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>], <span class="ruby-identifier">br_amount</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">to_f</span>, <span class="ruby-value">0</span><span class="ruby-value">.0</span>)
3291:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_count</span>[<span class="ruby-identifier">i</span>])
3292:         <span class="ruby-keyword kw">end</span>
3293:       <span class="ruby-keyword kw">end</span>
3294:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of business record</span>
3295:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>
3296:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000593" class="method-detail">
        <a name="M000593"></a>

        <div class="method-heading">
          <a href="#M000593" class="method-signature">
          <span class="method-name">action_daily_type2_5</span><span class="method-args">(date_from, date_to)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000593-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000593-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 2837</span>
2837:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">action_daily_type2_5</span>(<span class="ruby-identifier">date_from</span>, <span class="ruby-identifier">date_to</span>)
2838:     <span class="ruby-comment cmt">#Product Type -&gt; Sales Office -&gt; Salesman -&gt; Potential Rank -&gt; Customer</span>
2839:     <span class="ruby-ivar">@date_from</span> = <span class="ruby-identifier">date_from</span>
2840:     <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">date_to</span>
2841:     <span class="ruby-identifier">screen_all</span> = <span class="ruby-identifier">get_all_screen</span>
2842:     <span class="ruby-identifier">cf_all</span> = <span class="ruby-identifier">get_all_customfield</span>
2843:     <span class="ruby-comment cmt">#Branch</span>
2844:     <span class="ruby-identifier">branch_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'sales office'</span>]
2845: 
2846:     <span class="ruby-comment cmt">#Staff</span>
2847:     <span class="ruby-identifier">sales_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>]
2848: 
2849:     <span class="ruby-comment cmt">#Action</span>
2850:     <span class="ruby-identifier">action_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'action_revision'</span>]
2851: 
2852:     <span class="ruby-comment cmt">#Task</span>
2853:     <span class="ruby-identifier">task_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'task_detail'</span>]
2854: 
2855:     <span class="ruby-comment cmt">#Business Record</span>
2856:     <span class="ruby-identifier">business_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'business record'</span>]
2857: 
2858:     <span class="ruby-comment cmt">#Product Type</span>
2859:     <span class="ruby-identifier">product_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'product_type'</span>]
2860: 
2861:     <span class="ruby-comment cmt">#Customer</span>
2862:     <span class="ruby-identifier">customer_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'customer'</span>]
2863: 
2864:     <span class="ruby-identifier">cf_branch</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>]
2865:     <span class="ruby-identifier">cf_product_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'production_type_ref'</span>]
2866:     <span class="ruby-identifier">cf_customer</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'customer_ref'</span>]
2867:     <span class="ruby-identifier">cf_issue_tracking</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'issue tracking'</span>]
2868:     <span class="ruby-identifier">cf_action_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'action type'</span>]
2869:     <span class="ruby-identifier">cf_visit_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'visit purpose'</span>]
2870:     <span class="ruby-identifier">cf_task_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'task purpose'</span>]
2871:     <span class="ruby-identifier">cf_salesman</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'salesman_ref'</span>]
2872:     <span class="ruby-identifier">cf_quotation_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation date'</span>]
2873:     <span class="ruby-identifier">cf_po_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po date'</span>]
2874:     <span class="ruby-identifier">cf_invoice_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice date'</span>]
2875:     <span class="ruby-identifier">cf_delivery_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery date'</span>]
2876:     <span class="ruby-identifier">cf_payment_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment date'</span>]
2877:     <span class="ruby-identifier">cf_quotation_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'quotation amount'</span>]
2878:     <span class="ruby-identifier">cf_po_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po amount'</span>]
2879:     <span class="ruby-identifier">cf_invoice_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'invoice amount'</span>]
2880:     <span class="ruby-identifier">cf_delivery_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'delivery amount'</span>]
2881:     <span class="ruby-identifier">cf_payment_amount</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'payment amount'</span>]
2882:     <span class="ruby-identifier">cf_login</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'login'</span>]
2883:     <span class="ruby-identifier">cf_firstpo</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'first p/o'</span>]
2884: 
2885:     <span class="ruby-identifier">action_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>]
2886:     <span class="ruby-identifier">task_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>]
2887:     <span class="ruby-identifier">business_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
2888: 
2889:     <span class="ruby-ivar">@result</span> = {} <span class="ruby-comment cmt">#Keep amount of all activity</span>
2890:     <span class="ruby-ivar">@total</span> = {} <span class="ruby-comment cmt">#Keep total amount of all activity</span>
2891:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2892:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2893:     <span class="ruby-ivar">@total</span>[<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2894: 
2895:     <span class="ruby-identifier">all_ref</span> = <span class="ruby-identifier">gen_ref_values</span>([<span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>], [])
2896:     <span class="ruby-identifier">custnew_ref</span> = <span class="ruby-identifier">gen_ref_values</span>(<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_firstpo</span>.<span class="ruby-identifier">id</span>)
2897: 
2898:     <span class="ruby-identifier">product_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
2899:       <span class="ruby-identifier">product_type</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>]
2900:       <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>] <span class="ruby-operator">||=</span>{}
2901:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>] <span class="ruby-operator">||=</span>{}
2902:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2903:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2904:       <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2905: 
2906:       <span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span>
2907:         <span class="ruby-identifier">b_descr</span> = <span class="ruby-identifier">b</span>.<span class="ruby-identifier">description</span>
2908:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>] <span class="ruby-operator">||=</span>{}
2909:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>] <span class="ruby-operator">||=</span>{}
2910:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2911:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2912:         <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2913: 
2914:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
2915:           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
2916:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.value like ? and cells.field_id = ? and rows.screen_id = ?&quot;</span>, <span class="ruby-node">&quot;%#{b.id.to_s}%&quot;</span>, <span class="ruby-identifier">cf_branch</span>.<span class="ruby-identifier">id</span> , <span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>])
2917:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">cf_branch</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">value</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">compact</span>
2918:         <span class="ruby-identifier">row_ids</span> = []
2919:         <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">id</span>}
2920:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
2921:           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
2922:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.value != '' and cells.field_id = ? and rows.screen_id = ? and rows.id in (?)&quot;</span>, <span class="ruby-identifier">cf_login</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">row_ids</span>])
2923:         <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fs</span><span class="ruby-operator">|</span>
2924:           <span class="ruby-identifier">sales_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">fs</span>.<span class="ruby-identifier">id</span>]
2925:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>] <span class="ruby-operator">||=</span>{}
2926: 
2927:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>] <span class="ruby-operator">||=</span>{}
2928:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2929:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2930:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2931: 
2932:           <span class="ruby-comment cmt"># ----- Type New/Existing ------</span>
2933:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;Existing&quot;</span>] <span class="ruby-operator">||=</span>{}
2934:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;Existing&quot;</span>] <span class="ruby-operator">||=</span>{}
2935:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;Existing&quot;</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2936:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;Existing&quot;</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2937:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;Existing&quot;</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2938: 
2939:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;New&quot;</span>] <span class="ruby-operator">||=</span>{}
2940:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;New&quot;</span>] <span class="ruby-operator">||=</span>{}
2941:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;New&quot;</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2942:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;New&quot;</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2943:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">product_type</span>][<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-value str">&quot;New&quot;</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}        <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of sales_rows.each</span>
2944:       <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End @branch_screen.rows.each</span>
2945:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Product Type Screen</span>
2946: 
2947:     <span class="ruby-comment cmt"># ------ Action ------</span>
2948:     <span class="ruby-identifier">action_rows</span> = <span class="ruby-identifier">get_action_rows</span>(<span class="ruby-identifier">action_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@date_from</span>, <span class="ruby-ivar">@date_to</span>)[<span class="ruby-value">0</span>]
2949: 
2950:     <span class="ruby-identifier">a_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">action_rows</span>, <span class="ruby-identifier">action_field_ids</span>)
2951: 
2952:     <span class="ruby-identifier">action_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fa</span><span class="ruby-operator">|</span>
2953:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2954:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2955:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2956: 
2957:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
2958:       <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">salesman_id</span>, <span class="ruby-identifier">all_ref</span>, <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>], <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>])
2959:       <span class="ruby-identifier">salesman</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">salesman_id</span>]
2960: 
2961:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>].<span class="ruby-identifier">nil?</span>
2962: 
2963:       <span class="ruby-identifier">action_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>])
2964:       <span class="ruby-identifier">firstpo</span> = <span class="ruby-identifier">custnew_ref</span>[<span class="ruby-identifier">customer_id</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;&quot;</span>
2965:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">cust_new</span>(<span class="ruby-identifier">firstpo</span>, <span class="ruby-ivar">@date_from</span>)
2966:       <span class="ruby-identifier">customer_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">customer_id</span>]
2967: 
2968:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2969:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
2970:       <span class="ruby-keyword kw">else</span>
2971:         <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">action_type_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2972:       <span class="ruby-keyword kw">end</span>
2973: 
2974:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Visit&quot;</span>
2975:         <span class="ruby-identifier">visit_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>])
2976:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">visit_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2977:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Routine&quot;</span>
2978:         <span class="ruby-keyword kw">else</span>
2979:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">visit_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
2980:         <span class="ruby-keyword kw">end</span>
2981:       <span class="ruby-keyword kw">end</span>
2982: 
2983:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>].<span class="ruby-identifier">nil?</span>
2984:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
2985:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
2986:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
2987:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
2988:       <span class="ruby-keyword kw">end</span>
2989: 
2990:       <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:action</span>, <span class="ruby-identifier">action_type_name</span>)
2991: 
2992:       <span class="ruby-comment cmt"># ------ Task ------</span>
2993:       <span class="ruby-identifier">task_rows</span> = <span class="ruby-identifier">fa</span>.<span class="ruby-identifier">detail_rows</span>
2994: 
2995:       <span class="ruby-identifier">t_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">task_rows</span>, <span class="ruby-identifier">task_field_ids</span>)
2996:       <span class="ruby-identifier">task_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ft</span><span class="ruby-operator">|</span>
2997:         <span class="ruby-identifier">task_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">RadioButton</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">t_rows</span>[<span class="ruby-identifier">ft</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_task_purpose</span>.<span class="ruby-identifier">id</span>])
2998:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
2999:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
3000:         <span class="ruby-keyword kw">else</span>
3001:           <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">task_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
3002:         <span class="ruby-keyword kw">end</span>
3003: 
3004:         <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">action_type_name</span>)
3005:       <span class="ruby-keyword kw">end</span>
3006:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of @action_screen.rows.each</span>
3007:     <span class="ruby-comment cmt"># ------ Business Record ------</span>
3008:     <span class="ruby-identifier">row_ids</span> = []
3009:     <span class="ruby-identifier">sql_head</span> = <span class="ruby-value str">&quot;SELECT rows.* FROM rows INNER JOIN CELLS on rows.id = cells.row_id WHERE (rows.screen_id = &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; AND (cells.field_id = &quot;</span>
3010:     <span class="ruby-identifier">sql_last</span> = <span class="ruby-value str">&quot; and cells.value between '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_from</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;' and '&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@date_to</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;'))&quot;</span>
3011:     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3012:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3013:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3014:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3015:     <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; union &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_head</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sql_last</span>
3016: 
3017:     <span class="ruby-identifier">business_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-identifier">sql</span>)
3018:     <span class="ruby-identifier">brows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">business_rows</span>, <span class="ruby-identifier">business_field_ids</span>)
3019:     <span class="ruby-identifier">business_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fb</span><span class="ruby-operator">|</span>
3020:       <span class="ruby-identifier">issue</span> = <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>]
3021: 
3022:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3023:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3024:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_product_type</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
3025:       
3026:       <span class="ruby-identifier">ptype</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">product_type_id</span>]
3027:       <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">salesman_id</span>, <span class="ruby-identifier">all_ref</span>, <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>], <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>])
3028:       <span class="ruby-identifier">salesman</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">salesman_id</span>]
3029: 
3030:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>].<span class="ruby-identifier">nil?</span>
3031: 
3032:       <span class="ruby-identifier">firstpo</span> = <span class="ruby-identifier">custnew_ref</span>[<span class="ruby-identifier">customer_id</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;&quot;</span>
3033:       <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">cust_new</span>(<span class="ruby-identifier">firstpo</span>, <span class="ruby-ivar">@date_from</span>)
3034:       <span class="ruby-identifier">customer_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">customer_id</span>]
3035: 
3036:       <span class="ruby-identifier">br_date</span> = []
3037:       <span class="ruby-identifier">br_amount</span> = []
3038:       <span class="ruby-identifier">br_name</span> = [<span class="ruby-value str">&quot;Quotation&quot;</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-value str">&quot;Invoice&quot;</span>,<span class="ruby-value str">&quot;Payment&quot;</span>]
3039:       <span class="ruby-identifier">br_count</span> = [<span class="ruby-value str">&quot;Quotation_count&quot;</span>,<span class="ruby-value str">&quot;P/O_count&quot;</span>,<span class="ruby-value str">&quot;Delivery_count&quot;</span>,<span class="ruby-value str">&quot;Invoice_count&quot;</span>,<span class="ruby-value str">&quot;Payment_count&quot;</span>]
3040: 
3041:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>]
3042:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>]
3043:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_date</span>.<span class="ruby-identifier">id</span>]
3044:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>]
3045:       <span class="ruby-identifier">br_date</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_date</span>.<span class="ruby-identifier">id</span>]
3046: 
3047:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_quotation_amount</span>.<span class="ruby-identifier">id</span>]
3048:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_amount</span>.<span class="ruby-identifier">id</span>]
3049:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_delivery_amount</span>.<span class="ruby-identifier">id</span>]
3050:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_invoice_amount</span>.<span class="ruby-identifier">id</span>]
3051:       <span class="ruby-identifier">br_amount</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_payment_amount</span>.<span class="ruby-identifier">id</span>]
3052: 
3053:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>].<span class="ruby-identifier">nil?</span>
3054:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>] <span class="ruby-operator">||=</span>{}
3055:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">||=</span>{}
3056:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;task&quot;</span>] <span class="ruby-operator">||=</span>{}
3057:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">ptype</span>][<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">customer_name</span>][<span class="ruby-value str">&quot;business&quot;</span>] <span class="ruby-operator">||=</span>{}
3058:       <span class="ruby-keyword kw">end</span>
3059: 
3060:       <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
3061:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">br_name</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
3062:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Quotation&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">issue_state</span>(<span class="ruby-identifier">issue</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">:cancelled</span>)
3063:         <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@date_from</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">br_date</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@date_to</span>))
3064:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_name</span>[<span class="ruby-identifier">i</span>], <span class="ruby-identifier">br_amount</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">to_f</span>, <span class="ruby-value">0</span><span class="ruby-value">.0</span>)
3065:           <span class="ruby-identifier">increase_summarized_value</span>(<span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>, [<span class="ruby-identifier">ptype</span>,<span class="ruby-identifier">branch</span>,<span class="ruby-identifier">salesman</span>,<span class="ruby-identifier">customer_rank</span>,<span class="ruby-identifier">customer_name</span>], <span class="ruby-identifier">:business</span>, <span class="ruby-identifier">br_count</span>[<span class="ruby-identifier">i</span>])
3066:         <span class="ruby-keyword kw">end</span>
3067:       <span class="ruby-keyword kw">end</span>
3068:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of business record</span>
3069:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@result</span>, <span class="ruby-ivar">@total</span>
3070:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000556" class="method-detail">
        <a name="M000556"></a>

        <div class="method-heading">
          <a href="#M000556" class="method-signature">
          <span class="method-name">cache_hack</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000556-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000556-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 385</span>
385:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cache_hack</span>
386:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-value str">'HTTP_USER_AGENT'</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/msie/i</span>
387:                   <span class="ruby-identifier">headers</span>[<span class="ruby-value str">'Pragma'</span>] = <span class="ruby-value str">''</span>
388:                   <span class="ruby-identifier">headers</span>[<span class="ruby-value str">'Cache-Control'</span>] = <span class="ruby-value str">''</span>
389:           <span class="ruby-keyword kw">else</span>
390:                   <span class="ruby-identifier">headers</span>[<span class="ruby-value str">'Pragma'</span>] = <span class="ruby-value str">'no-cache'</span>
391:                   <span class="ruby-identifier">headers</span>[<span class="ruby-value str">'Cache-Control'</span>] = <span class="ruby-value str">'no-cache, must-revalidate'</span>
392:           <span class="ruby-keyword kw">end</span>
393:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000555" class="method-detail">
        <a name="M000555"></a>

        <div class="method-heading">
          <a href="#M000555" class="method-signature">
          <span class="method-name">clean_field_filters</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000555-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000555-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 373</span>
373:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">clean_field_filters</span>
374:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>].<span class="ruby-identifier">to_i</span>)
375: 
376:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">field_report_filters</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">frf</span><span class="ruby-operator">|</span>
377:       <span class="ruby-identifier">ref_screen</span> = <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screens</span>[<span class="ruby-identifier">frf</span>.<span class="ruby-identifier">reference_screen_index</span>]
378:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">ref_screen</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">ref_screen</span>.<span class="ruby-identifier">field</span>(<span class="ruby-identifier">frf</span>.<span class="ruby-identifier">field_id</span>).<span class="ruby-identifier">nil?</span>
379:         <span class="ruby-identifier">field_report_filter</span> = <span class="ruby-constant">FieldReportFilter</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">frf</span>.<span class="ruby-identifier">id</span>)
380:         <span class="ruby-identifier">field_report_filter</span>.<span class="ruby-identifier">destroy</span>
381:       <span class="ruby-keyword kw">end</span>
382:     }
383:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000574" class="method-detail">
        <a name="M000574"></a>

        <div class="method-heading">
          <a href="#M000574" class="method-signature">
          <span class="method-name">company_branch</span><span class="method-args">(id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000574-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000574-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1101</span>
1101:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">company_branch</span>(<span class="ruby-identifier">id</span>)
1102:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1103:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1104: 
1105:     <span class="ruby-comment cmt">#Salesman</span>
1106:     <span class="ruby-identifier">staff_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">&quot;name = 'staff'&quot;</span>)
1107:     <span class="ruby-identifier">staff_row</span> = <span class="ruby-identifier">staff_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_i</span>)
1108:     <span class="ruby-identifier">cf_company</span> = <span class="ruby-constant">CustomField</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;name = 'Sales_Office_REF'&quot;</span>)
1109:     <span class="ruby-identifier">result</span> = <span class="ruby-identifier">staff_row</span>.<span class="ruby-identifier">cells</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;field_id = ?&quot;</span>, <span class="ruby-identifier">cf_company</span>.<span class="ruby-identifier">id</span>]).<span class="ruby-identifier">value</span>
1110:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">retrieve_nonmulti_result</span>([<span class="ruby-identifier">result</span>])
1111:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000573" class="method-detail">
        <a name="M000573"></a>

        <div class="method-heading">
          <a href="#M000573" class="method-signature">
          <span class="method-name">company_branch_hash</span><span class="method-args">(id, branch_ref, staff_screen, cf_company)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000573-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000573-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1092</span>
1092:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">branch_ref</span>, <span class="ruby-identifier">staff_screen</span>, <span class="ruby-identifier">cf_company</span>)
1093:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1094:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1095: 
1096:     <span class="ruby-comment cmt">#Salesman</span>
1097:     <span class="ruby-identifier">staff_row</span> = <span class="ruby-identifier">staff_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_i</span>)
1098:     <span class="ruby-identifier">result</span> = <span class="ruby-identifier">staff_row</span>.<span class="ruby-identifier">cells</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;field_id = ?&quot;</span>, <span class="ruby-identifier">cf_company</span>.<span class="ruby-identifier">id</span>]).<span class="ruby-identifier">value</span>
1099:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">branch_ref</span>[<span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">result</span>)]
1100:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000575" class="method-detail">
        <a name="M000575"></a>

        <div class="method-heading">
          <a href="#M000575" class="method-signature">
          <span class="method-name">company_branch_id</span><span class="method-args">(id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000575-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000575-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1112</span>
1112:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">company_branch_id</span>(<span class="ruby-identifier">id</span>)
1113:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1114:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1115: 
1116:     <span class="ruby-comment cmt">#Salesman</span>
1117:     <span class="ruby-identifier">staff_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">&quot;name = 'staff'&quot;</span>)
1118:     <span class="ruby-identifier">staff_row</span> = <span class="ruby-identifier">staff_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_i</span>)
1119:     <span class="ruby-identifier">cf_company</span> = <span class="ruby-constant">CustomField</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;name = 'Sales_Office_REF'&quot;</span>)
1120:     <span class="ruby-identifier">result</span> = <span class="ruby-identifier">staff_row</span>.<span class="ruby-identifier">cells</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;field_id = ?&quot;</span>, <span class="ruby-identifier">cf_company</span>.<span class="ruby-identifier">id</span>]).<span class="ruby-identifier">value</span>
1121:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">result</span>
1122:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000603" class="method-detail">
        <a name="M000603"></a>

        <div class="method-heading">
          <a href="#M000603" class="method-signature">
          <span class="method-name">compare_action</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>==== Compare Action <a href="Report.html">Report</a> ==========</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000603-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000603-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 4664</span>
4664:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">compare_action</span>
4665:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
4666:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
4667: 
4668:     
4669:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000604" class="method-detail">
        <a name="M000604"></a>

        <div class="method-heading">
          <a href="#M000604" class="method-signature">
          <span class="method-name">compare_action_report</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000604-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000604-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 4671</span>
4671:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">compare_action_report</span>
4672:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
4673:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
4674:       
4675:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'export'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;yes&quot;</span>
4676:       <span class="ruby-identifier">screen_all</span> = <span class="ruby-identifier">get_all_screen</span>
4677:       <span class="ruby-identifier">cf_all</span> = <span class="ruby-identifier">get_all_customfield</span>
4678:       <span class="ruby-ivar">@screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">&quot;compare action report&quot;</span>]
4679:       <span class="ruby-ivar">@rpt_type</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:rpt_type</span>].<span class="ruby-identifier">to_i</span>
4680:       <span class="ruby-ivar">@date_from</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_from</span>]
4681:       <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_from</span>]
4682:       <span class="ruby-ivar">@loop</span> = <span class="ruby-value">6</span>
4683:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-comment cmt">#day</span>
4684:         <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_from</span>]
4685:         <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;Compare Daily Action&quot;</span>
4686:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-comment cmt">#week</span>
4687:         <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_from</span>]
4688:         <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;Compare Weekly Action&quot;</span>
4689:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span> <span class="ruby-comment cmt">#month</span>
4690:         <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_from</span>]
4691:         <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;Compare Monthly Action&quot;</span>
4692:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span> <span class="ruby-comment cmt">#year</span>
4693:         <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_from</span>]
4694:         <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;Compare Yearly Action&quot;</span>
4695:         <span class="ruby-ivar">@loop</span> = <span class="ruby-value">3</span>
4696:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">5</span> <span class="ruby-comment cmt">#quarter</span>
4697:         <span class="ruby-ivar">@date_to</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_from</span>]
4698:         <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;Compare Quarterly Action&quot;</span>
4699:         <span class="ruby-ivar">@loop</span> = <span class="ruby-value">4</span>
4700:       <span class="ruby-keyword kw">end</span>
4701:       <span class="ruby-comment cmt">#loop = 1</span>
4702:       <span class="ruby-identifier">nloop</span> = <span class="ruby-value">1</span>
4703:       <span class="ruby-ivar">@dfrom</span> = []
4704:       <span class="ruby-ivar">@dto</span> = []
4705: 
4706:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">nloop</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-ivar">@loop</span>
4707:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-comment cmt">#day</span>
4708:           <span class="ruby-ivar">@dfrom</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">||=</span>(<span class="ruby-ivar">@date_from</span>.<span class="ruby-identifier">to_date</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)).<span class="ruby-identifier">to_s</span>
4709:           <span class="ruby-ivar">@dto</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">||=</span>(<span class="ruby-ivar">@date_from</span>.<span class="ruby-identifier">to_date</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)).<span class="ruby-identifier">to_s</span>
4710:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-comment cmt">#week</span>
4711:           <span class="ruby-ivar">@dfrom</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">||=</span>(<span class="ruby-ivar">@date_from</span>.<span class="ruby-identifier">to_date</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">7</span>).<span class="ruby-identifier">to_s</span>
4712:           <span class="ruby-ivar">@dto</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">||=</span>(<span class="ruby-ivar">@date_from</span>.<span class="ruby-identifier">to_date</span> <span class="ruby-operator">+</span> <span class="ruby-value">6</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">7</span>).<span class="ruby-identifier">to_s</span>
4713:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span> <span class="ruby-comment cmt">#month</span>
4714:           <span class="ruby-identifier">month</span> = <span class="ruby-ivar">@date_from</span>.<span class="ruby-identifier">to_date</span>.<span class="ruby-identifier">month</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)
4715:           <span class="ruby-identifier">year</span> = <span class="ruby-ivar">@date_from</span>.<span class="ruby-identifier">to_date</span>.<span class="ruby-identifier">year</span>
4716:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">month</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
4717:             <span class="ruby-identifier">month</span> <span class="ruby-operator">+=</span> <span class="ruby-value">12</span>
4718:             <span class="ruby-identifier">year</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
4719:           <span class="ruby-keyword kw">end</span>
4720:           <span class="ruby-identifier">date1</span> = <span class="ruby-node">&quot;#{year.to_s}-#{month.to_s}-01&quot;</span>.<span class="ruby-identifier">to_date</span>.<span class="ruby-identifier">to_s</span>
4721: 
4722:           <span class="ruby-identifier">nextmonth</span> = <span class="ruby-identifier">month</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
4723:           <span class="ruby-identifier">nextyear</span> = <span class="ruby-identifier">year</span>
4724:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">nextmonth</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">12</span>
4725:             <span class="ruby-identifier">nextmonth</span> <span class="ruby-operator">-=</span> <span class="ruby-value">12</span>
4726:             <span class="ruby-identifier">nextyear</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4727:           <span class="ruby-keyword kw">end</span>
4728:           <span class="ruby-identifier">date2</span> = (<span class="ruby-node">&quot;#{nextyear.to_s}-#{nextmonth.to_s}-01&quot;</span>.<span class="ruby-identifier">to_date</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_s</span>
4729: 
4730:           <span class="ruby-ivar">@dfrom</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">||=</span><span class="ruby-identifier">date1</span>
4731:           <span class="ruby-ivar">@dto</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">||=</span><span class="ruby-identifier">date2</span>
4732:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span> <span class="ruby-comment cmt">#year</span>
4733:           <span class="ruby-identifier">year</span> = <span class="ruby-ivar">@date_from</span>.<span class="ruby-identifier">to_date</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)
4734:           <span class="ruby-ivar">@dfrom</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">||</span><span class="ruby-node">&quot;#{year.to_s}-03-01&quot;</span>.<span class="ruby-identifier">to_date</span>.<span class="ruby-identifier">to_s</span>
4735:           <span class="ruby-ivar">@dto</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">||=</span>(<span class="ruby-node">&quot;#{(year + 1).to_s}-03-01&quot;</span>.<span class="ruby-identifier">to_date</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_s</span>
4736:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">5</span> <span class="ruby-comment cmt">#quarter</span>
4737:           <span class="ruby-comment cmt">#Q1 = 2009/03/01 - 2009/05/31</span>
4738:           <span class="ruby-comment cmt">#Q2 = 2009/06/01 - 2009/08/31</span>
4739:           <span class="ruby-comment cmt">#Q3 = 2009/09/01 - 2009/11/30</span>
4740:           <span class="ruby-comment cmt">#Q4 = 2009/12/01 - 2010/02/28</span>
4741:           <span class="ruby-identifier">month</span> = (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">*</span> <span class="ruby-value">3</span>)
4742:           <span class="ruby-identifier">year</span> = <span class="ruby-ivar">@date_from</span>.<span class="ruby-identifier">to_date</span>.<span class="ruby-identifier">year</span>
4743:           <span class="ruby-identifier">day</span> = (<span class="ruby-identifier">month</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">month</span> <span class="ruby-operator">==</span> <span class="ruby-value">10</span>)<span class="ruby-operator">?</span> <span class="ruby-value str">&quot;31&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;30&quot;</span>
4744:           <span class="ruby-ivar">@dfrom</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;year.to_s-month.to_s-01&quot;</span>.<span class="ruby-identifier">to_date</span>.<span class="ruby-identifier">to_s</span>
4745:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">nloop</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span>
4746:             <span class="ruby-ivar">@dto</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">||=</span>(<span class="ruby-node">&quot;#{(year + 1).to_s}-03-01&quot;</span>.<span class="ruby-identifier">to_date</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_s</span>
4747:           <span class="ruby-keyword kw">else</span>
4748:             <span class="ruby-ivar">@dto</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">||=</span>(<span class="ruby-node">&quot;#{year.to_s}-#{(month + 3).to_s}-01&quot;</span>.<span class="ruby-identifier">to_date</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_s</span>
4749:           <span class="ruby-keyword kw">end</span>
4750: 
4751:         <span class="ruby-keyword kw">end</span>
4752:       <span class="ruby-keyword kw">end</span>
4753: 
4754:       <span class="ruby-comment cmt">#Branch</span>
4755:       <span class="ruby-identifier">branch_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'sales office'</span>]
4756: 
4757:       <span class="ruby-comment cmt">#Staff</span>
4758:       <span class="ruby-identifier">sales_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>]
4759: 
4760:       <span class="ruby-comment cmt">#Potential Rank</span>
4761:       <span class="ruby-identifier">rank_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'potential rank'</span>]
4762: 
4763:       <span class="ruby-comment cmt">#Action</span>
4764:       <span class="ruby-identifier">action_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'action_revision'</span>]
4765: 
4766:       <span class="ruby-comment cmt">#Business Record</span>
4767:       <span class="ruby-identifier">business_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'business record'</span>]
4768: 
4769:       <span class="ruby-comment cmt">#Customer</span>
4770:       <span class="ruby-identifier">customer_screen</span> = <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'customer'</span>]
4771: 
4772: 
4773:       <span class="ruby-identifier">cf_branch</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>]
4774:       <span class="ruby-identifier">cf_customer</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'customer_ref'</span>]
4775:       <span class="ruby-identifier">cf_issue_tracking</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'issue tracking'</span>]
4776:       <span class="ruby-identifier">cf_action_type</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'action type'</span>]
4777:       <span class="ruby-identifier">cf_visit_purpose</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'visit purpose'</span>]
4778:       <span class="ruby-identifier">cf_salesman</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'salesman_ref'</span>]
4779:       <span class="ruby-identifier">cf_po_date</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'po date'</span>]
4780:       <span class="ruby-identifier">cf_login</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'login'</span>]
4781:       <span class="ruby-identifier">cf_rank</span> = <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'potential_rank_ref'</span>]
4782: 
4783:       <span class="ruby-identifier">action_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>]
4784:       <span class="ruby-identifier">business_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>]
4785: 
4786:       <span class="ruby-identifier">all_ref</span> = <span class="ruby-identifier">gen_ref_values</span>([<span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">id</span>], [])
4787:       <span class="ruby-identifier">custrank_ref</span> = <span class="ruby-identifier">gen_ref_values</span>(<span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_rank</span>.<span class="ruby-identifier">id</span>)
4788: 
4789:       <span class="ruby-ivar">@result</span> = {} <span class="ruby-comment cmt">#Keep amount of all activity</span>
4790:       <span class="ruby-ivar">@total</span> = {} <span class="ruby-comment cmt">#Keep total amount of all activity</span>
4791:       <span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span>
4792:         <span class="ruby-identifier">branch_descr</span> = <span class="ruby-identifier">b</span>.<span class="ruby-identifier">description</span>
4793:         <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch_descr</span>] <span class="ruby-operator">||=</span>{}
4794:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
4795:           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
4796:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.value like ? and cells.field_id = ? and rows.screen_id = ?&quot;</span>, <span class="ruby-node">&quot;%#{b.id.to_s}%&quot;</span>, <span class="ruby-identifier">cf_branch</span>.<span class="ruby-identifier">id</span> , <span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>])
4797:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">cf_branch</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">value</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">compact</span>
4798:         <span class="ruby-identifier">row_ids</span> = []
4799:         <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">id</span>}
4800:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
4801:           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
4802:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.value != '' and cells.field_id = ? and rows.screen_id = ? and rows.id in (?)&quot;</span>, <span class="ruby-identifier">cf_login</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">row_ids</span>])
4803: 
4804:         <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fs</span><span class="ruby-operator">|</span>
4805:           <span class="ruby-identifier">sales_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">fs</span>.<span class="ruby-identifier">id</span>]
4806:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch_descr</span>][<span class="ruby-identifier">sales_name</span>] <span class="ruby-operator">||=</span>{}
4807: 
4808:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">sales_name</span>] <span class="ruby-operator">||=</span>{}
4809:           <span class="ruby-identifier">nloop</span> = <span class="ruby-value">1</span>
4810:           <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">nloop</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-ivar">@loop</span>
4811:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">||=</span>{}
4812:           <span class="ruby-keyword kw">end</span>
4813: 
4814:           <span class="ruby-comment cmt"># ----- Potential Rank ------</span>
4815:           <span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
4816:             <span class="ruby-identifier">rank_name</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>]
4817:             <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>] <span class="ruby-operator">||=</span>{}
4818:             <span class="ruby-identifier">nloop</span> = <span class="ruby-value">1</span>
4819:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">nloop</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-ivar">@loop</span>
4820:               <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch_descr</span>][<span class="ruby-identifier">sales_name</span>][<span class="ruby-identifier">rank_name</span>][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">||=</span>{}
4821:             <span class="ruby-keyword kw">end</span>
4822:           <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of Potential Rank</span>
4823:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of sales_rows.each</span>
4824:       <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End @branch_screen.rows.each</span>
4825: 
4826:       <span class="ruby-identifier">cached_issue_tracking_cells</span> = <span class="ruby-keyword kw">nil</span>
4827: 
4828:       <span class="ruby-identifier">nloop</span> = <span class="ruby-value">1</span>
4829:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">nloop</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-ivar">@loop</span>
4830: 
4831:         <span class="ruby-comment cmt"># ------ Action ------</span>
4832:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">cached_issue_tracking_cells</span>
4833:           <span class="ruby-identifier">action_rows</span>, <span class="ruby-identifier">cached_issue_tracking_cells</span> = <span class="ruby-identifier">get_action_rows</span>(<span class="ruby-identifier">action_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@dfrom</span>[<span class="ruby-identifier">nloop</span>], <span class="ruby-ivar">@dto</span>[<span class="ruby-identifier">nloop</span>])
4834: 
4835:           <span class="ruby-comment cmt">#! Trim the cache, to speed up the next loop</span>
4836:           <span class="ruby-identifier">date_from</span> = <span class="ruby-ivar">@dfrom</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>
4837:           <span class="ruby-identifier">date_to</span> = <span class="ruby-ivar">@dto</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">max</span>
4838:           <span class="ruby-identifier">cached_issue_tracking_cells</span>.<span class="ruby-identifier">delete_if</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
4839:             <span class="ruby-identifier">due_date</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">cell_due_date</span>(<span class="ruby-identifier">c</span>.<span class="ruby-identifier">value</span>)
4840:             <span class="ruby-operator">!</span><span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">DateTimeField</span>.<span class="ruby-identifier">check_date_in_range?</span>(<span class="ruby-identifier">due_date</span>, <span class="ruby-identifier">date_to</span>, <span class="ruby-identifier">date_from</span>)
4841:           <span class="ruby-keyword kw">end</span>.<span class="ruby-identifier">compact</span>
4842:         <span class="ruby-keyword kw">else</span>
4843:           <span class="ruby-identifier">filter_row_ids</span> = <span class="ruby-identifier">cached_issue_tracking_cells</span>.<span class="ruby-identifier">collect</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
4844:             <span class="ruby-identifier">due_date</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">cell_due_date</span>(<span class="ruby-identifier">c</span>.<span class="ruby-identifier">value</span>)
4845:             <span class="ruby-identifier">c</span>.<span class="ruby-identifier">row_id</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">DateTimeField</span>.<span class="ruby-identifier">check_date_in_range?</span>(<span class="ruby-identifier">due_date</span>, <span class="ruby-ivar">@dto</span>[<span class="ruby-identifier">nloop</span>], <span class="ruby-ivar">@dfrom</span>[<span class="ruby-identifier">nloop</span>])
4846:           <span class="ruby-keyword kw">end</span>.<span class="ruby-identifier">compact</span>
4847: 
4848:           <span class="ruby-identifier">action_rows</span> = <span class="ruby-constant">RevisionRow</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
4849:             <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:rows</span>],
4850:             <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> {
4851:               <span class="ruby-identifier">:rows</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">filter_row_ids</span> }
4852:             }
4853:           )
4854:         <span class="ruby-keyword kw">end</span>
4855: 
4856:         <span class="ruby-identifier">a_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">action_rows</span>, <span class="ruby-identifier">action_field_ids</span>)
4857: 
4858:         <span class="ruby-identifier">action_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fa</span><span class="ruby-operator">|</span>
4859:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4860:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4861: 
4862:           <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">salesman_id</span>, <span class="ruby-identifier">all_ref</span>, <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>], <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>])
4863:           <span class="ruby-identifier">salesman</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">salesman_id</span>]
4864: 
4865:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>].<span class="ruby-identifier">nil?</span>
4866: 
4867:           <span class="ruby-identifier">action_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_action_type</span>.<span class="ruby-identifier">id</span>])
4868:           <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
4869: 
4870:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4871:             <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Other&quot;</span>
4872:           <span class="ruby-keyword kw">else</span>
4873:             <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">action_type_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
4874:           <span class="ruby-keyword kw">end</span>
4875: 
4876:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action_type_name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Visit&quot;</span>
4877:             <span class="ruby-identifier">visit_purpose_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">ComboBox</span>.<span class="ruby-identifier">cell_label_id</span>(<span class="ruby-identifier">a_rows</span>[<span class="ruby-identifier">fa</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_visit_purpose</span>.<span class="ruby-identifier">id</span>])
4878:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">visit_purpose_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4879:               <span class="ruby-identifier">action_type_name</span> = <span class="ruby-value str">&quot;Routine&quot;</span>
4880:             <span class="ruby-keyword kw">else</span>
4881:               <span class="ruby-identifier">action_type_name</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">visit_purpose_id</span>).<span class="ruby-identifier">caption</span>.<span class="ruby-identifier">name</span>
4882:             <span class="ruby-keyword kw">end</span>
4883:           <span class="ruby-keyword kw">end</span>
4884:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>].<span class="ruby-identifier">nil?</span>
4885:             <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
4886:             <span class="ruby-identifier">nn</span> = <span class="ruby-value">1</span>
4887:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">nn</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-ivar">@loop</span>
4888:               <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">nn</span>.<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">||=</span>{}
4889:             <span class="ruby-keyword kw">end</span>
4890:           <span class="ruby-keyword kw">end</span>
4891: 
4892:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-identifier">action_type_name</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>
4893:           <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-identifier">action_type_name</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4894:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-identifier">action_type_name</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>
4895:           <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-identifier">action_type_name</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4896:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of @action_screen.rows.each</span>
4897: 
4898:         <span class="ruby-comment cmt"># ------ Business Record ------</span>
4899:         <span class="ruby-identifier">row_ids</span> = []
4900:         <span class="ruby-identifier">filter_rows</span> =  <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
4901:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.field_id = ? and cells.value between ? and  ?&quot;</span>, <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@dfrom</span>[<span class="ruby-identifier">nloop</span>], <span class="ruby-ivar">@dto</span>[<span class="ruby-identifier">nloop</span>]])
4902:         <span class="ruby-identifier">filter_rows</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>}
4903:         <span class="ruby-identifier">business_rows</span> =  <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">row_ids</span>)
4904:         <span class="ruby-identifier">brows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">business_rows</span>, <span class="ruby-identifier">business_field_ids</span>)
4905: 
4906:         <span class="ruby-identifier">business_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fb</span><span class="ruby-operator">|</span>
4907:           <span class="ruby-identifier">issue</span> = <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_issue_tracking</span>.<span class="ruby-identifier">id</span>]
4908:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">issue_state</span>(<span class="ruby-identifier">issue</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">:cancelled</span>
4909: 
4910:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_customer</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4911:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4912: 
4913:           <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">company_branch_hash</span>(<span class="ruby-identifier">salesman_id</span>, <span class="ruby-identifier">all_ref</span>, <span class="ruby-identifier">screen_all</span>[<span class="ruby-value str">'staff'</span>], <span class="ruby-identifier">cf_all</span>[<span class="ruby-value str">'sales_office_ref'</span>])
4914:           <span class="ruby-identifier">salesman</span> = <span class="ruby-identifier">all_ref</span>[<span class="ruby-identifier">salesman_id</span>]
4915: 
4916:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>].<span class="ruby-identifier">nil?</span>
4917: 
4918:           <span class="ruby-identifier">cell_PO_Date</span> = <span class="ruby-identifier">brows</span>[<span class="ruby-identifier">fb</span>.<span class="ruby-identifier">id</span>][<span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>]
4919:           <span class="ruby-identifier">customer_rank</span> = <span class="ruby-identifier">custrank_ref</span>[<span class="ruby-identifier">customer_id</span>]
4920: 
4921:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>].<span class="ruby-identifier">nil?</span>
4922:             <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>] <span class="ruby-operator">||=</span>{}
4923:             <span class="ruby-identifier">nn</span> = <span class="ruby-value">1</span>
4924:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">nn</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-ivar">@loop</span>
4925:               <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">nn</span>.<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">||=</span>{}
4926:             <span class="ruby-keyword kw">end</span>
4927:           <span class="ruby-keyword kw">end</span>
4928:           <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">cell_PO_Date</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@dfrom</span>[<span class="ruby-identifier">nloop</span>]) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">cell_PO_Date</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@dto</span>[<span class="ruby-identifier">nloop</span>]))
4929:             <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-value str">&quot;P/O&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>
4930:             <span class="ruby-ivar">@result</span>[<span class="ruby-identifier">branch</span>][<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">customer_rank</span>][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-value str">&quot;P/O&quot;</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4931:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-value str">&quot;P/O&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>
4932:             <span class="ruby-ivar">@total</span>[<span class="ruby-identifier">salesman</span>][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-value str">&quot;P/O&quot;</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4933:           <span class="ruby-keyword kw">end</span>
4934:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of business record</span>
4935:         <span class="ruby-identifier">nloop</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4936:       <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End For loop</span>
4937:       <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">store_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>,
4938:         {
4939:           <span class="ruby-identifier">:result</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@result</span>,
4940:           <span class="ruby-identifier">:total</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@total</span>,
4941:           <span class="ruby-identifier">:dfrom</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@dfrom</span>,
4942:           <span class="ruby-identifier">:dto</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@dto</span>,
4943:           <span class="ruby-identifier">:loop</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@loop</span>,
4944:           <span class="ruby-identifier">:rpt_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@rpt_type</span>,
4945:           <span class="ruby-identifier">:rpt_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@rpt_name</span>
4946:         })
4947:     <span class="ruby-keyword kw">else</span>
4948:       <span class="ruby-identifier">vm</span> = <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">get_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>)
4949:       <span class="ruby-ivar">@result</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:result</span>]
4950:       <span class="ruby-ivar">@total</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:total</span>]
4951:       <span class="ruby-ivar">@dfrom</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:dfrom</span>]
4952:       <span class="ruby-ivar">@dto</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:dto</span>]
4953:       <span class="ruby-ivar">@loop</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:loop</span>]
4954:       <span class="ruby-ivar">@rpt_type</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:rpt_type</span>]
4955:       <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:rpt_name</span>]
4956:       
4957:       <span class="ruby-identifier">export_compare_action</span>(<span class="ruby-ivar">@result</span>,<span class="ruby-ivar">@total</span>,<span class="ruby-ivar">@dfrom</span>,<span class="ruby-ivar">@dto</span>,<span class="ruby-ivar">@loop</span>,<span class="ruby-ivar">@rpt_type</span>,<span class="ruby-ivar">@rpt_name</span>)
4958:     <span class="ruby-keyword kw">end</span>
4959:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000543" class="method-detail">
        <a name="M000543"></a>

        <div class="method-heading">
          <a href="#M000543" class="method-signature">
          <span class="method-name">create</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
POST /reports POST /reports.xml
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000543-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000543-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 131</span>
131:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create</span>
132:     <span class="ruby-ivar">@screen</span> = <span class="ruby-identifier">session</span>.<span class="ruby-identifier">active_screen</span>
133:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>])
134:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screen_alias</span> = []
135:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screen_outer_joins</span> = []
136:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screens</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
137:       <span class="ruby-identifier">a</span> = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">label_descr</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[^A-Z]/</span>,<span class="ruby-value str">''</span>).<span class="ruby-identifier">downcase</span>
138:       <span class="ruby-identifier">a</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;_#{@report.reference_screen_alias.select{|x| x =~ Regexp.new(&quot;(^#{a}$|^#{a}_[0-9]+$)&quot;) }.length}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screen_alias</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>)
139:       <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screen_alias</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">a</span>
140:       <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screen_outer_joins</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-value str">'-1'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>}
141:     <span class="ruby-keyword kw">end</span>
142: 
143:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">cell_location</span> = <span class="ruby-value str">&quot;col&quot;</span>
144: 
145:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">save</span>
146:     
147:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
148:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment cmt"># create.html.erb</span>
149:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@report</span> }
150:     <span class="ruby-keyword kw">end</span>
151:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000564" class="method-detail">
        <a name="M000564"></a>

        <div class="method-heading">
          <a href="#M000564" class="method-signature">
          <span class="method-name">csv</span><span class="method-args">(rows)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000564-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000564-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 751</span>
751:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">csv</span>(<span class="ruby-identifier">rows</span>)
752: 
753:     <span class="ruby-comment cmt"># CSV File Name</span>
754:     <span class="ruby-comment cmt">#    staff_row = session['user'].staff_row</span>
755:           <span class="ruby-identifier">screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:screen_id</span>])
756:           <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-value str">&quot;%Y%m%d%H%M&quot;</span>)
757:           <span class="ruby-identifier">file_name</span> = <span class="ruby-node">&quot;#{screen.name}_#{time}.csv&quot;</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot; &quot;</span>,<span class="ruby-value str">&quot;_&quot;</span>)
758: 
759:     <span class="ruby-identifier">display_flag_label</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-value str">&quot;G_List&quot;</span>)
760:     <span class="ruby-identifier">fields</span> = []
761:     <span class="ruby-identifier">custom_field_ids</span> = []
762:     <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span>
763:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">field</span>.<span class="ruby-identifier">display_in_screen?</span>(<span class="ruby-identifier">display_flag_label</span>)
764:         <span class="ruby-identifier">fields</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">field</span>
765:         <span class="ruby-identifier">custom_field_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">field</span>.<span class="ruby-identifier">custom_field_id</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">field</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Data</span>)
766:       <span class="ruby-keyword kw">end</span>
767:     <span class="ruby-keyword kw">end</span>
768: 
769:     <span class="ruby-comment cmt"># CSV Header</span>
770:     <span class="ruby-identifier">csv_data</span> = <span class="ruby-value str">&quot;&quot;</span>
771: 
772:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;RevisionScreen&quot;</span>
773:       <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;rev_no&quot;</span>
774:       <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span>
775:     <span class="ruby-keyword kw">end</span>
776: 
777:     <span class="ruby-identifier">headers</span> = []
778:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">DetailScreen</span>)
779:       <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">header_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
780:         <span class="ruby-keyword kw">if</span>  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Fields::Grouping&quot;</span>
781:           <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">full_descr</span>
782:         <span class="ruby-keyword kw">elsif</span>  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Fields::Grouping&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">f</span>.<span class="ruby-identifier">field_id</span>.<span class="ruby-identifier">nil?</span>
783:           <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">full_descr</span>
784:         <span class="ruby-keyword kw">end</span>
785:       <span class="ruby-keyword kw">end</span>
786:       <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
787:         <span class="ruby-keyword kw">if</span>  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Fields::Grouping&quot;</span>
788:           <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">full_descr</span>
789:         <span class="ruby-keyword kw">elsif</span>  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Fields::Grouping&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">f</span>.<span class="ruby-identifier">field_id</span>.<span class="ruby-identifier">nil?</span>
790:           <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">full_descr</span>
791:         <span class="ruby-keyword kw">end</span>
792:       <span class="ruby-keyword kw">end</span>
793:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">RevisionScreen</span>)
794:       <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">header_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
795:         <span class="ruby-keyword kw">if</span>  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Fields::Grouping&quot;</span>
796:           <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">full_descr</span>
797:         <span class="ruby-keyword kw">elsif</span>  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Fields::Grouping&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">f</span>.<span class="ruby-identifier">field_id</span>.<span class="ruby-identifier">nil?</span>
798:           <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">full_descr</span>
799:         <span class="ruby-keyword kw">end</span>
800:       <span class="ruby-keyword kw">end</span>
801:     <span class="ruby-keyword kw">end</span>
802:     <span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
803:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Calendar</span>)
804: 
805:         <span class="ruby-identifier">cell</span> = <span class="ruby-identifier">rows</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">cells</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Calendar</span>)}.<span class="ruby-identifier">first</span>
806:         <span class="ruby-identifier">detail_fields</span> = <span class="ruby-identifier">cell</span>.<span class="ruby-identifier">field</span>.<span class="ruby-identifier">detail_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span> <span class="ruby-identifier">field</span>.<span class="ruby-identifier">display_in_list?</span> }
807:         <span class="ruby-identifier">selected_date</span> = <span class="ruby-identifier">cell</span>.<span class="ruby-identifier">value</span>[<span class="ruby-identifier">:selected_date</span>].<span class="ruby-identifier">to_date</span>
808:         <span class="ruby-identifier">start_date</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">DateTimeField</span>.<span class="ruby-identifier">begin_of_period</span>(<span class="ruby-identifier">selected_date</span>, <span class="ruby-identifier">:year</span>)
809:         <span class="ruby-identifier">end_date</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">DateTimeField</span>.<span class="ruby-identifier">end_of_period</span>(<span class="ruby-identifier">selected_date</span>, <span class="ruby-identifier">:year</span>)
810: 
811:         <span class="ruby-identifier">diff_year</span> =  <span class="ruby-identifier">start_date</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">end_date</span>.<span class="ruby-identifier">year</span>
812:         <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;Date&quot;</span>
813: 
814:         <span class="ruby-identifier">cell</span>.<span class="ruby-identifier">calendar_values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">calendar_value</span><span class="ruby-operator">|</span>
815:           <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;Date&quot;</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">start_date</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">end_date</span>.<span class="ruby-identifier">beginning_of_year</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">diff_year</span>
816:           <span class="ruby-identifier">detail_fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">detail_field</span><span class="ruby-operator">|</span>
817:             <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{f.full_descr} #{calendar_value.date_time.strftime(&quot;%b&quot;)} #{detail_field.full_descr}&quot;</span>
818:           <span class="ruby-keyword kw">end</span>
819:           <span class="ruby-identifier">start_date</span> = <span class="ruby-identifier">start_date</span>.<span class="ruby-identifier">next_month</span>
820:         <span class="ruby-keyword kw">end</span>
821: 
822:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Fields::Grouping&quot;</span>
823:         <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">full_descr</span>
824:       <span class="ruby-keyword kw">elsif</span>  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Fields::Grouping&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">f</span>.<span class="ruby-identifier">field_id</span>.<span class="ruby-identifier">nil?</span>
825:         <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">full_descr</span>
826:       <span class="ruby-keyword kw">end</span>
827:     <span class="ruby-keyword kw">end</span>
828:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">HeaderScreen</span>)
829:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">control_revision?</span>
830:         <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
831:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_header_list?</span>
832:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Fields::Grouping&quot;</span>
833:               <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">full_descr</span>
834:             <span class="ruby-keyword kw">elsif</span>  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Fields::Grouping&quot;</span> <span class="ruby-keyword kw">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">f</span>.<span class="ruby-identifier">field_id</span>.<span class="ruby-identifier">nil?</span>
835:               <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">full_descr</span>
836:             <span class="ruby-keyword kw">end</span>
837:           <span class="ruby-keyword kw">end</span>
838:         <span class="ruby-keyword kw">end</span>
839:       <span class="ruby-keyword kw">else</span>
840:         <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
841:           <span class="ruby-keyword kw">if</span>  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Fields::Grouping&quot;</span>
842:             <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">full_descr</span>
843:           <span class="ruby-keyword kw">elsif</span>  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-operator">&amp;&amp;</span>  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Fields::Grouping&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">f</span>.<span class="ruby-identifier">field_id</span>.<span class="ruby-identifier">nil?</span>
844:             <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">full_descr</span>
845:           <span class="ruby-keyword kw">end</span>
846:         <span class="ruby-keyword kw">end</span>
847:       <span class="ruby-keyword kw">end</span>
848:     <span class="ruby-keyword kw">end</span>
849: 
850:     <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span>
851:       <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[^\w]/</span>,<span class="ruby-value str">'_'</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[_]+/</span>,<span class="ruby-value str">'_'</span>).<span class="ruby-identifier">underscore</span>
852:       <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span>
853:     <span class="ruby-keyword kw">end</span>
854:     
855:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;HeaderScreen&quot;</span>
856:       <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;latest_rev_no&quot;</span>
857:       <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span>
858:     <span class="ruby-keyword kw">end</span>
859:     
860:     <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;remark&quot;</span>
861:     <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;\n&quot;</span>
862: 
863:     <span class="ruby-comment cmt"># Checking field Screen</span>
864:     <span class="ruby-identifier">header_fields</span> = []
865:     <span class="ruby-identifier">revision_fields</span> = []
866:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">DetailScreen</span>)
867:       <span class="ruby-identifier">revision_fields</span> = <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Grouping</span>)}.<span class="ruby-identifier">compact</span>
868:       <span class="ruby-identifier">header_fields</span> = <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">header_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Grouping</span>)}.<span class="ruby-identifier">compact</span>
869:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">RevisionScreen</span>)
870:       <span class="ruby-identifier">header_fields</span> = <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">header_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Grouping</span>)}.<span class="ruby-identifier">compact</span>
871:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">HeaderScreen</span>)
872:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">control_revision?</span>
873:         <span class="ruby-identifier">revision_fields</span> = <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_header_list?</span>}.<span class="ruby-identifier">compact</span>
874:       <span class="ruby-keyword kw">else</span>
875:         <span class="ruby-identifier">revision_fields</span> = <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Grouping</span>)}.<span class="ruby-identifier">compact</span>
876:       <span class="ruby-keyword kw">end</span>
877:     <span class="ruby-keyword kw">end</span>
878:     <span class="ruby-comment cmt"># CSV Data</span>
879:     <span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>
880: 
881:       <span class="ruby-comment cmt">#####</span>
882:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">row</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">DetailRow</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">DetailScreen</span>)
883:         <span class="ruby-identifier">header_row</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">revision_row</span>.<span class="ruby-identifier">header_row</span>
884:         <span class="ruby-identifier">header_fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">h_field</span><span class="ruby-operator">|</span>
885:           <span class="ruby-identifier">custom_field</span> = <span class="ruby-identifier">h_field</span>.<span class="ruby-identifier">custom_field</span>
886:           <span class="ruby-identifier">cell</span> = <span class="ruby-identifier">header_row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">nil?</span>
887:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">gen_data_csv</span>(<span class="ruby-identifier">h_field</span>, <span class="ruby-identifier">cell</span>, <span class="ruby-identifier">header_row</span>)
888:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">remove_reserve_character</span>(<span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
889:           <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
890:           <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span>
891:         <span class="ruby-keyword kw">end</span>
892: 
893:         <span class="ruby-identifier">revision_row</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">revision_row</span>
894:         <span class="ruby-identifier">revision_fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r_field</span><span class="ruby-operator">|</span>
895:           <span class="ruby-identifier">custom_field</span> = <span class="ruby-identifier">r_field</span>.<span class="ruby-identifier">custom_field</span>
896:           <span class="ruby-identifier">cell</span> = <span class="ruby-identifier">revision_row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">nil?</span>
897:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">gen_data_csv</span>(<span class="ruby-identifier">r_field</span>, <span class="ruby-identifier">cell</span>, <span class="ruby-identifier">revision_row</span>)
898:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">remove_reserve_character</span>(<span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
899:           <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
900:           <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span>
901:         <span class="ruby-keyword kw">end</span>
902: 
903:         <span class="ruby-identifier">data</span> = <span class="ruby-identifier">revision_row</span>.<span class="ruby-identifier">rev_no</span>.<span class="ruby-identifier">to_s</span>
904:         <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
905:         <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span>
906:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">row</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">RevisionRow</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">RevisionScreen</span>)
907:         <span class="ruby-identifier">data</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">rev_no</span>.<span class="ruby-identifier">to_s</span>
908:         <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
909:         <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span>
910:         <span class="ruby-identifier">header_row</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">header_row</span>
911:         <span class="ruby-identifier">header_fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">h_field</span><span class="ruby-operator">|</span>
912:           <span class="ruby-identifier">custom_field</span> = <span class="ruby-identifier">h_field</span>.<span class="ruby-identifier">custom_field</span>
913:           <span class="ruby-identifier">cell</span> = <span class="ruby-identifier">header_row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">nil?</span>
914:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">gen_data_csv</span>(<span class="ruby-identifier">h_field</span>, <span class="ruby-identifier">cell</span>, <span class="ruby-identifier">header_row</span>)
915:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">remove_reserve_character</span>(<span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
916:           <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
917:           <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span>
918:         <span class="ruby-keyword kw">end</span>
919:       <span class="ruby-keyword kw">end</span>
920:       <span class="ruby-comment cmt">#####</span>
921:       <span class="ruby-comment cmt">#      if row.is_a?(RevisionRow) and screen.is_a?(RevisionScreen)</span>
922:       <span class="ruby-comment cmt">#        data = row.header_row.latest_revision_no.to_s</span>
923:       <span class="ruby-comment cmt">#        csv_data &lt;&lt; data</span>
924:       <span class="ruby-comment cmt">#        csv_data &lt;&lt; &quot;,&quot;</span>
925:       <span class="ruby-comment cmt">#      end</span>
926: 
927:       <span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span>
928:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">field</span>.<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Calendar</span>)
929:           <span class="ruby-identifier">custom_field</span> = <span class="ruby-identifier">field</span>.<span class="ruby-identifier">custom_field</span>
930:           <span class="ruby-identifier">cell</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">nil?</span>
931:           <span class="ruby-identifier">detail_fields</span> = <span class="ruby-identifier">cell</span>.<span class="ruby-identifier">field</span>.<span class="ruby-identifier">detail_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span> <span class="ruby-identifier">field</span>.<span class="ruby-identifier">display_in_list?</span> }
932:           <span class="ruby-identifier">selected_date</span> = <span class="ruby-identifier">cell</span>.<span class="ruby-identifier">value</span>[<span class="ruby-identifier">:selected_date</span>].<span class="ruby-identifier">to_date</span>
933:           <span class="ruby-identifier">start_date</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">DateTimeField</span>.<span class="ruby-identifier">begin_of_period</span>(<span class="ruby-identifier">selected_date</span>, <span class="ruby-identifier">:year</span>)
934:           <span class="ruby-identifier">end_date</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">DateTimeField</span>.<span class="ruby-identifier">end_of_period</span>(<span class="ruby-identifier">selected_date</span>, <span class="ruby-identifier">:year</span>)
935: 
936:           <span class="ruby-identifier">diff_year</span> =  <span class="ruby-identifier">start_date</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">end_date</span>.<span class="ruby-identifier">year</span>
937:           
938:           <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">start_date</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_s</span>
939:           <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span>
940:           
941:           <span class="ruby-identifier">cell</span>.<span class="ruby-identifier">calendar_values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">calendar_value</span><span class="ruby-operator">|</span>
942:             <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">start_date</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">end_date</span>.<span class="ruby-identifier">beginning_of_year</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">diff_year</span>
943:               <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">start_date</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_s</span>
944:               <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span>
945:             <span class="ruby-keyword kw">end</span>
946: 
947:             <span class="ruby-identifier">detail_fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">detail_field</span><span class="ruby-operator">|</span>             
948:               <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">detail_field</span> 
949:               <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Data</span>
950:                 <span class="ruby-identifier">calendar_value</span>.<span class="ruby-identifier">row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">detail_field</span>.<span class="ruby-identifier">custom_field_id</span>).<span class="ruby-identifier">value</span>
951:               <span class="ruby-keyword kw">else</span>
952:                 <span class="ruby-identifier">detail_field</span>.<span class="ruby-identifier">evaluate_value</span>(<span class="ruby-identifier">calendar_value</span>.<span class="ruby-identifier">row</span>).<span class="ruby-identifier">to_s</span>
953:               <span class="ruby-keyword kw">end</span>
954:               <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span>
955:             <span class="ruby-keyword kw">end</span> 
956:             <span class="ruby-identifier">start_date</span> = <span class="ruby-identifier">start_date</span> = <span class="ruby-identifier">start_date</span>.<span class="ruby-identifier">next_month</span>
957:           <span class="ruby-keyword kw">end</span>
958:         
959:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">field</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Fields::Grouping&quot;</span>
960:           <span class="ruby-identifier">data</span> = <span class="ruby-value str">&quot;&quot;</span>
961:           <span class="ruby-identifier">custom_field</span> = <span class="ruby-identifier">field</span>.<span class="ruby-identifier">custom_field</span>
962:           <span class="ruby-identifier">cell</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">nil?</span>
963:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">gen_data_csv</span>(<span class="ruby-identifier">field</span>, <span class="ruby-identifier">cell</span>, <span class="ruby-identifier">row</span>)
964:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">remove_reserve_character</span>(<span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
965:           <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
966:           <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span>
967: 
968:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">row</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">HeaderRow</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">HeaderScreen</span>)
969:             <span class="ruby-identifier">revision_row</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">latest_revision</span>
970:             <span class="ruby-identifier">revision_fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r_field</span><span class="ruby-operator">|</span>
971:               <span class="ruby-identifier">custom_field</span> = <span class="ruby-identifier">r_field</span>.<span class="ruby-identifier">custom_field</span>
972:               <span class="ruby-identifier">cell</span> = <span class="ruby-identifier">revision_row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">nil?</span>
973: 
974:               <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">control_revision?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">r_field</span>.<span class="ruby-identifier">display_in_header_list?</span>)
975: 
976:               <span class="ruby-identifier">data</span> = <span class="ruby-identifier">gen_data_csv</span>(<span class="ruby-identifier">r_field</span>, <span class="ruby-identifier">cell</span>, <span class="ruby-identifier">revision_row</span>)
977:               <span class="ruby-identifier">data</span> = <span class="ruby-identifier">remove_reserve_character</span>(<span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
978:               <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
979:               <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span>
980:             <span class="ruby-keyword kw">end</span>
981:             <span class="ruby-identifier">data</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">latest_revision_no</span>.<span class="ruby-identifier">to_s</span>
982:             <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
983:             <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span>
984:           <span class="ruby-keyword kw">end</span>
985: 
986:         <span class="ruby-keyword kw">end</span>
987: 
988:       <span class="ruby-keyword kw">end</span>
989: 
990:       <span class="ruby-identifier">remark</span> = <span class="ruby-value str">&quot;&quot;</span>
991:       <span class="ruby-identifier">remark</span> = <span class="ruby-identifier">remove_reserve_character</span>(<span class="ruby-identifier">row</span>.<span class="ruby-identifier">remark</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">row</span>.<span class="ruby-identifier">remark</span>).<span class="ruby-identifier">nil?</span>
992:       <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">remark</span>
993:       <span class="ruby-identifier">csv_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;\n&quot;</span>
994:     <span class="ruby-keyword kw">end</span>
995: 
996:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">csv_data</span>,<span class="ruby-identifier">file_name</span>
997:     
998:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000561" class="method-detail">
        <a name="M000561"></a>

        <div class="method-heading">
          <a href="#M000561" class="method-signature">
          <span class="method-name">csv_report</span><span class="method-args">(rows)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000561-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000561-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 441</span>
441:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">csv_report</span>(<span class="ruby-identifier">rows</span>)
442:           <span class="ruby-identifier">csv_data</span>,<span class="ruby-identifier">file_name</span> = <span class="ruby-identifier">csv</span>(<span class="ruby-identifier">rows</span>)
443:           <span class="ruby-identifier">cache_hack</span>
444:           <span class="ruby-identifier">send_data</span> <span class="ruby-identifier">csv_data</span>, <span class="ruby-identifier">:filename</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">file_name</span>, <span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'csv'</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'inline'</span>
445:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000576" class="method-detail">
        <a name="M000576"></a>

        <div class="method-heading">
          <a href="#M000576" class="method-signature">
          <span class="method-name">cust_new</span><span class="method-args">(firstPO, dfrom)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000576-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000576-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1123</span>
1123:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cust_new</span>(<span class="ruby-identifier">firstPO</span>, <span class="ruby-identifier">dfrom</span>)
1124:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1125:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1126: 
1127:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">firstPO</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;&quot;</span>  <span class="ruby-operator">||</span> <span class="ruby-identifier">firstPO</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;&amp;nbsp;&quot;</span>
1128:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;New&quot;</span>
1129:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">firstPO</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">dfrom</span>
1130:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;Existing&quot;</span>
1131:     <span class="ruby-keyword kw">else</span>
1132:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;New&quot;</span>
1133:     <span class="ruby-keyword kw">end</span>
1134: 
1135:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000572" class="method-detail">
        <a name="M000572"></a>

        <div class="method-heading">
          <a href="#M000572" class="method-signature">
          <span class="method-name">cust_rank</span><span class="method-args">(id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000572-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000572-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1077</span>
1077:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cust_rank</span>(<span class="ruby-identifier">id</span>)
1078:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1079:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1080: 
1081:     <span class="ruby-comment cmt">#Customer</span>
1082:     <span class="ruby-identifier">customer_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">&quot;name = 'customer'&quot;</span>)
1083:     <span class="ruby-identifier">cust_row</span> = <span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_i</span>)
1084:     <span class="ruby-identifier">cf_rank</span> = <span class="ruby-constant">CustomField</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;name = 'Potential_Rank_REF'&quot;</span>)
1085:     <span class="ruby-identifier">result</span> = <span class="ruby-identifier">cust_row</span>.<span class="ruby-identifier">cells</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;field_id = ?&quot;</span>, <span class="ruby-identifier">cf_rank</span>.<span class="ruby-identifier">id</span>]).<span class="ruby-identifier">value</span>
1086:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;&quot;</span>
1087:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;N/A&quot;</span>
1088:     <span class="ruby-keyword kw">else</span>
1089:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">retrieve_nonmulti_result</span>([<span class="ruby-identifier">result</span>])
1090:     <span class="ruby-keyword kw">end</span>
1091:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000545" class="method-detail">
        <a name="M000545"></a>

        <div class="method-heading">
          <a href="#M000545" class="method-signature">
          <span class="method-name">destroy</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
DELETE /reports/1 DELETE /reports/1.xml
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000545-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000545-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 176</span>
176:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">destroy</span>
177:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>].<span class="ruby-identifier">to_i</span>)
178:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">destroy</span>
179:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000539" class="method-detail">
        <a name="M000539"></a>

        <div class="method-heading">
          <a href="#M000539" class="method-signature">
          <span class="method-name">edit</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
GET /reports/1/edit
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000539-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000539-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 93</span>
 93:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">edit</span>
 94:     <span class="ruby-ivar">@screen</span> = <span class="ruby-identifier">session</span>.<span class="ruby-identifier">active_screen</span>
 95:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>].<span class="ruby-identifier">to_i</span>)
 96: 
 97:     <span class="ruby-ivar">@assigned_options</span> = <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screens</span>
 98:     <span class="ruby-ivar">@all_options</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
 99:       <span class="ruby-identifier">:conditions=</span><span class="ruby-operator">&gt;</span>[<span class="ruby-value str">&quot; controller = ? and action = ?&quot;</span>,<span class="ruby-value str">&quot;screens&quot;</span>,<span class="ruby-value str">&quot;show&quot;</span>],
100:       <span class="ruby-identifier">:order=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">&quot;name&quot;</span>
101:     ).<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">parent</span> }.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">sort</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">name</span> }
102: 
103:     <span class="ruby-identifier">clean_field_filters</span>
104:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000553" class="method-detail">
        <a name="M000553"></a>

        <div class="method-heading">
          <a href="#M000553" class="method-signature">
          <span class="method-name">edit_filter</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000553-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000553-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 319</span>
319:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">edit_filter</span>
320:     <span class="ruby-identifier">field_report_filter_id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]
321:     
322:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">field_report_filter_id</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/_/</span>
323:       <span class="ruby-ivar">@field_report_filter</span> = <span class="ruby-constant">FieldReportFilter</span>.<span class="ruby-identifier">new</span>(
324:         <span class="ruby-identifier">:report_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report_id</span>],
325:         <span class="ruby-identifier">:field_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:field_id</span>],
326:         <span class="ruby-identifier">:reference_screen_index</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:reference_screen_index</span>]
327:       )
328:     <span class="ruby-keyword kw">else</span>
329:       <span class="ruby-ivar">@field_report_filter</span> = <span class="ruby-constant">FieldReportFilter</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">field_report_filter_id</span>.<span class="ruby-identifier">to_i</span>)
330:     <span class="ruby-keyword kw">end</span>
331: 
332:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
333:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment cmt"># edit_format.html.erb</span>
334:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@report</span> }
335:     <span class="ruby-keyword kw">end</span>
336:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000551" class="method-detail">
        <a name="M000551"></a>

        <div class="method-heading">
          <a href="#M000551" class="method-signature">
          <span class="method-name">edit_format</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
GET /reports/1
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000551-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000551-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 295</span>
295:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">edit_format</span>
296:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
297:     <span class="ruby-ivar">@field_report</span> = <span class="ruby-constant">FieldsReport</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:field_report_id</span>])
298:     <span class="ruby-ivar">@labels</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>).<span class="ruby-identifier">sort</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">descr</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">descr</span> }
299:     
300:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
301:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment cmt"># edit_format.html.erb</span>
302:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@report</span> }
303:     <span class="ruby-keyword kw">end</span>
304:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000560" class="method-detail">
        <a name="M000560"></a>

        <div class="method-heading">
          <a href="#M000560" class="method-signature">
          <span class="method-name">excel_report</span><span class="method-args">(rows)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000560-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000560-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 427</span>
427:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">excel_report</span>(<span class="ruby-identifier">rows</span>)
428:           <span class="ruby-identifier">file_path</span>,<span class="ruby-identifier">time</span> = <span class="ruby-identifier">xls</span>(<span class="ruby-identifier">rows</span>)
429:     <span class="ruby-identifier">file_names</span> = <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;#{RAILS_ROOT}/public/ReportFile/&quot;</span>).<span class="ruby-identifier">entries</span>
430:     <span class="ruby-identifier">file_names</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file_name</span><span class="ruby-operator">|</span>
431:       <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">file_name</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;.&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">file_name</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;..&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">file_name</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;.svn&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">file_name</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">time</span>))
432:         <span class="ruby-keyword kw">begin</span>
433:           <span class="ruby-constant">File</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-node">&quot;#{RAILS_ROOT}/public/ReportFile/#{file_name}&quot;</span>)
434:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span>
435:           <span class="ruby-comment cmt"># Nothing to do</span>
436:         <span class="ruby-keyword kw">end</span>
437:       <span class="ruby-keyword kw">end</span>
438:     <span class="ruby-keyword kw">end</span>
439:     <span class="ruby-identifier">send_file</span>(<span class="ruby-identifier">file_path</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'attachment'</span>, <span class="ruby-identifier">:encoding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'utf8'</span>, <span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'application/octet-stream'</span>)
440:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000557" class="method-detail">
        <a name="M000557"></a>

        <div class="method-heading">
          <a href="#M000557" class="method-signature">
          <span class="method-name">export</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000557-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000557-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 395</span>
395:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">export</span>
396:     <span class="ruby-ivar">@screen_id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]
397:     <span class="ruby-ivar">@parent_row_id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:parent_row_id</span>]
398:     <span class="ruby-ivar">@header_row_id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:header_row_id</span>]
399:     <span class="ruby-ivar">@action_source</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:action_source</span>]
400:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000599" class="method-detail">
        <a name="M000599"></a>

        <div class="method-heading">
          <a href="#M000599" class="method-signature">
          <span class="method-name">export_action_daily</span><span class="method-args">(result,total,date_from,date_to,header)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000599-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000599-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 4251</span>
4251:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">export_action_daily</span>(<span class="ruby-identifier">result</span>,<span class="ruby-identifier">total</span>,<span class="ruby-identifier">date_from</span>,<span class="ruby-identifier">date_to</span>,<span class="ruby-identifier">header</span>)
4252:     <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-value str">&quot;%Y%m%d%H%M%S&quot;</span>)
4253:           <span class="ruby-identifier">file_name</span> = <span class="ruby-node">&quot;ActionReport_#{time}&quot;</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot; &quot;</span>,<span class="ruby-value str">&quot;_&quot;</span>)
4254:           <span class="ruby-identifier">file_path</span> = <span class="ruby-node">&quot;#{RAILS_ROOT}/public/ReportFile/#{file_name}.xls&quot;</span>
4255:           <span class="ruby-identifier">workbook</span>  = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">WriteExcel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;#{file_path}&quot;</span>);
4256:           <span class="ruby-identifier">format_title</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:bold</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>, <span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">14</span>)
4257:           <span class="ruby-identifier">format_header</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:bold</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>, <span class="ruby-identifier">:bg_color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">27</span> ,<span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">12</span>,<span class="ruby-identifier">:align</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'vcenter'</span>)
4258:           <span class="ruby-identifier">format_data</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>,<span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">10</span>)
4259:           <span class="ruby-identifier">worksheet</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_worksheet</span>
4260: 
4261:     <span class="ruby-identifier">col</span> = <span class="ruby-identifier">header</span>.<span class="ruby-identifier">length</span>
4262:     <span class="ruby-identifier">action</span> = [<span class="ruby-value str">&quot;New Visit&quot;</span>,<span class="ruby-value str">&quot;Routine&quot;</span>,<span class="ruby-value str">&quot;Special&quot;</span>,<span class="ruby-value str">&quot;Assembly Tech '10&quot;</span>,<span class="ruby-value str">&quot;Metalex '10&quot;</span>,<span class="ruby-value str">&quot;Telephone&quot;</span>,<span class="ruby-value str">&quot;Email&quot;</span>,<span class="ruby-value str">&quot;Direct Mail&quot;</span>,<span class="ruby-value str">&quot;Other&quot;</span>]
4263:     <span class="ruby-identifier">task</span> = [<span class="ruby-value str">&quot;Request Quotation&quot;</span>,<span class="ruby-value str">&quot;Project Followup&quot;</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-value str">&quot;Training&quot;</span>,<span class="ruby-value str">&quot;Claim Trouble&quot;</span>,<span class="ruby-value str">&quot;Other&quot;</span>]
4264:     <span class="ruby-identifier">business</span> = [<span class="ruby-value str">&quot;Quotation&quot;</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-value str">&quot;Invoice&quot;</span>,<span class="ruby-value str">&quot;Payment&quot;</span>]
4265:     <span class="ruby-identifier">business_count</span> = [<span class="ruby-value str">&quot;Quotation_count&quot;</span>,<span class="ruby-value str">&quot;P/O_count&quot;</span>,<span class="ruby-value str">&quot;Delivery_count&quot;</span>,<span class="ruby-value str">&quot;Invoice_count&quot;</span>,<span class="ruby-value str">&quot;Payment_count&quot;</span>]
4266: 
4267:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value">0</span>,<span class="ruby-value">5</span>,<span class="ruby-value str">&quot;Action Report&quot;</span>,<span class="ruby-identifier">format_title</span>)
4268:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value">1</span>,<span class="ruby-value">5</span>,<span class="ruby-identifier">date_from</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;  to  &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">date_to</span>,<span class="ruby-identifier">format_title</span>)
4269:     <span class="ruby-identifier">i</span> = <span class="ruby-value">4</span>
4270:     <span class="ruby-identifier">j</span> = <span class="ruby-value">0</span>
4271:     <span class="ruby-identifier">nlen</span> = <span class="ruby-identifier">header</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">action</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">business</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">business_count</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
4272:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">4</span><span class="ruby-operator">..</span><span class="ruby-value">6</span>
4273:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">j</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nlen</span>
4274:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>,<span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_header</span>)
4275:       <span class="ruby-keyword kw">end</span>
4276:       <span class="ruby-identifier">i</span><span class="ruby-operator">+=</span><span class="ruby-value">1</span>
4277:       <span class="ruby-identifier">j</span>=<span class="ruby-value">0</span>
4278:     <span class="ruby-keyword kw">end</span>
4279: 
4280:     <span class="ruby-identifier">row</span> = <span class="ruby-value">4</span>
4281:     <span class="ruby-comment cmt"># Header</span>
4282:     <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
4283:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">col</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
4284:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">i</span>,<span class="ruby-identifier">header</span>[<span class="ruby-identifier">i</span>],<span class="ruby-identifier">format_header</span>)
4285:     <span class="ruby-keyword kw">end</span>
4286:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,(<span class="ruby-value">3</span><span class="ruby-operator">+</span><span class="ruby-identifier">col</span>),<span class="ruby-value str">&quot;Action (Count)&quot;</span>,<span class="ruby-identifier">format_header</span>)
4287:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,(<span class="ruby-value">12</span><span class="ruby-operator">+</span><span class="ruby-identifier">col</span>),<span class="ruby-value str">&quot;Task (Count)&quot;</span>,<span class="ruby-identifier">format_header</span>)
4288:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,(<span class="ruby-value">17</span><span class="ruby-operator">+</span><span class="ruby-identifier">col</span>),<span class="ruby-value str">&quot;Sales (Amount)&quot;</span>,<span class="ruby-identifier">format_header</span>)
4289:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,(<span class="ruby-value">23</span><span class="ruby-operator">+</span><span class="ruby-identifier">col</span>),<span class="ruby-value str">&quot;Sales (Count)&quot;</span>,<span class="ruby-identifier">format_header</span>)
4290:     <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4291:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,(<span class="ruby-value">1</span><span class="ruby-operator">+</span><span class="ruby-identifier">col</span>),<span class="ruby-value str">&quot;Visit&quot;</span>,<span class="ruby-identifier">format_header</span>)
4292:     <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4293:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span>,<span class="ruby-value str">&quot;New&quot;</span>,<span class="ruby-identifier">format_header</span>)
4294:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>,<span class="ruby-value str">&quot;Routine&quot;</span>,<span class="ruby-identifier">format_header</span>)
4295:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">2</span>,<span class="ruby-value str">&quot;Special&quot;</span>,<span class="ruby-identifier">format_header</span>)
4296:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">3</span>,<span class="ruby-value str">&quot;Assembly Tech '10&quot;</span>,<span class="ruby-identifier">format_header</span>)
4297:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">4</span>,<span class="ruby-value str">&quot;Metalex '10&quot;</span>,<span class="ruby-identifier">format_header</span>)
4298:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">5</span>,<span class="ruby-value str">&quot;Tel&quot;</span>,<span class="ruby-identifier">format_header</span>)
4299:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">6</span>,<span class="ruby-value str">&quot;E-Mail&quot;</span>,<span class="ruby-identifier">format_header</span>)
4300:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">7</span>,<span class="ruby-value str">&quot;Direct Mail&quot;</span>,<span class="ruby-identifier">format_header</span>)
4301:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">8</span>,<span class="ruby-value str">&quot;Other&quot;</span>,<span class="ruby-identifier">format_header</span>)
4302:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">9</span>,<span class="ruby-value str">&quot;Request Quotation&quot;</span>,<span class="ruby-identifier">format_header</span>)
4303:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">10</span>,<span class="ruby-value str">&quot;Follow Project&quot;</span>,<span class="ruby-identifier">format_header</span>)
4304:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">11</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-identifier">format_header</span>)
4305:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">12</span>,<span class="ruby-value str">&quot;Training&quot;</span>,<span class="ruby-identifier">format_header</span>)
4306:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">13</span>,<span class="ruby-value str">&quot;Claim Trouble&quot;</span>,<span class="ruby-identifier">format_header</span>)
4307:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">14</span>,<span class="ruby-value str">&quot;Other&quot;</span>,<span class="ruby-identifier">format_header</span>)
4308:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">15</span>,<span class="ruby-value str">&quot;Quotation&quot;</span>,<span class="ruby-identifier">format_header</span>)
4309:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">16</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-identifier">format_header</span>)
4310:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">17</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-identifier">format_header</span>)
4311:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">18</span>,<span class="ruby-value str">&quot;Invoice&quot;</span>,<span class="ruby-identifier">format_header</span>)
4312:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">19</span>,<span class="ruby-value str">&quot;Payment&quot;</span>,<span class="ruby-identifier">format_header</span>)
4313:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">20</span>,<span class="ruby-value str">&quot;Quotation&quot;</span>,<span class="ruby-identifier">format_header</span>)
4314:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">21</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-identifier">format_header</span>)
4315:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">22</span>,<span class="ruby-value str">&quot;Delivery&quot;</span>,<span class="ruby-identifier">format_header</span>)
4316:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">23</span>,<span class="ruby-value str">&quot;Invoice&quot;</span>,<span class="ruby-identifier">format_header</span>)
4317:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">col</span><span class="ruby-operator">+</span><span class="ruby-value">24</span>,<span class="ruby-value str">&quot;Payment&quot;</span>,<span class="ruby-identifier">format_header</span>)
4318:     <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4319: 
4320:     <span class="ruby-comment cmt"># Start to insert data</span>
4321:     <span class="ruby-identifier">result</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span>, <span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-comment cmt">#1</span>
4322:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
4323:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">p</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">empty?</span>
4324:         <span class="ruby-identifier">p</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">b</span>,<span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-comment cmt">#2</span>
4325:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>
4326:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">b</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">empty?</span>
4327:               <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">p</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4328:               <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">1</span>,<span class="ruby-identifier">b</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4329:               <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4330:             <span class="ruby-keyword kw">end</span>
4331:             <span class="ruby-identifier">b</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-comment cmt">#3</span>
4332:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>
4333:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">s</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">empty?</span>
4334:                   <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">p</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4335:                   <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">1</span>,<span class="ruby-identifier">b</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4336:                   <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">2</span>,<span class="ruby-identifier">s</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4337:                   <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4338:                 <span class="ruby-keyword kw">end</span>
4339:                 <span class="ruby-identifier">s</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span>,<span class="ruby-identifier">j</span><span class="ruby-operator">|</span> <span class="ruby-comment cmt">#4</span>
4340:                   <span class="ruby-keyword kw">if</span>  <span class="ruby-identifier">col</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">4</span>
4341:                     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">empty?</span>
4342:                       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">p</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4343:                       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">1</span>,<span class="ruby-identifier">b</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4344:                       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">2</span>,<span class="ruby-identifier">s</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4345:                       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">3</span>,<span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4346:                       <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4347:                     <span class="ruby-keyword kw">end</span>
4348:                     <span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span>,<span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-comment cmt">#5</span>
4349:                       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">p</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4350:                       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">1</span>,<span class="ruby-identifier">b</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4351:                       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">2</span>,<span class="ruby-identifier">s</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4352:                       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">3</span>,<span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4353:                       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">4</span>,<span class="ruby-identifier">c</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4354:                       <span class="ruby-identifier">coln</span> = <span class="ruby-value">5</span>
4355:                       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">action</span>
4356:                         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">c</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;action&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4357:                         <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4358:                       <span class="ruby-keyword kw">end</span>
4359:                       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">task</span>
4360:                         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">c</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;task&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4361:                         <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4362:                       <span class="ruby-keyword kw">end</span>
4363:                       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">business</span>
4364:                         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">c</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;business&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4365:                         <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4366:                       <span class="ruby-keyword kw">end</span>
4367:                       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">business_count</span>
4368:                         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">c</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;business&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4369:                         <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4370:                       <span class="ruby-keyword kw">end</span>
4371:                       <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4372:                     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End r[1] - 5</span>
4373:                   <span class="ruby-keyword kw">else</span>
4374:                     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">p</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4375:                     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">1</span>,<span class="ruby-identifier">b</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4376:                     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">2</span>,<span class="ruby-identifier">s</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4377:                     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">3</span>,<span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4378:                     <span class="ruby-identifier">coln</span> = <span class="ruby-value">4</span>
4379:                     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">action</span>
4380:                       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;action&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4381:                       <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4382:                     <span class="ruby-keyword kw">end</span>
4383:                     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">task</span>
4384:                       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;task&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4385:                       <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4386:                     <span class="ruby-keyword kw">end</span>
4387:                     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">business</span>
4388:                       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;business&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4389:                       <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4390:                     <span class="ruby-keyword kw">end</span>
4391:                     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">business_count</span>
4392:                       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;business&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4393:                       <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4394:                     <span class="ruby-keyword kw">end</span>
4395:                     <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4396:                   <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End if col &gt; 4</span>
4397:                 <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End s[1] - 4</span>
4398:               <span class="ruby-keyword kw">else</span>
4399:                 <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">p</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4400:                 <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">1</span>,<span class="ruby-identifier">b</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4401:                 <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">2</span>,<span class="ruby-identifier">s</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4402:                 <span class="ruby-identifier">coln</span> = <span class="ruby-value">3</span>
4403:                 <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">action</span>
4404:                   <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">s</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;action&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4405:                   <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4406:                 <span class="ruby-keyword kw">end</span>
4407:                 <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">task</span>
4408:                   <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">s</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;task&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4409:                   <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4410:                 <span class="ruby-keyword kw">end</span>
4411:                 <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">business</span>
4412:                   <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">s</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;business&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4413:                   <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4414:                 <span class="ruby-keyword kw">end</span>
4415:                 <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">business_count</span>
4416:                   <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">s</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;business&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4417:                   <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4418:                 <span class="ruby-keyword kw">end</span>
4419:                 <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4420:               <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End if col &gt; 3</span>
4421:             <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End b[1] - 3</span>
4422:           <span class="ruby-keyword kw">else</span>
4423:             <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">p</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4424:             <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">1</span>,<span class="ruby-identifier">b</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4425:             <span class="ruby-identifier">coln</span> = <span class="ruby-value">2</span>
4426:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">action</span>
4427:               <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">b</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;action&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4428:               <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4429:             <span class="ruby-keyword kw">end</span>
4430:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">task</span>
4431:               <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">b</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;task&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4432:               <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4433:             <span class="ruby-keyword kw">end</span>
4434:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">business</span>
4435:               <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">b</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;business&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4436:               <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4437:             <span class="ruby-keyword kw">end</span>
4438:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">business_count</span>
4439:               <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">b</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;business&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4440:               <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4441:             <span class="ruby-keyword kw">end</span>
4442:             <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4443:           <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End if col &gt; 2</span>
4444:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End p[1] - 2</span>
4445:       <span class="ruby-keyword kw">else</span>
4446:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">p</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>)
4447:         <span class="ruby-identifier">coln</span> = <span class="ruby-value">1</span>
4448:         <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">action</span>
4449:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">p</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;action&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4450:           <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4451:         <span class="ruby-keyword kw">end</span>
4452:         <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">task</span>
4453:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">p</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;task&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4454:           <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4455:         <span class="ruby-keyword kw">end</span>
4456:         <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">business</span>
4457:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">p</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;business&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4458:           <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4459:         <span class="ruby-keyword kw">end</span>
4460:         <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">business_count</span>
4461:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">p</span>[<span class="ruby-value">1</span>][<span class="ruby-value str">&quot;business&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_data</span>)
4462:           <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4463:         <span class="ruby-keyword kw">end</span>
4464:         <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4465:       <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End if col &gt; 1</span>
4466:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End result - 1</span>
4467:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-value str">&quot;Grand Total&quot;</span>,<span class="ruby-identifier">format_data</span>)
4468:     <span class="ruby-identifier">coln</span> = <span class="ruby-identifier">col</span>
4469:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">action</span>
4470:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">total</span>[<span class="ruby-value str">&quot;action&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>,<span class="ruby-identifier">format_data</span>)
4471:       <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4472:     <span class="ruby-keyword kw">end</span>
4473:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">task</span>
4474:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">total</span>[<span class="ruby-value str">&quot;task&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>,<span class="ruby-identifier">format_data</span>)
4475:       <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4476:     <span class="ruby-keyword kw">end</span>
4477:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">business</span>
4478:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">total</span>[<span class="ruby-value str">&quot;business&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>,<span class="ruby-identifier">format_data</span>)
4479:       <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4480:     <span class="ruby-keyword kw">end</span>
4481:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">business_count</span>
4482:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">coln</span>,<span class="ruby-identifier">total</span>[<span class="ruby-value str">&quot;business&quot;</span>][<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>,<span class="ruby-identifier">format_data</span>)
4483:       <span class="ruby-identifier">coln</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4484:     <span class="ruby-keyword kw">end</span>
4485: 
4486:     <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">close</span>
4487:     <span class="ruby-identifier">send_file</span>(<span class="ruby-identifier">file_path</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'attachment'</span>, <span class="ruby-identifier">:encoding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'utf8'</span>, <span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'application/octet-stream'</span>)
4488:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000605" class="method-detail">
        <a name="M000605"></a>

        <div class="method-heading">
          <a href="#M000605" class="method-signature">
          <span class="method-name">export_compare_action</span><span class="method-args">(result,total,dfrom,dto,loop,rpt_type,rpt_name)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000605-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000605-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 4960</span>
4960:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">export_compare_action</span>(<span class="ruby-identifier">result</span>,<span class="ruby-identifier">total</span>,<span class="ruby-identifier">dfrom</span>,<span class="ruby-identifier">dto</span>,<span class="ruby-identifier">loop</span>,<span class="ruby-identifier">rpt_type</span>,<span class="ruby-identifier">rpt_name</span>)
4961:     <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-value str">&quot;%Y%m%d%H%M%S&quot;</span>)
4962:           <span class="ruby-identifier">file_name</span> = <span class="ruby-node">&quot;ActionReport_#{time}&quot;</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot; &quot;</span>,<span class="ruby-value str">&quot;_&quot;</span>)
4963:           <span class="ruby-identifier">file_path</span> = <span class="ruby-node">&quot;#{RAILS_ROOT}/public/ReportFile/#{file_name}.xls&quot;</span>
4964:           <span class="ruby-identifier">workbook</span>  = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">WriteExcel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;#{file_path}&quot;</span>);
4965:           <span class="ruby-identifier">format_title</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:bold</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>, <span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">14</span>)
4966:           <span class="ruby-identifier">format_header</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:bold</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>, <span class="ruby-identifier">:bg_color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">27</span> ,<span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">12</span>,<span class="ruby-identifier">:align</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'vcenter'</span>)
4967:           <span class="ruby-identifier">format_data</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>,<span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">10</span>)
4968:           <span class="ruby-identifier">worksheet</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_worksheet</span>
4969: 
4970:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value">0</span>,<span class="ruby-value">5</span>,<span class="ruby-identifier">rpt_name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; Report&quot;</span>,<span class="ruby-identifier">format_title</span>)
4971:     <span class="ruby-identifier">i</span> = <span class="ruby-value">3</span>
4972:     <span class="ruby-identifier">j</span> = <span class="ruby-value">0</span>
4973:     <span class="ruby-identifier">n</span> = <span class="ruby-value">6</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">loop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>
4974:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">2</span><span class="ruby-operator">..</span><span class="ruby-value">3</span>
4975:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">j</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>
4976:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>,<span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_header</span>)
4977:       <span class="ruby-keyword kw">end</span>
4978:       <span class="ruby-identifier">i</span><span class="ruby-operator">+=</span><span class="ruby-value">1</span>
4979:       <span class="ruby-identifier">j</span>=<span class="ruby-value">0</span>
4980:     <span class="ruby-keyword kw">end</span>
4981: 
4982:     <span class="ruby-identifier">row</span> = <span class="ruby-value">2</span>
4983:     <span class="ruby-comment cmt"># Header</span>
4984:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-value str">&quot;Sales Office&quot;</span>,<span class="ruby-identifier">format_header</span>)
4985:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">1</span>,<span class="ruby-value str">&quot;Salesman&quot;</span>,<span class="ruby-identifier">format_header</span>)
4986:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">2</span>,<span class="ruby-value str">&quot;Rank&quot;</span>,<span class="ruby-identifier">format_header</span>)
4987:     <span class="ruby-identifier">nloop</span> = <span class="ruby-value">1</span>
4988:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">nloop</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">loop</span>
4989:       <span class="ruby-identifier">datefrom_to</span> = <span class="ruby-value str">&quot;&quot;</span>
4990:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">rpt_type</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">2</span>
4991:         <span class="ruby-identifier">datefrom_to</span> = (<span class="ruby-identifier">dto</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">dfrom</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">dto</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">dfrom</span>[<span class="ruby-identifier">nloop</span>] <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; to &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dto</span>[<span class="ruby-identifier">nloop</span>])
4992:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">rpt_type</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>
4993:         <span class="ruby-identifier">datefrom_to</span> = <span class="ruby-identifier">dfrom</span>[<span class="ruby-identifier">nloop</span>].<span class="ruby-identifier">to_date</span>.<span class="ruby-identifier">month</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;/&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dfrom</span>[<span class="ruby-identifier">nloop</span>].<span class="ruby-identifier">to_date</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_s</span>
4994:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">rpt_type</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span>
4995:         <span class="ruby-identifier">datefrom_to</span> = <span class="ruby-value str">'Year '</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dfrom</span>[<span class="ruby-identifier">nloop</span>].<span class="ruby-identifier">to_date</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_s</span>
4996:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">rpt_type</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">5</span>
4997:         <span class="ruby-identifier">datefrom_to</span> = <span class="ruby-value str">'Q'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'/'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dfrom</span>[<span class="ruby-identifier">nloop</span>].<span class="ruby-identifier">to_date</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_s</span>
4998:       <span class="ruby-keyword kw">end</span>
4999:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">4</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>,<span class="ruby-identifier">datefrom_to</span>,<span class="ruby-identifier">format_header</span>)
5000:       <span class="ruby-identifier">nloop</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
5001:     <span class="ruby-keyword kw">end</span>
5002:     <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
5003:     <span class="ruby-identifier">nloop</span> = <span class="ruby-value">1</span>
5004:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">nloop</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">loop</span>
5005:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">3</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>,<span class="ruby-value str">&quot;New&quot;</span>,<span class="ruby-identifier">format_header</span>)
5006:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">4</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>,<span class="ruby-value str">&quot;Routine&quot;</span>,<span class="ruby-identifier">format_header</span>)
5007:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">5</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>,<span class="ruby-value str">&quot;Special&quot;</span>,<span class="ruby-identifier">format_header</span>)
5008:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">6</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>,<span class="ruby-value str">&quot;P/O&quot;</span>,<span class="ruby-identifier">format_header</span>)
5009:       <span class="ruby-identifier">nloop</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
5010:     <span class="ruby-keyword kw">end</span>
5011:     <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
5012: 
5013:     <span class="ruby-identifier">result</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">b</span>, <span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
5014:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">b</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>) <span class="ruby-comment cmt">#Sales Office</span>
5015:       <span class="ruby-identifier">b</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
5016:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">1</span>,<span class="ruby-identifier">s</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>) <span class="ruby-comment cmt">#Salesman</span>
5017:         <span class="ruby-identifier">s</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span>,<span class="ruby-identifier">j</span><span class="ruby-operator">|</span>
5018:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">2</span>,<span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">format_data</span>) <span class="ruby-comment cmt">#Potential Rank</span>
5019:           <span class="ruby-identifier">nloop</span> = <span class="ruby-value">1</span>
5020:           <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">nloop</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">loop</span>
5021:             <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">3</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>,<span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-value str">&quot;New Visit&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;-&quot;</span>,<span class="ruby-identifier">format_data</span>) <span class="ruby-comment cmt">#New Visit</span>
5022:             <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">4</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>,<span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-value str">&quot;Routine&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;-&quot;</span>,<span class="ruby-identifier">format_data</span>) <span class="ruby-comment cmt">#Routine</span>
5023:             <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">5</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>,<span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-value str">&quot;Special&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;-&quot;</span>,<span class="ruby-identifier">format_data</span>) <span class="ruby-comment cmt">#Special</span>
5024:             <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">6</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>,<span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-value str">&quot;P/O&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value str">&quot;-&quot;</span>,<span class="ruby-identifier">format_data</span>) <span class="ruby-comment cmt">#P/O</span>
5025:             <span class="ruby-identifier">nloop</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
5026:           <span class="ruby-keyword kw">end</span>
5027:           <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
5028:         <span class="ruby-keyword kw">end</span>
5029:         <span class="ruby-comment cmt">#Add Total</span>
5030:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">2</span>,<span class="ruby-value str">&quot;Total&quot;</span>,<span class="ruby-identifier">format_data</span>)
5031:         <span class="ruby-identifier">nloop</span> = <span class="ruby-value">1</span>
5032:         <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">nloop</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">loop</span>
5033:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">3</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>,<span class="ruby-identifier">total</span>[<span class="ruby-identifier">s</span>[<span class="ruby-value">0</span>]][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-value str">&quot;New Visit&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>,<span class="ruby-identifier">format_data</span>) <span class="ruby-comment cmt">#New Visit</span>
5034:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">4</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>,<span class="ruby-identifier">total</span>[<span class="ruby-identifier">s</span>[<span class="ruby-value">0</span>]][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-value str">&quot;Routine&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>,<span class="ruby-identifier">format_data</span>) <span class="ruby-comment cmt">#Routine</span>
5035:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">5</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>,<span class="ruby-identifier">total</span>[<span class="ruby-identifier">s</span>[<span class="ruby-value">0</span>]][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-value str">&quot;Special&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>,<span class="ruby-identifier">format_data</span>) <span class="ruby-comment cmt">#Special</span>
5036:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">6</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">nloop</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>,<span class="ruby-identifier">total</span>[<span class="ruby-identifier">s</span>[<span class="ruby-value">0</span>]][<span class="ruby-identifier">nloop</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-value str">&quot;P/O&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>,<span class="ruby-identifier">format_data</span>) <span class="ruby-comment cmt">#P/O</span>
5037:           <span class="ruby-identifier">nloop</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
5038:         <span class="ruby-keyword kw">end</span>
5039:         <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
5040:       <span class="ruby-keyword kw">end</span>
5041:     <span class="ruby-keyword kw">end</span>
5042:     <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">close</span>
5043:     <span class="ruby-identifier">send_file</span>(<span class="ruby-identifier">file_path</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'attachment'</span>, <span class="ruby-identifier">:encoding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'utf8'</span>, <span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'application/octet-stream'</span>)
5044:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000584" class="method-detail">
        <a name="M000584"></a>

        <div class="method-heading">
          <a href="#M000584" class="method-signature">
          <span class="method-name">export_grand_total</span><span class="method-args">(name,headers,report_data,report_total,report_gtotal,dfrom, dto)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000584-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000584-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1624</span>
1624:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">export_grand_total</span>(<span class="ruby-identifier">name</span>,<span class="ruby-identifier">headers</span>,<span class="ruby-identifier">report_data</span>,<span class="ruby-identifier">report_total</span>,<span class="ruby-identifier">report_gtotal</span>,<span class="ruby-identifier">dfrom</span>, <span class="ruby-identifier">dto</span>)
1625:     <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-value str">&quot;%Y%m%d%H%M%S&quot;</span>)
1626:           <span class="ruby-identifier">file_name</span> = <span class="ruby-node">&quot;#{name}_#{time}&quot;</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot; &quot;</span>,<span class="ruby-value str">&quot;_&quot;</span>)
1627:           <span class="ruby-identifier">file_path</span> = <span class="ruby-node">&quot;#{RAILS_ROOT}/public/ReportFile/#{file_name}.xls&quot;</span>
1628:           <span class="ruby-identifier">workbook</span>  = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">WriteExcel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;#{file_path}&quot;</span>);
1629:           <span class="ruby-identifier">format_title</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:bold</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>, <span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">14</span>,<span class="ruby-identifier">:merge</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">5</span>)
1630:           <span class="ruby-identifier">format_header</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:bold</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>, <span class="ruby-identifier">:bg_color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">27</span> ,<span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">12</span>,<span class="ruby-identifier">:merge</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">:align</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'vcenter'</span>)
1631:           <span class="ruby-identifier">format_data</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>,<span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">10</span>)
1632:           <span class="ruby-identifier">worksheet</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_worksheet</span>
1633: 
1634:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">name</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot;_&quot;</span>,<span class="ruby-value str">&quot; &quot;</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; Report&quot;</span>,<span class="ruby-identifier">format_title</span>)
1635:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value">1</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">dfrom</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;  to  &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dto</span>,<span class="ruby-identifier">format_title</span>)
1636:     
1637:     <span class="ruby-identifier">row</span> = <span class="ruby-value">4</span>
1638:     <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">header</span>,<span class="ruby-identifier">column</span><span class="ruby-operator">|</span>
1639:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">header</span>,<span class="ruby-identifier">format_header</span>)
1640:     <span class="ruby-keyword kw">end</span>
1641:     
1642:     <span class="ruby-identifier">report_data</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">first_data</span>,<span class="ruby-identifier">second_datas</span><span class="ruby-operator">|</span>
1643:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">first_data</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;N/A&quot;</span>
1644:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">first_data</span>,<span class="ruby-identifier">format_data</span>)
1645:       <span class="ruby-keyword kw">else</span>
1646:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">retrieve_result</span>(<span class="ruby-identifier">first_data</span>),<span class="ruby-identifier">format_data</span>)
1647:       <span class="ruby-keyword kw">end</span>
1648:       
1649:       <span class="ruby-identifier">round_of_second_datas</span> = <span class="ruby-value">1</span>
1650:       <span class="ruby-identifier">second_datas</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">second_data</span>,<span class="ruby-identifier">third_datas</span><span class="ruby-operator">|</span>
1651:         <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">round_of_second_datas</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
1652:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">1</span>,<span class="ruby-identifier">retrieve_result</span>(<span class="ruby-identifier">second_data</span>),<span class="ruby-identifier">format_data</span>)
1653:         <span class="ruby-identifier">round_of_third_datas</span> = <span class="ruby-value">1</span>
1654:         <span class="ruby-identifier">third_datas</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">third_data</span>,<span class="ruby-identifier">forth_datas</span><span class="ruby-operator">|</span>
1655:           <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">round_of_third_datas</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
1656:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">2</span>,<span class="ruby-identifier">retrieve_result</span>(<span class="ruby-identifier">third_data</span>),<span class="ruby-identifier">format_data</span>)
1657:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">4</span>
1658:             <span class="ruby-identifier">round_of_forth_datas</span> = <span class="ruby-value">1</span>
1659:             <span class="ruby-identifier">forth_datas</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">forth_data</span>,<span class="ruby-identifier">fifth_datas</span><span class="ruby-operator">|</span>
1660:               <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">round_of_forth_datas</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
1661:               <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">3</span>,<span class="ruby-identifier">retrieve_result</span>(<span class="ruby-identifier">forth_data</span>),<span class="ruby-identifier">format_data</span>)
1662:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">5</span>
1663:                 <span class="ruby-identifier">round_of_fifth_datas</span> = <span class="ruby-value">1</span>
1664:                 <span class="ruby-identifier">fifth_datas</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fifth_data</span>,<span class="ruby-identifier">sixth_data</span><span class="ruby-operator">|</span>
1665:                   <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">round_of_fifth_datas</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
1666:                   <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">4</span>,<span class="ruby-identifier">retrieve_result</span>(<span class="ruby-identifier">fifth_data</span>),<span class="ruby-identifier">format_data</span>)
1667:                   <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">5</span>,<span class="ruby-identifier">sixth_data</span>,<span class="ruby-identifier">format_data</span>)
1668:                   <span class="ruby-identifier">round_of_fifth_datas</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1669:                 <span class="ruby-keyword kw">end</span>
1670:               <span class="ruby-keyword kw">else</span>
1671:                 <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">4</span>,<span class="ruby-identifier">fifth_datas</span>,<span class="ruby-identifier">format_data</span>)
1672:               <span class="ruby-keyword kw">end</span>
1673:               <span class="ruby-identifier">round_of_forth_datas</span> <span class="ruby-operator">+=</span><span class="ruby-value">1</span>
1674:             <span class="ruby-keyword kw">end</span>
1675:           <span class="ruby-keyword kw">else</span>
1676:             <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">3</span>,<span class="ruby-identifier">forth_datas</span>,<span class="ruby-identifier">format_data</span>)
1677:           <span class="ruby-keyword kw">end</span>
1678:           <span class="ruby-identifier">round_of_third_datas</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1679:         <span class="ruby-keyword kw">end</span>
1680:         <span class="ruby-identifier">round_of_second_datas</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1681:       <span class="ruby-keyword kw">end</span>
1682:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>,<span class="ruby-identifier">headers</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>,<span class="ruby-value str">&quot;Total&quot;</span>,<span class="ruby-identifier">format_data</span>)
1683:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>,<span class="ruby-identifier">headers</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">first_data</span>],<span class="ruby-identifier">format_data</span>)
1684:       <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">2</span>
1685:     <span class="ruby-keyword kw">end</span>
1686:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">headers</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>,<span class="ruby-value str">&quot;Grand Total&quot;</span>,<span class="ruby-identifier">format_data</span>)
1687:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-identifier">headers</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">report_gtotal</span>,<span class="ruby-identifier">format_data</span>)
1688:     <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">close</span>
1689:     <span class="ruby-identifier">send_file</span>(<span class="ruby-identifier">file_path</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'attachment'</span>, <span class="ruby-identifier">:encoding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'utf8'</span>, <span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'application/octet-stream'</span>)
1690:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000585" class="method-detail">
        <a name="M000585"></a>

        <div class="method-heading">
          <a href="#M000585" class="method-signature">
          <span class="method-name">export_grand_total_billcount</span><span class="method-args">(name,headers,report_data,report_total,report_gtotal,dfrom, dto)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000585-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000585-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1691</span>
1691:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">export_grand_total_billcount</span>(<span class="ruby-identifier">name</span>,<span class="ruby-identifier">headers</span>,<span class="ruby-identifier">report_data</span>,<span class="ruby-identifier">report_total</span>,<span class="ruby-identifier">report_gtotal</span>,<span class="ruby-identifier">dfrom</span>, <span class="ruby-identifier">dto</span>)
1692:     <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-value str">&quot;%Y%m%d%H%M%S&quot;</span>)
1693:           <span class="ruby-identifier">file_name</span> = <span class="ruby-node">&quot;#{name}_#{time}&quot;</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot; &quot;</span>,<span class="ruby-value str">&quot;_&quot;</span>)
1694:           <span class="ruby-identifier">file_path</span> = <span class="ruby-node">&quot;#{RAILS_ROOT}/public/ReportFile/#{file_name}.xls&quot;</span>
1695:           <span class="ruby-identifier">workbook</span>  = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">WriteExcel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;#{file_path}&quot;</span>);
1696:           <span class="ruby-identifier">format_title</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:bold</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>, <span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">14</span>,<span class="ruby-identifier">:merge</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">5</span>)
1697:           <span class="ruby-identifier">format_header</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:bold</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>, <span class="ruby-identifier">:bg_color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">27</span> ,<span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">12</span>,<span class="ruby-identifier">:merge</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">:align</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'vcenter'</span>)
1698:           <span class="ruby-identifier">format_data</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>,<span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">10</span>)
1699:           <span class="ruby-identifier">worksheet</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_worksheet</span>
1700: 
1701:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value">0</span>,<span class="ruby-value">2</span>,<span class="ruby-identifier">name</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot;_&quot;</span>,<span class="ruby-value str">&quot; &quot;</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; Report&quot;</span>,<span class="ruby-identifier">format_title</span>)
1702:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value">1</span>,<span class="ruby-value">2</span>,<span class="ruby-identifier">dfrom</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;  to  &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dto</span>,<span class="ruby-identifier">format_title</span>)
1703: 
1704:     <span class="ruby-identifier">row</span> = <span class="ruby-value">4</span>
1705:     <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">header</span>,<span class="ruby-identifier">column</span><span class="ruby-operator">|</span>
1706:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">header</span>,<span class="ruby-identifier">format_header</span>)
1707:     <span class="ruby-keyword kw">end</span>
1708: 
1709:     <span class="ruby-identifier">report_data</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">first_data</span>,<span class="ruby-identifier">second_datas</span><span class="ruby-operator">|</span>
1710:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">retrieve_result</span>(<span class="ruby-identifier">first_data</span>),<span class="ruby-identifier">format_data</span>)
1711:       <span class="ruby-identifier">second_datas</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">second_data</span>,<span class="ruby-identifier">third_datas</span><span class="ruby-operator">|</span>
1712:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">1</span>,<span class="ruby-identifier">retrieve_result</span>(<span class="ruby-identifier">second_data</span>),<span class="ruby-identifier">format_data</span>)
1713:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">2</span>,<span class="ruby-identifier">third_datas</span>[<span class="ruby-value str">'Quotation'</span>],<span class="ruby-identifier">format_data</span>)
1714:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">3</span>,<span class="ruby-identifier">third_datas</span>[<span class="ruby-value str">'P/O'</span>],<span class="ruby-identifier">format_data</span>)
1715:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">4</span>,<span class="ruby-identifier">third_datas</span>[<span class="ruby-value str">'Invoice'</span>],<span class="ruby-identifier">format_data</span>)
1716:         <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1717:       <span class="ruby-keyword kw">end</span>
1718:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">1</span>,<span class="ruby-value str">&quot;Total&quot;</span>,<span class="ruby-identifier">format_data</span>)
1719:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">2</span>,<span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">first_data</span>][<span class="ruby-value str">'Quotation'</span>],<span class="ruby-identifier">format_data</span>)
1720:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">3</span>,<span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">first_data</span>][<span class="ruby-value str">'P/O'</span>],<span class="ruby-identifier">format_data</span>)
1721:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">4</span>,<span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">first_data</span>][<span class="ruby-value str">'Invoice'</span>],<span class="ruby-identifier">format_data</span>)
1722:       <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1723:     <span class="ruby-keyword kw">end</span>
1724:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">1</span>,<span class="ruby-value str">&quot;Grand Total&quot;</span>,<span class="ruby-identifier">format_data</span>)
1725:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">2</span>,<span class="ruby-identifier">report_gtotal</span>[<span class="ruby-value str">'Quotation'</span>],<span class="ruby-identifier">format_data</span>)
1726:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">3</span>,<span class="ruby-identifier">report_gtotal</span>[<span class="ruby-value str">'P/O'</span>],<span class="ruby-identifier">format_data</span>)
1727:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">row</span>,<span class="ruby-value">4</span>,<span class="ruby-identifier">report_gtotal</span>[<span class="ruby-value str">'Invoice'</span>],<span class="ruby-identifier">format_data</span>)
1728:     <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">close</span>
1729:     <span class="ruby-identifier">send_file</span>(<span class="ruby-identifier">file_path</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'attachment'</span>, <span class="ruby-identifier">:encoding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'utf8'</span>, <span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'application/octet-stream'</span>)
1730:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000602" class="method-detail">
        <a name="M000602"></a>

        <div class="method-heading">
          <a href="#M000602" class="method-signature">
          <span class="method-name">export_rank_history</span><span class="method-args">(report_data,from_year,to_year,product_type_names,customer_names,rank_names)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000602-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000602-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 4603</span>
4603:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">export_rank_history</span>(<span class="ruby-identifier">report_data</span>,<span class="ruby-identifier">from_year</span>,<span class="ruby-identifier">to_year</span>,<span class="ruby-identifier">product_type_names</span>,<span class="ruby-identifier">customer_names</span>,<span class="ruby-identifier">rank_names</span>)
4604:     <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-value str">&quot;%Y%m%d%H%M%S&quot;</span>)
4605:           <span class="ruby-identifier">file_name</span> = <span class="ruby-node">&quot;RankReport_#{time}&quot;</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot; &quot;</span>,<span class="ruby-value str">&quot;_&quot;</span>)
4606:           <span class="ruby-identifier">file_path</span> = <span class="ruby-node">&quot;#{RAILS_ROOT}/public/ReportFile/#{file_name}.xls&quot;</span>
4607:           <span class="ruby-identifier">workbook</span>  = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">WriteExcel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;#{file_path}&quot;</span>);
4608:           <span class="ruby-identifier">format_a</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:bold</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>, <span class="ruby-identifier">:bg_color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">27</span> ,<span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">12</span>,<span class="ruby-identifier">:merge</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,<span class="ruby-identifier">:align</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'vcenter'</span>)
4609:           <span class="ruby-identifier">format_b</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>,<span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">10</span>)
4610:     <span class="ruby-identifier">format_c</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>,<span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">10</span>,<span class="ruby-identifier">:align</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'vcenter'</span>)
4611:           <span class="ruby-identifier">worksheet</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_worksheet</span>
4612:     <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-value str">&quot;Customer&quot;</span>,<span class="ruby-identifier">format_b</span>)
4613:     <span class="ruby-identifier">c</span> = <span class="ruby-value">1</span>
4614: 
4615:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">year</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">from_year</span><span class="ruby-operator">..</span><span class="ruby-identifier">to_year</span>
4616:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">merge_cells</span>(<span class="ruby-value">0</span>,<span class="ruby-identifier">c</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">c</span><span class="ruby-operator">+</span>((<span class="ruby-identifier">product_type_names</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">*</span><span class="ruby-value">2</span>) <span class="ruby-operator">-</span><span class="ruby-value">1</span>))
4617:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value">0</span>,<span class="ruby-identifier">c</span>,<span class="ruby-identifier">year</span>,<span class="ruby-identifier">format_b</span>)
4618:       <span class="ruby-identifier">c</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">product_type_names</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">*</span> <span class="ruby-value">2</span>
4619:     <span class="ruby-keyword kw">end</span>
4620:     <span class="ruby-identifier">c</span> = <span class="ruby-value">1</span>
4621:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">year</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">from_year</span><span class="ruby-operator">..</span><span class="ruby-identifier">to_year</span>
4622:       <span class="ruby-identifier">product_type_names</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">product_type_name</span><span class="ruby-operator">|</span>
4623:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">merge_cells</span>(<span class="ruby-value">1</span>,<span class="ruby-identifier">c</span>,<span class="ruby-value">1</span>,<span class="ruby-identifier">c</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>)
4624:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value">1</span>,<span class="ruby-identifier">c</span>,<span class="ruby-node">&quot;#{product_type_name}&quot;</span>,<span class="ruby-identifier">format_b</span>)
4625:         <span class="ruby-identifier">c</span> <span class="ruby-operator">+=</span> <span class="ruby-value">2</span>
4626:       <span class="ruby-keyword kw">end</span>
4627:     <span class="ruby-keyword kw">end</span>
4628:     <span class="ruby-identifier">line</span> = <span class="ruby-value">2</span>
4629:     <span class="ruby-identifier">customer_names</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">customer</span><span class="ruby-operator">|</span>
4630:       <span class="ruby-identifier">c</span> = <span class="ruby-value">0</span>
4631:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">c</span>,<span class="ruby-node">&quot;#{customer[1]}&quot;</span>,<span class="ruby-identifier">format_b</span>)
4632:       <span class="ruby-identifier">c</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4633:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">year</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">from_year</span><span class="ruby-operator">..</span><span class="ruby-identifier">to_year</span>
4634:         <span class="ruby-identifier">product_type_names</span>.<span class="ruby-identifier">each_key</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">product_type_id</span><span class="ruby-operator">|</span>
4635:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-node">&quot;#{customer[0]}&quot;</span>].<span class="ruby-identifier">nil?</span>
4636:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-node">&quot;#{customer[0]}&quot;</span>][<span class="ruby-node">&quot;#{year}&quot;</span>].<span class="ruby-identifier">nil?</span>
4637:               <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-node">&quot;#{customer[0]}&quot;</span>][<span class="ruby-node">&quot;#{year}&quot;</span>][<span class="ruby-node">&quot;#{product_type_id}&quot;</span>].<span class="ruby-identifier">nil?</span>
4638:                 <span class="ruby-identifier">value</span> = <span class="ruby-identifier">report_data</span>[<span class="ruby-node">&quot;#{customer[0]}&quot;</span>][<span class="ruby-node">&quot;#{year}&quot;</span>][<span class="ruby-node">&quot;#{product_type_id}&quot;</span>]
4639:                 <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">c</span>,<span class="ruby-node">&quot;#{value.to_f}&quot;</span>,<span class="ruby-identifier">format_b</span>)
4640:                 <span class="ruby-identifier">value</span> = <span class="ruby-identifier">get_name_for_rank_value</span>(<span class="ruby-identifier">report_data</span>[<span class="ruby-node">&quot;#{customer[0]}&quot;</span>][<span class="ruby-node">&quot;#{year}&quot;</span>][<span class="ruby-node">&quot;#{product_type_id}&quot;</span>],<span class="ruby-identifier">rank_names</span>)
4641:                 <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">c</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>,<span class="ruby-node">&quot;#{value}&quot;</span>,<span class="ruby-identifier">format_b</span>)
4642:               <span class="ruby-keyword kw">else</span>
4643:                 <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">c</span>,<span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_b</span>)
4644:                 <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">c</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>,<span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_b</span>)
4645:               <span class="ruby-keyword kw">end</span>
4646:             <span class="ruby-keyword kw">else</span>
4647:               <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">c</span>,<span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_b</span>)
4648:               <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">c</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>,<span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_b</span>)
4649:             <span class="ruby-keyword kw">end</span>
4650:           <span class="ruby-keyword kw">else</span>
4651:             <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">c</span>,<span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_b</span>)
4652:             <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">c</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>,<span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-identifier">format_b</span>)
4653:           <span class="ruby-keyword kw">end</span>
4654:           <span class="ruby-identifier">c</span><span class="ruby-operator">+=</span><span class="ruby-value">2</span>
4655:         <span class="ruby-keyword kw">end</span>
4656:       <span class="ruby-keyword kw">end</span>
4657:       <span class="ruby-identifier">line</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
4658:     <span class="ruby-keyword kw">end</span>
4659:     <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">close</span>
4660:     <span class="ruby-identifier">send_file</span>(<span class="ruby-identifier">file_path</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'attachment'</span>, <span class="ruby-identifier">:encoding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'utf8'</span>, <span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'application/octet-stream'</span>)
4661:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000537" class="method-detail">
        <a name="M000537"></a>

        <div class="method-heading">
          <a href="#M000537" class="method-signature">
          <span class="method-name">fetch_report</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000537-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000537-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 65</span>
65:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">fetch_report</span>
66:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>].<span class="ruby-identifier">to_i</span>)
67: 
68:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
69:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment cmt"># show.html.erb</span>
70:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@report</span> }
71:     <span class="ruby-keyword kw">end</span>
72:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000549" class="method-detail">
        <a name="M000549"></a>

        <div class="method-heading">
          <a href="#M000549" class="method-signature">
          <span class="method-name">formats</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
GET /reports GET /reports.xml
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000549-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000549-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 268</span>
268:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">formats</span>
269:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
270: 
271:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
272:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment cmt"># formats.html.erb</span>
273:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@report</span> }
274:     <span class="ruby-keyword kw">end</span>
275:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000558" class="method-detail">
        <a name="M000558"></a>

        <div class="method-heading">
          <a href="#M000558" class="method-signature">
          <span class="method-name">generate</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000558-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000558-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 402</span>
402:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">generate</span>
403:     <span class="ruby-identifier">screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value str">'screen_id'</span>]).<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;unknown_screen&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value str">'screen_id'</span>]) 
404:     <span class="ruby-identifier">row_ids</span> = <span class="ruby-constant">RowsController</span>.<span class="ruby-identifier">get_session_row_ids</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">id</span>)
405:     <span class="ruby-identifier">rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot; id in (?)&quot;</span>, <span class="ruby-identifier">row_ids</span>]) <span class="ruby-comment cmt">#screen.rows</span>
406:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">&quot;report_type&quot;</span>][<span class="ruby-identifier">:report_type</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;PDF&quot;</span>
407:                   <span class="ruby-identifier">pdf_report</span>(<span class="ruby-identifier">rows</span>)
408:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">&quot;report_type&quot;</span>][<span class="ruby-identifier">:report_type</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;XLS&quot;</span>
409:                   <span class="ruby-identifier">excel_report</span>(<span class="ruby-identifier">rows</span>)
410:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">&quot;report_type&quot;</span>][<span class="ruby-identifier">:report_type</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;CSV&quot;</span>
411:                   <span class="ruby-identifier">csv_report</span>(<span class="ruby-identifier">rows</span>)
412:           <span class="ruby-keyword kw">end</span>
413:     <span class="ruby-identifier">date</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-value str">&quot;%Y%m%d&quot;</span>)
414:     <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-value str">&quot;%H:%M:%S:&quot;</span>)
415:     <span class="ruby-identifier">logfile</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;#{RAILS_ROOT}/public/LogFile/log#{date}.log&quot;</span>,<span class="ruby-value str">&quot;a+&quot;</span>)
416:     <span class="ruby-identifier">logfile</span>.<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{date} #{time} #{session['user']['login']} export #{screen.nil? ? &quot;unknown_screen&quot; : screen.name.gsub(&quot; &quot;,&quot;_&quot;)}_Screen -&quot;</span>
417:     <span class="ruby-identifier">logfile</span>.<span class="ruby-identifier">close</span>
418:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000567" class="method-detail">
        <a name="M000567"></a>

        <div class="method-heading">
          <a href="#M000567" class="method-signature">
          <span class="method-name">get_all_customfield</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000567-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000567-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1018</span>
1018:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_all_customfield</span>
1019:     <span class="ruby-identifier">gen_rows</span> = {}
1020:     <span class="ruby-identifier">customefields</span> = <span class="ruby-constant">CustomField</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>)
1021:     <span class="ruby-identifier">customefields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cf</span><span class="ruby-operator">|</span>
1022:       <span class="ruby-identifier">gen_rows</span>[<span class="ruby-identifier">cf</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span>] = <span class="ruby-identifier">cf</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">gen_rows</span>[<span class="ruby-identifier">cf</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span>].<span class="ruby-identifier">nil?</span>
1023:     <span class="ruby-keyword kw">end</span>
1024:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">gen_rows</span>
1025:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000566" class="method-detail">
        <a name="M000566"></a>

        <div class="method-heading">
          <a href="#M000566" class="method-signature">
          <span class="method-name">get_all_screen</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>==========================</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000566-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000566-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1009</span>
1009:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_all_screen</span>
1010:     <span class="ruby-identifier">gen_rows</span> = {}
1011:     <span class="ruby-identifier">screens</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>)
1012:     <span class="ruby-identifier">screens</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
1013:       <span class="ruby-identifier">gen_rows</span>[<span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span>] = <span class="ruby-identifier">s</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">gen_rows</span>[<span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span>].<span class="ruby-identifier">nil?</span>
1014:     <span class="ruby-keyword kw">end</span>
1015:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">gen_rows</span>
1016:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000569" class="method-detail">
        <a name="M000569"></a>

        <div class="method-heading">
          <a href="#M000569" class="method-signature">
          <span class="method-name">get_custom_field_id_by_name</span><span class="method-args">(custom_field_name)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000569-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000569-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1040</span>
1040:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-identifier">custom_field_name</span>)
1041:     <span class="ruby-identifier">result</span> = <span class="ruby-constant">CustomField</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-node">&quot;#{custom_field_name}&quot;</span>])
1042:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">id</span>
1043:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000568" class="method-detail">
        <a name="M000568"></a>

        <div class="method-heading">
          <a href="#M000568" class="method-signature">
          <span class="method-name">get_name_for_rank_value</span><span class="method-args">(value,rank_names_and_scores)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000568-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000568-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1027</span>
1027:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_name_for_rank_value</span>(<span class="ruby-identifier">value</span>,<span class="ruby-identifier">rank_names_and_scores</span>)
1028:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1029:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1030:       
1031:     <span class="ruby-identifier">result</span> = <span class="ruby-value str">&quot;&quot;</span>
1032:     <span class="ruby-identifier">rank_names_and_scores</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">rank</span><span class="ruby-operator">|</span>
1033:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">value</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">rank</span>[<span class="ruby-value">1</span>]
1034:         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">rank</span>[<span class="ruby-value">0</span>]
1035:         <span class="ruby-keyword kw">break</span>
1036:       <span class="ruby-keyword kw">end</span>
1037:     <span class="ruby-keyword kw">end</span>
1038:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">result</span>
1039:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000570" class="method-detail">
        <a name="M000570"></a>

        <div class="method-heading">
          <a href="#M000570" class="method-signature">
          <span class="method-name">get_reference</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000570-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000570-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1044</span>
1044:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_reference</span>
1045:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1046:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1047: 
1048:     <span class="ruby-ivar">@results</span> = {}
1049:     <span class="ruby-identifier">cf_id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:custom_field_id</span>]
1050:     <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">cf_id</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">cf_id</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;bill&quot;</span>)
1051:       <span class="ruby-identifier">cf</span> = <span class="ruby-constant">CustomField</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">cf_id</span>.<span class="ruby-identifier">to_i</span>)
1052:       <span class="ruby-identifier">cells</span> = <span class="ruby-constant">Cell</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
1053:         <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:row</span>],
1054:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">'rows.screen_id = ? and cells.field_id = ?'</span>,<span class="ruby-identifier">cf</span>.<span class="ruby-identifier">screen_id</span>,<span class="ruby-identifier">cf</span>.<span class="ruby-identifier">custom_field_ids</span>[<span class="ruby-value">0</span>]],
1055:         <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;cells.value ASC&quot;</span>)
1056:       <span class="ruby-identifier">cells</span>.<span class="ruby-identifier">each_with_index</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
1057:         <span class="ruby-ivar">@results</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">||=</span>{}
1058:         <span class="ruby-ivar">@results</span>[<span class="ruby-identifier">i</span>] = {<span class="ruby-identifier">c</span>.<span class="ruby-identifier">row_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">value</span>}
1059:       }
1060:     <span class="ruby-keyword kw">end</span>
1061:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000577" class="method-detail">
        <a name="M000577"></a>

        <div class="method-heading">
          <a href="#M000577" class="method-signature">
          <span class="method-name">gtotal</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>Grand Total <a href="Report.html">Report</a> with Export ======</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000577-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000577-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1138</span>
1138:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gtotal</span>
1139:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1140:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1141: 
1142:     <span class="ruby-ivar">@screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-value str">&quot;Customer&quot;</span> ])
1143:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000580" class="method-detail">
        <a name="M000580"></a>

        <div class="method-heading">
          <a href="#M000580" class="method-signature">
          <span class="method-name">gtotal_by_area</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000580-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000580-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1253</span>
1253:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gtotal_by_area</span>
1254:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1255:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1256: 
1257:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'export'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;yes&quot;</span>
1258:       <span class="ruby-comment cmt">#Report Grand Total By Area</span>
1259:       <span class="ruby-identifier">business_record_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-value str">&quot;Business Record&quot;</span> ])
1260:       <span class="ruby-identifier">province_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-value str">&quot;Province&quot;</span> ])
1261:       <span class="ruby-identifier">invoice_date_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Invoice Date&quot;</span>)
1262:       <span class="ruby-identifier">invoice_amount_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Invoice Amount&quot;</span>)
1263:       <span class="ruby-identifier">issue_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Issue Tracking&quot;</span>)
1264:       <span class="ruby-identifier">customer_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Customer_REF&quot;</span>)
1265:       <span class="ruby-identifier">product_type_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Production_Type_REF&quot;</span>)
1266:       <span class="ruby-identifier">province_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Province_REF&quot;</span>)
1267:       <span class="ruby-identifier">potential_rank_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Potential_Rank_REF&quot;</span>)
1268:       <span class="ruby-identifier">area_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Area_REF&quot;</span>)
1269:       <span class="ruby-identifier">selected_area</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:filter_item</span>]
1270:       <span class="ruby-identifier">report_data</span> = {}
1271:       <span class="ruby-identifier">report_total</span> = {}
1272:       <span class="ruby-identifier">report_gtotal</span> = <span class="ruby-value">0</span><span class="ruby-value">.0</span>
1273: 
1274:       <span class="ruby-identifier">filtered_rows_by_invoice_date</span> =  <span class="ruby-identifier">business_record_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
1275:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.field_id = ? and cells.value between ? and  ?&quot;</span>, <span class="ruby-identifier">invoice_date_custom_field_id</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>]])
1276: 
1277:       <span class="ruby-identifier">gen_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">filtered_rows_by_invoice_date</span>,[<span class="ruby-identifier">customer_custom_field_id</span>,<span class="ruby-identifier">product_type_custom_field_id</span>,<span class="ruby-identifier">invoice_amount_custom_field_id</span>,<span class="ruby-identifier">issue_custom_field_id</span>])
1278:       <span class="ruby-identifier">filtered_rows_by_invoice_date</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
1279:         <span class="ruby-identifier">value</span> = <span class="ruby-identifier">gen_rows</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>]
1280:         <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">cancelled?</span>(<span class="ruby-identifier">value</span>[<span class="ruby-identifier">issue_custom_field_id</span>])
1281:       <span class="ruby-keyword kw">end</span>
1282: 
1283:       <span class="ruby-identifier">cust_row_ids</span> = <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">value</span>[<span class="ruby-identifier">customer_custom_field_id</span>]) }.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r_id</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r_id</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>}.<span class="ruby-identifier">uniq</span>
1284:       <span class="ruby-identifier">cust_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">cust_row_ids</span>)
1285:       <span class="ruby-identifier">cust_gen_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">cust_rows</span>,[<span class="ruby-identifier">potential_rank_custom_field_id</span>,<span class="ruby-identifier">province_custom_field_id</span>])
1286: 
1287:       <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
1288:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>[<span class="ruby-identifier">customer_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1289:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>[<span class="ruby-identifier">product_type_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1290: 
1291:         <span class="ruby-identifier">amount</span> = <span class="ruby-identifier">r</span>[<span class="ruby-identifier">invoice_amount_custom_field_id</span>]
1292:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">potential_rank_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">cust_gen_rows</span>[<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">potential_rank_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1293:         <span class="ruby-identifier">province_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">cust_gen_rows</span>[<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">province_custom_field_id</span>])
1294:         <span class="ruby-identifier">area</span> = <span class="ruby-value str">&quot;&quot;</span>
1295: 
1296:         <span class="ruby-identifier">area_id</span> = (<span class="ruby-identifier">province_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-operator">?</span> <span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">begin</span>
1297:           <span class="ruby-identifier">province_row</span> = <span class="ruby-identifier">province_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">province_id</span>)
1298:           <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">province_row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">area_custom_field_id</span>).<span class="ruby-identifier">value</span>)
1299:         <span class="ruby-keyword kw">end</span>
1300:         <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">area_id</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">area_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">selected_area</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">selected_area</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>)
1301:           <span class="ruby-identifier">area_id</span> = <span class="ruby-value str">&quot;N/A&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">area_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1302: 
1303:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">area_id</span>] <span class="ruby-operator">||=</span> {}
1304:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">area_id</span>][<span class="ruby-identifier">potential_rank_id</span>] <span class="ruby-operator">||=</span> {}
1305:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">area_id</span>][<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>] <span class="ruby-operator">||=</span> {}
1306:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">area_id</span>][<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">product_type_id</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">0</span><span class="ruby-value">.0</span>
1307:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">area_id</span>][<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">product_type_id</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1308:           <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">area_id</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">0</span><span class="ruby-value">.0</span>
1309:           <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">area_id</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1310:           <span class="ruby-identifier">report_gtotal</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1311:         <span class="ruby-keyword kw">end</span>
1312:       <span class="ruby-keyword kw">end</span>
1313:       <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">store_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>,
1314:         {
1315:           <span class="ruby-identifier">:report_data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_data</span>,
1316:           <span class="ruby-identifier">:report_total</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_total</span>,
1317:           <span class="ruby-identifier">:report_gtotal</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_gtotal</span>
1318:         })
1319:     <span class="ruby-keyword kw">else</span>
1320:       <span class="ruby-identifier">vm</span> = <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">get_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>)
1321:       <span class="ruby-identifier">report_data</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_data</span>]
1322:       <span class="ruby-identifier">report_total</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_total</span>]
1323:       <span class="ruby-identifier">report_gtotal</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_gtotal</span>]
1324: 
1325:       <span class="ruby-identifier">export_grand_total</span>(<span class="ruby-value str">&quot;Area&quot;</span>,[<span class="ruby-value str">&quot;Area&quot;</span>,<span class="ruby-value str">&quot;Potential Rank&quot;</span>,<span class="ruby-value str">&quot;Customer&quot;</span>,<span class="ruby-value str">&quot;Product Type&quot;</span>,<span class="ruby-value str">&quot;Amount&quot;</span>],<span class="ruby-identifier">report_data</span>,<span class="ruby-identifier">report_total</span>,<span class="ruby-identifier">report_gtotal</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>])
1326:     <span class="ruby-keyword kw">end</span>
1327:     
1328:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">report_data</span>, <span class="ruby-identifier">report_total</span>, <span class="ruby-identifier">report_gtotal</span>
1329:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000583" class="method-detail">
        <a name="M000583"></a>

        <div class="method-heading">
          <a href="#M000583" class="method-signature">
          <span class="method-name">gtotal_by_bill_count</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000583-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000583-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1502</span>
1502:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gtotal_by_bill_count</span>
1503:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1504:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1505: 
1506:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'export'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;yes&quot;</span>
1507:       <span class="ruby-comment cmt">#Branch</span>
1508:       <span class="ruby-identifier">branch_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">&quot;name = 'Sales Office'&quot;</span>)
1509: 
1510:       <span class="ruby-comment cmt">#Staff</span>
1511:       <span class="ruby-identifier">sales_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">&quot;name = 'staff'&quot;</span>)
1512: 
1513:       <span class="ruby-comment cmt">#Business Record</span>
1514:       <span class="ruby-identifier">business_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">&quot;name = 'business record'&quot;</span>)
1515: 
1516:       <span class="ruby-identifier">cf_branch</span> = <span class="ruby-constant">CustomField</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;name = 'Sales_Office_REF'&quot;</span>)
1517:       <span class="ruby-identifier">cf_issue_tracking</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Issue Tracking&quot;</span>)
1518: 
1519:       <span class="ruby-identifier">cf_salesman</span> = <span class="ruby-constant">CustomField</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;name = 'Salesman_REF'&quot;</span>)
1520:       <span class="ruby-identifier">cf_po_date</span> = <span class="ruby-constant">CustomField</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;name = 'PO Date'&quot;</span>)
1521:       <span class="ruby-identifier">cf_quotation_date</span> = <span class="ruby-constant">CustomField</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;name = 'Quotation Date'&quot;</span>)
1522:       <span class="ruby-identifier">cf_invoice_date</span> = <span class="ruby-constant">CustomField</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;name = 'Invoice Date'&quot;</span>)
1523: 
1524:       <span class="ruby-identifier">cf_login</span> = <span class="ruby-constant">CustomField</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;name = 'Login'&quot;</span>)
1525: 
1526:       <span class="ruby-identifier">report_data</span> = {} <span class="ruby-comment cmt">#Keep amount of all activity</span>
1527:       <span class="ruby-identifier">report_total</span> = {} <span class="ruby-comment cmt">#Keep total amount of all activity</span>
1528:       <span class="ruby-identifier">report_gtotal</span> = {}
1529:       <span class="ruby-identifier">report_gtotal</span>[<span class="ruby-value str">&quot;P/O&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>
1530:       <span class="ruby-identifier">report_gtotal</span>[<span class="ruby-value str">&quot;Quotation&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>
1531:       <span class="ruby-identifier">report_gtotal</span>[<span class="ruby-value str">&quot;Invoice&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>
1532: 
1533:       <span class="ruby-identifier">branch_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span>
1534:         <span class="ruby-identifier">b_descr</span> = <span class="ruby-identifier">b</span>.<span class="ruby-identifier">description</span>
1535:         <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">b_descr</span>] <span class="ruby-operator">||=</span>{}
1536:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
1537:           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
1538:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.value like ? and cells.field_id = ? and rows.screen_id = ?&quot;</span>, <span class="ruby-node">&quot;%#{b.id.to_s}%&quot;</span>, <span class="ruby-identifier">cf_branch</span>.<span class="ruby-identifier">id</span> , <span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>])
1539:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">cf_branch</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">value</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">compact</span>
1540:         <span class="ruby-identifier">row_ids</span> = []
1541:         <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">id</span>}
1542:         <span class="ruby-identifier">sales_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
1543:           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
1544:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.value != '' and cells.field_id = ? and rows.screen_id = ? and rows.id in (?)&quot;</span>, <span class="ruby-identifier">cf_login</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">sales_screen</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">row_ids</span>])
1545: 
1546:         <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">b_descr</span>] <span class="ruby-operator">||=</span>{}
1547:         <span class="ruby-identifier">sales_rows</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">fs</span><span class="ruby-operator">|</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">b_descr</span>][<span class="ruby-identifier">fs</span>.<span class="ruby-identifier">id</span>] <span class="ruby-operator">||=</span>{} }
1548:       <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End @branch_screen.rows.each</span>
1549: 
1550:       <span class="ruby-comment cmt"># ------ Business Record ------</span>
1551:       <span class="ruby-identifier">row_ids</span> = []
1552:       <span class="ruby-identifier">filter_rows</span> =  <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
1553:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.field_id = ? and cells.value between ? and  ?&quot;</span>, <span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>]])
1554:       <span class="ruby-identifier">filter_rows</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>}
1555:       <span class="ruby-identifier">filter_rows</span> =  <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
1556:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.field_id = ? and cells.value between ? and  ?&quot;</span>, <span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>]])
1557:       <span class="ruby-identifier">filter_rows</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>}
1558:       <span class="ruby-identifier">filter_rows</span> =  <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
1559:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.field_id = ? and cells.value between ? and  ?&quot;</span>, <span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>]])
1560:       <span class="ruby-identifier">filter_rows</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>}
1561: 
1562:       <span class="ruby-identifier">business_rows</span> =  <span class="ruby-identifier">business_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">row_ids</span>)
1563:       <span class="ruby-identifier">business_field_ids</span> = [<span class="ruby-identifier">cf_issue_tracking</span>,<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>]
1564:       <span class="ruby-identifier">b_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">business_rows</span>, <span class="ruby-identifier">business_field_ids</span>)
1565: 
1566:       <span class="ruby-identifier">b_rows</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fb</span><span class="ruby-operator">|</span>
1567:         <span class="ruby-identifier">issue</span> = <span class="ruby-identifier">fb</span>[<span class="ruby-identifier">cf_issue_tracking</span>]
1568: 
1569:         <span class="ruby-identifier">cell_salesman</span> = <span class="ruby-identifier">fb</span>[<span class="ruby-identifier">cf_salesman</span>.<span class="ruby-identifier">id</span>]
1570:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">cell_salesman</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">cell_salesman</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;&quot;</span>
1571: 
1572:         <span class="ruby-identifier">salesman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">cell_salesman</span>)
1573:         <span class="ruby-identifier">branch_id</span> =  <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">company_branch_id</span>(<span class="ruby-identifier">salesman_id</span>))
1574:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">branch_id</span>][<span class="ruby-identifier">salesman_id</span>].<span class="ruby-identifier">nil?</span>
1575: 
1576:         <span class="ruby-identifier">cell_Quotation_Date</span> = <span class="ruby-identifier">fb</span>[<span class="ruby-identifier">cf_quotation_date</span>.<span class="ruby-identifier">id</span>]
1577:         <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">cell_Quotation_Date</span> <span class="ruby-operator">&gt;=</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>] <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">cell_Quotation_Date</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>])))
1578:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">branch_id</span>][<span class="ruby-identifier">salesman_id</span>][<span class="ruby-value str">&quot;Quotation&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>
1579:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">branch_id</span>][<span class="ruby-identifier">salesman_id</span>][<span class="ruby-value str">&quot;Quotation&quot;</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1580:           <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">branch_id</span>][<span class="ruby-value str">&quot;Quotation&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>
1581:           <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">branch_id</span>][<span class="ruby-value str">&quot;Quotation&quot;</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1582:           <span class="ruby-identifier">report_gtotal</span>[<span class="ruby-value str">&quot;Quotation&quot;</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1583:         <span class="ruby-keyword kw">end</span>
1584: 
1585:         <span class="ruby-comment cmt"># Keep number of quotation, even if cancel, P/O and Invoice don't keep</span>
1586:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">issue_state</span>(<span class="ruby-identifier">issue</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">:cancelled</span>
1587: 
1588:         <span class="ruby-identifier">cell_PO_Date</span> = <span class="ruby-identifier">fb</span>[<span class="ruby-identifier">cf_po_date</span>.<span class="ruby-identifier">id</span>]
1589: 
1590:         <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">cell_PO_Date</span> <span class="ruby-operator">&gt;=</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>] <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">cell_PO_Date</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>])))
1591:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">branch_id</span>][<span class="ruby-identifier">salesman_id</span>][<span class="ruby-value str">&quot;P/O&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>
1592:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">branch_id</span>][<span class="ruby-identifier">salesman_id</span>][<span class="ruby-value str">&quot;P/O&quot;</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1593:           <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">branch_id</span>][<span class="ruby-value str">&quot;P/O&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>
1594:           <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">branch_id</span>][<span class="ruby-value str">&quot;P/O&quot;</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1595:           <span class="ruby-identifier">report_gtotal</span>[<span class="ruby-value str">&quot;P/O&quot;</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1596:         <span class="ruby-keyword kw">end</span>
1597:         <span class="ruby-identifier">cell_Inovice_Date</span> = <span class="ruby-identifier">fb</span>[<span class="ruby-identifier">cf_invoice_date</span>.<span class="ruby-identifier">id</span>]
1598:         <span class="ruby-keyword kw">if</span> ((<span class="ruby-identifier">cell_Inovice_Date</span> <span class="ruby-operator">&gt;=</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>] <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">cell_Inovice_Date</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>])))
1599:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">branch_id</span>][<span class="ruby-identifier">salesman_id</span>][<span class="ruby-value str">&quot;Invoice&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>
1600:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">branch_id</span>][<span class="ruby-identifier">salesman_id</span>][<span class="ruby-value str">&quot;Invoice&quot;</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1601:           <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">branch_id</span>][<span class="ruby-value str">&quot;Invoice&quot;</span>] <span class="ruby-operator">||=</span><span class="ruby-value">0</span>
1602:           <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">branch_id</span>][<span class="ruby-value str">&quot;Invoice&quot;</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1603:           <span class="ruby-identifier">report_gtotal</span>[<span class="ruby-value str">&quot;Invoice&quot;</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1604:         <span class="ruby-keyword kw">end</span>
1605:       <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># End of business record</span>
1606:       <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">store_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>,
1607:         {
1608:           <span class="ruby-identifier">:report_data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_data</span>,
1609:           <span class="ruby-identifier">:report_total</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_total</span>,
1610:           <span class="ruby-identifier">:report_gtotal</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_gtotal</span>
1611:         })
1612:     <span class="ruby-keyword kw">else</span>
1613:       <span class="ruby-identifier">vm</span> = <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">get_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>)
1614:       <span class="ruby-identifier">report_data</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_data</span>]
1615:       <span class="ruby-identifier">report_total</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_total</span>]
1616:       <span class="ruby-identifier">report_gtotal</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_gtotal</span>]
1617: 
1618:       <span class="ruby-identifier">export_grand_total_billcount</span>(<span class="ruby-value str">&quot;Bill_Count&quot;</span>,[<span class="ruby-value str">&quot;Sales Office&quot;</span>,<span class="ruby-value str">&quot;Saleman&quot;</span>,<span class="ruby-value str">&quot;P/O (count)&quot;</span>,<span class="ruby-value str">&quot;Quotation (count)&quot;</span>,<span class="ruby-value str">&quot;Invoice (count)&quot;</span>],<span class="ruby-identifier">report_data</span>,<span class="ruby-identifier">report_total</span>,<span class="ruby-identifier">report_gtotal</span>,<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>],<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>])
1619:     <span class="ruby-keyword kw">end</span>
1620: 
1621:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">report_data</span>, <span class="ruby-identifier">report_total</span>, <span class="ruby-identifier">report_gtotal</span>
1622:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000581" class="method-detail">
        <a name="M000581"></a>

        <div class="method-heading">
          <a href="#M000581" class="method-signature">
          <span class="method-name">gtotal_by_rank</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000581-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000581-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1330</span>
1330:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gtotal_by_rank</span>
1331:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1332:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1333: 
1334:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'export'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;yes&quot;</span>
1335:       <span class="ruby-comment cmt">#Report Grand Total By Potential Rank</span>
1336:       <span class="ruby-identifier">business_record_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-value str">&quot;Business Record&quot;</span> ])
1337:       <span class="ruby-identifier">invoice_date_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Invoice Date&quot;</span>)
1338:       <span class="ruby-identifier">invoice_amount_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Invoice Amount&quot;</span>)
1339:       <span class="ruby-identifier">issue_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Issue Tracking&quot;</span>)
1340:       <span class="ruby-identifier">customer_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Customer_REF&quot;</span>)
1341:       <span class="ruby-identifier">product_type_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Production_Type_REF&quot;</span>)
1342:       <span class="ruby-identifier">potential_rank_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Potential_Rank_REF&quot;</span>)
1343:       <span class="ruby-identifier">selected_potential_rank</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:filter_item</span>]
1344:       <span class="ruby-identifier">report_data</span> = {}
1345:       <span class="ruby-identifier">report_total</span> = {}
1346:       <span class="ruby-identifier">report_gtotal</span> = <span class="ruby-value">0</span><span class="ruby-value">.0</span>
1347: 
1348:       <span class="ruby-identifier">filtered_rows</span> =  <span class="ruby-identifier">business_record_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
1349:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.field_id = ? and cells.value between ? and  ?&quot;</span>, <span class="ruby-identifier">invoice_date_custom_field_id</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>]])
1350: 
1351:       <span class="ruby-identifier">gen_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">filtered_rows</span>,[<span class="ruby-identifier">customer_custom_field_id</span>,<span class="ruby-identifier">product_type_custom_field_id</span>,<span class="ruby-identifier">invoice_amount_custom_field_id</span>,<span class="ruby-identifier">issue_custom_field_id</span>])
1352:       <span class="ruby-identifier">filtered_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
1353:         <span class="ruby-identifier">value</span> = <span class="ruby-identifier">gen_rows</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>]
1354:         <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">cancelled?</span>(<span class="ruby-identifier">value</span>[<span class="ruby-identifier">issue_custom_field_id</span>])
1355:       <span class="ruby-keyword kw">end</span>
1356: 
1357:       <span class="ruby-identifier">cust_row_ids</span> = <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">value</span>[<span class="ruby-identifier">customer_custom_field_id</span>]) }.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r_id</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r_id</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>}.<span class="ruby-identifier">uniq</span>
1358:       <span class="ruby-identifier">cust_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">cust_row_ids</span>)
1359:       <span class="ruby-identifier">cust_gen_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">cust_rows</span>,[<span class="ruby-identifier">potential_rank_custom_field_id</span>])
1360: 
1361:       <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
1362:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">value</span>[<span class="ruby-identifier">customer_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1363:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">value</span>[<span class="ruby-identifier">product_type_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1364: 
1365:         <span class="ruby-identifier">amount</span> = <span class="ruby-identifier">value</span>[<span class="ruby-identifier">invoice_amount_custom_field_id</span>]
1366:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">potential_rank_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">cust_gen_rows</span>[<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">potential_rank_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1367: 
1368:         <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">potential_rank_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">selected_potential_rank</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">selected_potential_rank</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>)
1369:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">potential_rank_id</span>] = {} <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">potential_rank_id</span>].<span class="ruby-identifier">nil?</span>
1370:           <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">potential_rank_id</span>] = <span class="ruby-value">0</span><span class="ruby-value">.0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">potential_rank_id</span>].<span class="ruby-identifier">nil?</span>
1371:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>] = {} <span class="ruby-keyword kw">if</span>  <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
1372:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">product_type_id</span>] = <span class="ruby-value">0</span><span class="ruby-value">.0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">product_type_id</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
1373:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">product_type_id</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1374:           <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">potential_rank_id</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1375:           <span class="ruby-identifier">report_gtotal</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1376:         <span class="ruby-keyword kw">end</span>
1377:       <span class="ruby-keyword kw">end</span>
1378:       <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">store_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>,
1379:         {
1380:           <span class="ruby-identifier">:report_data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_data</span>,
1381:           <span class="ruby-identifier">:report_total</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_total</span>,
1382:           <span class="ruby-identifier">:report_gtotal</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_gtotal</span>
1383:         })
1384:     <span class="ruby-keyword kw">else</span>
1385:       <span class="ruby-identifier">vm</span> = <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">get_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>)
1386:       <span class="ruby-identifier">report_data</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_data</span>]
1387:       <span class="ruby-identifier">report_total</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_total</span>]
1388:       <span class="ruby-identifier">report_gtotal</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_gtotal</span>]
1389: 
1390:       <span class="ruby-identifier">export_grand_total</span>(<span class="ruby-value str">&quot;Potential_Rank&quot;</span>,[<span class="ruby-value str">&quot;Potential Rank&quot;</span>,<span class="ruby-value str">&quot;Customer&quot;</span>,<span class="ruby-value str">&quot;Product Type&quot;</span>,<span class="ruby-value str">&quot;Amount&quot;</span>],<span class="ruby-identifier">report_data</span>,<span class="ruby-identifier">report_total</span>,<span class="ruby-identifier">report_gtotal</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>])
1391:     <span class="ruby-keyword kw">end</span>
1392:     
1393:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">report_data</span>, <span class="ruby-identifier">report_total</span>, <span class="ruby-identifier">report_gtotal</span>
1394:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000579" class="method-detail">
        <a name="M000579"></a>

        <div class="method-heading">
          <a href="#M000579" class="method-signature">
          <span class="method-name">gtotal_by_rpt</span><span class="method-args">(rpt_ref)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000579-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000579-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1183</span>
1183:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gtotal_by_rpt</span>(<span class="ruby-identifier">rpt_ref</span>)
1184:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1185:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1186: 
1187:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'export'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;yes&quot;</span>
1188:       <span class="ruby-comment cmt">#Grand Total for Nation, Business Type, Province, Estate</span>
1189:       <span class="ruby-identifier">business_record_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-value str">&quot;Business Record&quot;</span> ])
1190:       <span class="ruby-identifier">invoice_date_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Invoice Date&quot;</span>)
1191:       <span class="ruby-identifier">invoice_amount_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Invoice Amount&quot;</span>)
1192:       <span class="ruby-identifier">issue_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Issue Tracking&quot;</span>)
1193:       <span class="ruby-identifier">customer_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Customer_REF&quot;</span>)
1194:       <span class="ruby-identifier">product_type_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Production_Type_REF&quot;</span>)
1195:       <span class="ruby-identifier">rpt_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-identifier">rpt_ref</span>)
1196:       <span class="ruby-identifier">potential_rank_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Potential_Rank_REF&quot;</span>)
1197:       <span class="ruby-identifier">selected_item</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:filter_item</span>].<span class="ruby-identifier">to_i</span>
1198:       <span class="ruby-identifier">report_data</span> = {}
1199:       <span class="ruby-identifier">report_total</span> = {}
1200:       <span class="ruby-identifier">report_gtotal</span> = <span class="ruby-value">0</span><span class="ruby-value">.0</span>
1201: 
1202:       <span class="ruby-comment cmt">#convert(datetime, cast(cells.value as nvarchar), 120) ===&gt; Convert Text to NVARCHAR to DATETIME in SQL Server</span>
1203:       <span class="ruby-identifier">filtered_rows_by_invoice_date</span> =  <span class="ruby-identifier">business_record_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
1204:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.field_id = ? and cells.value between ? and  ?&quot;</span>, <span class="ruby-identifier">invoice_date_custom_field_id</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>]])
1205: 
1206:       <span class="ruby-identifier">gen_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">filtered_rows_by_invoice_date</span>,[<span class="ruby-identifier">customer_custom_field_id</span>,<span class="ruby-identifier">product_type_custom_field_id</span>,<span class="ruby-identifier">invoice_amount_custom_field_id</span>,<span class="ruby-identifier">issue_custom_field_id</span>])
1207:       <span class="ruby-identifier">filtered_rows_by_invoice_date</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
1208:         <span class="ruby-identifier">value</span> = <span class="ruby-identifier">gen_rows</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>]
1209:         <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">cancelled?</span>(<span class="ruby-identifier">value</span>[<span class="ruby-identifier">issue_custom_field_id</span>])
1210:       <span class="ruby-keyword kw">end</span>
1211: 
1212:       <span class="ruby-identifier">cust_row_ids</span> = <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">value</span>[<span class="ruby-identifier">customer_custom_field_id</span>]) }.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r_id</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r_id</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>}.<span class="ruby-identifier">uniq</span>
1213:       <span class="ruby-identifier">cust_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">cust_row_ids</span>)
1214:       <span class="ruby-identifier">cust_gen_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">cust_rows</span>,[<span class="ruby-identifier">rpt_custom_field_id</span>,<span class="ruby-identifier">potential_rank_custom_field_id</span>])
1215: 
1216:       <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
1217:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">value</span>[<span class="ruby-identifier">customer_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1218:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">value</span>[<span class="ruby-identifier">product_type_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1219: 
1220:         <span class="ruby-identifier">amount</span> = <span class="ruby-identifier">value</span>[<span class="ruby-identifier">invoice_amount_custom_field_id</span>]
1221:         <span class="ruby-identifier">item</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">cust_gen_rows</span>[<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">rpt_custom_field_id</span>])
1222:         <span class="ruby-identifier">item</span> = <span class="ruby-value str">&quot;N/A&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">item</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1223:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">potential_rank_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">cust_gen_rows</span>[<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">potential_rank_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1224: 
1225:         <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">item</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">item</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">selected_item</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">selected_item</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>)
1226:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">item</span>] = {} <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">item</span>].<span class="ruby-identifier">nil?</span>
1227:           <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">item</span>] = <span class="ruby-value">0</span><span class="ruby-value">.0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">item</span>].<span class="ruby-identifier">nil?</span>
1228:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">potential_rank_id</span>] = {} <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">potential_rank_id</span>].<span class="ruby-identifier">nil?</span>
1229:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>] = {} <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>].<span class="ruby-identifier">nil?</span>
1230:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">product_type_id</span>] = <span class="ruby-value">0</span><span class="ruby-value">.0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">product_type_id</span>].<span class="ruby-identifier">nil?</span>
1231:           <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">item</span>][<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">product_type_id</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1232:           <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">item</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1233:           <span class="ruby-identifier">report_gtotal</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1234:         <span class="ruby-keyword kw">end</span>
1235:       <span class="ruby-keyword kw">end</span>
1236:       <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">store_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>,
1237:         {
1238:           <span class="ruby-identifier">:report_data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_data</span>,
1239:           <span class="ruby-identifier">:report_total</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_total</span>,
1240:           <span class="ruby-identifier">:report_gtotal</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_gtotal</span>
1241:         })
1242:     <span class="ruby-keyword kw">else</span>
1243:       <span class="ruby-identifier">vm</span> = <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">get_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>)
1244:       <span class="ruby-identifier">report_data</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_data</span>]
1245:       <span class="ruby-identifier">report_total</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_total</span>]
1246:       <span class="ruby-identifier">report_gtotal</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_gtotal</span>]
1247:       
1248:       <span class="ruby-identifier">export_grand_total</span>(<span class="ruby-identifier">rpt_ref</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot;_REF&quot;</span>,<span class="ruby-value str">&quot;&quot;</span>),[<span class="ruby-identifier">rpt_ref</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot;_REF&quot;</span>,<span class="ruby-value str">&quot;&quot;</span>),<span class="ruby-value str">&quot;Potential Rank&quot;</span>,<span class="ruby-value str">&quot;Customer&quot;</span>,<span class="ruby-value str">&quot;Product Type&quot;</span>,<span class="ruby-value str">&quot;Amount&quot;</span>],<span class="ruby-identifier">report_data</span>, <span class="ruby-identifier">report_total</span>, <span class="ruby-identifier">report_gtotal</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>])
1249:     <span class="ruby-keyword kw">end</span>
1250:     
1251:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">report_data</span>, <span class="ruby-identifier">report_total</span>, <span class="ruby-identifier">report_gtotal</span>
1252:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000582" class="method-detail">
        <a name="M000582"></a>

        <div class="method-heading">
          <a href="#M000582" class="method-signature">
          <span class="method-name">gtotal_by_sales_product</span><span class="method-args">(rpt_type)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000582-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000582-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1395</span>
1395:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gtotal_by_sales_product</span>(<span class="ruby-identifier">rpt_type</span>)
1396:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1397:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1398: 
1399:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'export'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;yes&quot;</span>
1400:       <span class="ruby-comment cmt">#Report Grand Total By Sales Office and Product Type</span>
1401:       <span class="ruby-identifier">business_record_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-value str">&quot;Business Record&quot;</span> ])
1402:       <span class="ruby-identifier">invoice_date_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Invoice Date&quot;</span>)
1403:       <span class="ruby-identifier">invoice_amount_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Invoice Amount&quot;</span>)
1404:       <span class="ruby-identifier">issue_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Issue Tracking&quot;</span>)
1405:       <span class="ruby-identifier">customer_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Customer_REF&quot;</span>)
1406:       <span class="ruby-identifier">product_type_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Production_Type_REF&quot;</span>)
1407:       <span class="ruby-identifier">saleman_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Salesman_REF&quot;</span>)
1408:       <span class="ruby-identifier">sales_office_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Sales_Office_REF&quot;</span>)
1409:       <span class="ruby-identifier">potential_rank_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Potential_Rank_REF&quot;</span>)
1410:       <span class="ruby-identifier">selected_item</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:filter_item</span>]
1411:       <span class="ruby-identifier">report_data</span> = {}
1412:       <span class="ruby-identifier">report_total</span> = {}
1413:       <span class="ruby-identifier">report_gtotal</span> = <span class="ruby-value">0</span><span class="ruby-value">.0</span>
1414: 
1415:       <span class="ruby-identifier">filtered_rows_by_invoice_date</span> =  <span class="ruby-identifier">business_record_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
1416:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.field_id = ? and cells.value between ? and  ?&quot;</span>, <span class="ruby-identifier">invoice_date_custom_field_id</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>]])
1417: 
1418:       <span class="ruby-identifier">gen_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">filtered_rows_by_invoice_date</span>,[<span class="ruby-identifier">customer_custom_field_id</span>,<span class="ruby-identifier">saleman_custom_field_id</span>,<span class="ruby-identifier">product_type_custom_field_id</span>,<span class="ruby-identifier">invoice_amount_custom_field_id</span>,<span class="ruby-identifier">issue_custom_field_id</span>])
1419:       <span class="ruby-identifier">filtered_rows_by_invoice_date</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
1420:         <span class="ruby-identifier">value</span> = <span class="ruby-identifier">gen_rows</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>]
1421:         <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">cancelled?</span>(<span class="ruby-identifier">value</span>[<span class="ruby-identifier">issue_custom_field_id</span>])
1422:       <span class="ruby-keyword kw">end</span>
1423: 
1424:       <span class="ruby-identifier">cust_row_ids</span> = <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">value</span>[<span class="ruby-identifier">customer_custom_field_id</span>]) }.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r_id</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r_id</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>}.<span class="ruby-identifier">uniq</span>
1425:       <span class="ruby-identifier">cust_rows</span> = <span class="ruby-constant">Row</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">cust_row_ids</span>)
1426:       <span class="ruby-identifier">cust_gen_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">cust_rows</span>,[<span class="ruby-identifier">potential_rank_custom_field_id</span>,<span class="ruby-identifier">sales_office_custom_field_id</span>])
1427: 
1428:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;Product Type&quot;</span>
1429:         <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
1430:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>[<span class="ruby-identifier">customer_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1431:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">saleman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>[<span class="ruby-identifier">saleman_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1432:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>[<span class="ruby-identifier">product_type_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1433: 
1434:           <span class="ruby-identifier">amount</span> = <span class="ruby-identifier">r</span>[<span class="ruby-identifier">invoice_amount_custom_field_id</span>]
1435:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">sales_office_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">cust_gen_rows</span>[<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">sales_office_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1436:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">potential_rank_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">cust_gen_rows</span>[<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">potential_rank_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1437: 
1438:           <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">product_type_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">selected_item</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">selected_item</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>)
1439:             <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">product_type_id</span>] = {} <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">product_type_id</span>].<span class="ruby-identifier">nil?</span>
1440:             <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">product_type_id</span>] = <span class="ruby-value">0</span><span class="ruby-value">.0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">product_type_id</span>].<span class="ruby-identifier">nil?</span>
1441:             <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">sales_office_id</span>] = {} <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">sales_office_id</span>].<span class="ruby-identifier">nil?</span>
1442:             <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">saleman_id</span>] = {} <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">saleman_id</span>].<span class="ruby-identifier">nil?</span>
1443:             <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">saleman_id</span>][<span class="ruby-identifier">potential_rank_id</span>] = {} <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">saleman_id</span>][<span class="ruby-identifier">potential_rank_id</span>].<span class="ruby-identifier">nil?</span>
1444:             <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">saleman_id</span>][<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>] = <span class="ruby-value">0</span><span class="ruby-value">.0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">saleman_id</span>][<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>].<span class="ruby-identifier">nil?</span>
1445:             <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">saleman_id</span>][<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1446:             <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">product_type_id</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1447:             <span class="ruby-identifier">report_gtotal</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1448:           <span class="ruby-keyword kw">end</span>
1449:         <span class="ruby-keyword kw">end</span>
1450:         <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">store_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>,
1451:           {
1452:             <span class="ruby-identifier">:report_data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_data</span>,
1453:             <span class="ruby-identifier">:report_total</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_total</span>,
1454:             <span class="ruby-identifier">:report_gtotal</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_gtotal</span>,
1455:             <span class="ruby-identifier">:report_title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;Product_Type&quot;</span>,
1456:             <span class="ruby-identifier">:report_headers</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;Product Type&quot;</span>,<span class="ruby-value str">&quot;Sales Office&quot;</span>,<span class="ruby-value str">&quot;Saleman&quot;</span>,<span class="ruby-value str">&quot;Potential Rank&quot;</span>,<span class="ruby-value str">&quot;Customer&quot;</span>,<span class="ruby-value str">&quot;Amount&quot;</span>]
1457:           })
1458:       <span class="ruby-keyword kw">else</span>
1459:         <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
1460:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>[<span class="ruby-identifier">customer_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1461:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">saleman_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>[<span class="ruby-identifier">saleman_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1462:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>[<span class="ruby-identifier">product_type_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1463: 
1464:           <span class="ruby-identifier">amount</span> = <span class="ruby-identifier">r</span>[<span class="ruby-identifier">invoice_amount_custom_field_id</span>]
1465:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">sales_office_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">cust_gen_rows</span>[<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">sales_office_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1466:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">potential_rank_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">cust_gen_rows</span>[<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">potential_rank_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1467: 
1468:           <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">sales_office_id</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">sales_office_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">selected_item</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">selected_item</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>)
1469:             <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">sales_office_id</span>] = {} <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">sales_office_id</span>].<span class="ruby-identifier">nil?</span>
1470:             <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">sales_office_id</span>] = <span class="ruby-value">0</span><span class="ruby-value">.0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">sales_office_id</span>].<span class="ruby-identifier">nil?</span>
1471:             <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">product_type_id</span>] = {} <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">product_type_id</span>].<span class="ruby-identifier">nil?</span>
1472:             <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">saleman_id</span>] = {} <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">saleman_id</span>].<span class="ruby-identifier">nil?</span>
1473:             <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">saleman_id</span>][<span class="ruby-identifier">potential_rank_id</span>] = {} <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">saleman_id</span>][<span class="ruby-identifier">potential_rank_id</span>].<span class="ruby-identifier">nil?</span>
1474:             <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">saleman_id</span>][<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>] = <span class="ruby-value">0</span><span class="ruby-value">.0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">saleman_id</span>][<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>].<span class="ruby-identifier">nil?</span>
1475:             <span class="ruby-identifier">report_data</span>[<span class="ruby-identifier">sales_office_id</span>][<span class="ruby-identifier">product_type_id</span>][<span class="ruby-identifier">saleman_id</span>][<span class="ruby-identifier">potential_rank_id</span>][<span class="ruby-identifier">customer_id</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1476:             <span class="ruby-identifier">report_total</span>[<span class="ruby-identifier">sales_office_id</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1477:             <span class="ruby-identifier">report_gtotal</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_f</span>
1478:           <span class="ruby-keyword kw">end</span>
1479:         <span class="ruby-keyword kw">end</span>
1480:         <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">store_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>,
1481:           {
1482:             <span class="ruby-identifier">:report_data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_data</span>,
1483:             <span class="ruby-identifier">:report_total</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_total</span>,
1484:             <span class="ruby-identifier">:report_gtotal</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">report_gtotal</span>,
1485:             <span class="ruby-identifier">:report_title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;Sales_Office&quot;</span>,
1486:             <span class="ruby-identifier">:report_headers</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;Sales Office&quot;</span>,<span class="ruby-value str">&quot;Product Type&quot;</span>,<span class="ruby-value str">&quot;Saleman&quot;</span>,<span class="ruby-value str">&quot;Potential Rank&quot;</span>,<span class="ruby-value str">&quot;Customer&quot;</span>,<span class="ruby-value str">&quot;Amount&quot;</span>]
1487:           })
1488:       <span class="ruby-keyword kw">end</span>
1489:     <span class="ruby-keyword kw">else</span>
1490:       <span class="ruby-identifier">vm</span> = <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">get_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>)
1491:       <span class="ruby-identifier">report_data</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_data</span>]
1492:       <span class="ruby-identifier">report_total</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_total</span>]
1493:       <span class="ruby-identifier">report_gtotal</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_gtotal</span>]
1494:       <span class="ruby-identifier">report_title</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_title</span>]
1495:       <span class="ruby-identifier">report_headers</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_headers</span>]
1496: 
1497:       <span class="ruby-identifier">export_grand_total</span>(<span class="ruby-identifier">report_title</span>, <span class="ruby-identifier">report_headers</span>,<span class="ruby-identifier">report_data</span>,<span class="ruby-identifier">report_total</span>,<span class="ruby-identifier">report_gtotal</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_from</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:invoice_to</span>])
1498:     <span class="ruby-keyword kw">end</span>
1499:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">report_data</span>, <span class="ruby-identifier">report_total</span>, <span class="ruby-identifier">report_gtotal</span>
1500:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000578" class="method-detail">
        <a name="M000578"></a>

        <div class="method-heading">
          <a href="#M000578" class="method-signature">
          <span class="method-name">gtotal_report</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000578-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000578-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1145</span>
1145:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gtotal_report</span>
1146:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1147:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1148: 
1149:     <span class="ruby-ivar">@screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-value str">&quot;Grand Total Report&quot;</span> ])
1150:     <span class="ruby-ivar">@rpt_type</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:rpt_type</span>]
1151:     <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;&quot;</span>
1152:     <span class="ruby-ivar">@report_data</span> = {}
1153:     <span class="ruby-ivar">@report_total</span> = {}
1154:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;0&quot;</span> <span class="ruby-comment cmt">#Nation</span>
1155:       <span class="ruby-ivar">@report_data</span>, <span class="ruby-ivar">@report_total</span>, <span class="ruby-ivar">@report_gtotal</span> = <span class="ruby-identifier">gtotal_by_rpt</span>(<span class="ruby-value str">&quot;Nation_REF&quot;</span>)
1156:       <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;Nation&quot;</span>
1157:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;1&quot;</span> <span class="ruby-comment cmt">#Business Type</span>
1158:       <span class="ruby-ivar">@report_data</span>, <span class="ruby-ivar">@report_total</span>, <span class="ruby-ivar">@report_gtotal</span> = <span class="ruby-identifier">gtotal_by_rpt</span>(<span class="ruby-value str">&quot;Business_REF&quot;</span>)
1159:       <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;Business Type&quot;</span>
1160:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;2&quot;</span> <span class="ruby-comment cmt">#Province</span>
1161:       <span class="ruby-ivar">@report_data</span>, <span class="ruby-ivar">@report_total</span>, <span class="ruby-ivar">@report_gtotal</span> = <span class="ruby-identifier">gtotal_by_rpt</span>(<span class="ruby-value str">&quot;Province_REF&quot;</span>)
1162:       <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;Province&quot;</span>
1163:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;4&quot;</span> <span class="ruby-comment cmt">#Area</span>
1164:       <span class="ruby-ivar">@report_data</span>, <span class="ruby-ivar">@report_total</span>, <span class="ruby-ivar">@report_gtotal</span> = <span class="ruby-identifier">gtotal_by_area</span>
1165:       <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;Area&quot;</span>
1166:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;6&quot;</span> <span class="ruby-comment cmt">#Industrial Estate</span>
1167:       <span class="ruby-ivar">@report_data</span>, <span class="ruby-ivar">@report_total</span>, <span class="ruby-ivar">@report_gtotal</span> = <span class="ruby-identifier">gtotal_by_rpt</span>(<span class="ruby-value str">&quot;Estate_REF&quot;</span>)
1168:       <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;Industrial Estate&quot;</span>
1169:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;8&quot;</span> <span class="ruby-comment cmt">#Potential</span>
1170:       <span class="ruby-ivar">@report_data</span>, <span class="ruby-ivar">@report_total</span>, <span class="ruby-ivar">@report_gtotal</span> = <span class="ruby-identifier">gtotal_by_rank</span>
1171:       <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;Potential Rank&quot;</span>
1172:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;10&quot;</span> <span class="ruby-comment cmt">#Product Type</span>
1173:       <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;Product Type&quot;</span>
1174:       <span class="ruby-ivar">@report_data</span>, <span class="ruby-ivar">@report_total</span>, <span class="ruby-ivar">@report_gtotal</span> = <span class="ruby-identifier">gtotal_by_sales_product</span>(<span class="ruby-ivar">@rpt_name</span>)
1175:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;12&quot;</span> <span class="ruby-comment cmt">#Sales Office</span>
1176:       <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;Sales Office&quot;</span>
1177:       <span class="ruby-ivar">@report_data</span>, <span class="ruby-ivar">@report_total</span>, <span class="ruby-ivar">@report_gtotal</span> = <span class="ruby-identifier">gtotal_by_sales_product</span>(<span class="ruby-ivar">@rpt_name</span>)
1178:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@rpt_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;13&quot;</span> <span class="ruby-comment cmt">#Bill Count</span>
1179:       <span class="ruby-ivar">@rpt_name</span> = <span class="ruby-value str">&quot;Bill Count&quot;</span>
1180:       <span class="ruby-ivar">@report_data</span>, <span class="ruby-ivar">@report_total</span>, <span class="ruby-ivar">@report_gtotal</span> = <span class="ruby-identifier">gtotal_by_bill_count</span>
1181:     <span class="ruby-keyword kw">end</span>
1182:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000535" class="method-detail">
        <a name="M000535"></a>

        <div class="method-heading">
          <a href="#M000535" class="method-signature">
          <span class="method-name">index</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
GET /reports GET /reports.xml
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000535-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000535-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 41</span>
41:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">index</span>
42:     <span class="ruby-ivar">@screen</span> = <span class="ruby-identifier">session</span>.<span class="ruby-identifier">active_screen</span>
43:     <span class="ruby-ivar">@reports</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>)
44: 
45:     <span class="ruby-ivar">@reports</span>.<span class="ruby-identifier">sort!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">name</span> }
46:     
47:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
48:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment cmt"># index.html.erb</span>
49:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@reports</span> }
50:     <span class="ruby-keyword kw">end</span>
51:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000538" class="method-detail">
        <a name="M000538"></a>

        <div class="method-heading">
          <a href="#M000538" class="method-signature">
          <span class="method-name">new</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
GET /reports/new GET /reports/new.xml
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000538-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000538-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 76</span>
76:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">new</span>
77:     <span class="ruby-ivar">@screen</span> = <span class="ruby-identifier">session</span>.<span class="ruby-identifier">active_screen</span>
78:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">new</span>
79:     
80:     <span class="ruby-ivar">@assigned_options</span> = []
81:     <span class="ruby-ivar">@all_options</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
82:       <span class="ruby-identifier">:conditions=</span><span class="ruby-operator">&gt;</span>[<span class="ruby-value str">&quot; controller = ? and action = ?&quot;</span>,<span class="ruby-value str">&quot;screens&quot;</span>,<span class="ruby-value str">&quot;show&quot;</span>],
83:       <span class="ruby-identifier">:order=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">&quot;name&quot;</span>
84:     ).<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">parent</span> }.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">sort</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">name</span> }
85:     
86:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
87:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment cmt"># new.html.erb</span>
88:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@report</span> }
89:     <span class="ruby-keyword kw">end</span>
90:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000559" class="method-detail">
        <a name="M000559"></a>

        <div class="method-heading">
          <a href="#M000559" class="method-signature">
          <span class="method-name">pdf_report</span><span class="method-args">(rows)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000559-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000559-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 420</span>
420:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pdf_report</span>(<span class="ruby-identifier">rows</span>)
421:     <span class="ruby-comment cmt">#     @screen = Screen.find(params[:screen_id])</span>
422:     <span class="ruby-comment cmt">#    @header_row_id = params[:header_row_id]</span>
423:     <span class="ruby-comment cmt">#     @xml_string = @screen.generate_xml(rows,header_row_id)</span>
424:     <span class="ruby-comment cmt">#     send_doc(@xml_string ,'/row_result/cell_value/cell', 'cell', 'Report', 'pdf')</span>
425:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000571" class="method-detail">
        <a name="M000571"></a>

        <div class="method-heading">
          <a href="#M000571" class="method-signature">
          <span class="method-name">product_type</span><span class="method-args">(id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000571-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000571-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1062</span>
1062:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">product_type</span>(<span class="ruby-identifier">id</span>)
1063:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
1064:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
1065: 
1066:     <span class="ruby-comment cmt">#Customer</span>
1067:     <span class="ruby-identifier">product_type_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">&quot;name = 'PRODUCT_TYPE'&quot;</span>)
1068:     <span class="ruby-identifier">ptype_row</span> = <span class="ruby-identifier">product_type_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_i</span>)
1069:     <span class="ruby-identifier">cf_ptype</span> = <span class="ruby-constant">CustomField</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;name = 'Production_Type_REF'&quot;</span>)
1070:     <span class="ruby-identifier">result</span> = <span class="ruby-identifier">ptype_row</span>.<span class="ruby-identifier">cells</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;field_id = ?&quot;</span>, <span class="ruby-identifier">cf_ptype</span>.<span class="ruby-identifier">id</span>]).<span class="ruby-identifier">value</span>
1071:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;&quot;</span>
1072:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;N/A&quot;</span>
1073:     <span class="ruby-keyword kw">else</span>
1074:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">retrieve_nonmulti_result</span>([<span class="ruby-identifier">result</span>])
1075:     <span class="ruby-keyword kw">end</span>
1076:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000600" class="method-detail">
        <a name="M000600"></a>

        <div class="method-heading">
          <a href="#M000600" class="method-signature">
          <span class="method-name">rank_history</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>Rank History <a href="Report.html">Report</a> with Export ======</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000600-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000600-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 4491</span>
4491:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">rank_history</span>
4492:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
4493:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
4494: 
4495:     <span class="ruby-ivar">@screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-value str">&quot;Business Record&quot;</span> ])
4496:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000601" class="method-detail">
        <a name="M000601"></a>

        <div class="method-heading">
          <a href="#M000601" class="method-signature">
          <span class="method-name">rank_history_report</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000601-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000601-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 4498</span>
4498:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">rank_history_report</span>
4499:     <span class="ruby-comment cmt"># ToDo: Change the hard coded report to a Report setting, or client base</span>
4500:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Hard coded report implementation'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/susbkk/</span>
4501: 
4502:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'export'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;yes&quot;</span>
4503:       <span class="ruby-ivar">@screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-value str">&quot;Rank History&quot;</span> ])
4504:       <span class="ruby-comment cmt">#Rank History</span>
4505:       <span class="ruby-identifier">product_type_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-value str">&quot;PRODUCT_TYPE&quot;</span> ])
4506:       <span class="ruby-identifier">customer_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-value str">&quot;Customer&quot;</span> ])
4507:       <span class="ruby-identifier">rank_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-value str">&quot;Rank&quot;</span> ])
4508:       <span class="ruby-identifier">from_year</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_from</span>][<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">3</span>].<span class="ruby-identifier">to_i</span>
4509:       <span class="ruby-identifier">from_month</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_from</span>][<span class="ruby-value">5</span><span class="ruby-operator">..</span><span class="ruby-value">6</span>].<span class="ruby-identifier">to_i</span>
4510:       <span class="ruby-identifier">to_year</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_to</span>][<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">3</span>].<span class="ruby-identifier">to_i</span>
4511:       <span class="ruby-identifier">to_month</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_to</span>][<span class="ruby-value">5</span><span class="ruby-operator">..</span><span class="ruby-value">6</span>].<span class="ruby-identifier">to_i</span>
4512:       <span class="ruby-identifier">name_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Name&quot;</span>)
4513:       <span class="ruby-identifier">from_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;From&quot;</span>)
4514:       <span class="ruby-identifier">customer_names</span> = {}
4515:       <span class="ruby-identifier">customer_names_for_sort</span> = {}
4516:       <span class="ruby-identifier">rank_names_and_scores</span> = {}
4517:       <span class="ruby-ivar">@product_type_names</span> = {}
4518:       <span class="ruby-ivar">@from_year</span> = (<span class="ruby-identifier">from_month</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">2</span>) <span class="ruby-operator">?</span> (<span class="ruby-identifier">from_year</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">from_year</span>
4519:       <span class="ruby-ivar">@to_year</span> = (<span class="ruby-identifier">to_month</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">2</span>) <span class="ruby-operator">?</span> (<span class="ruby-identifier">to_year</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">to_year</span>
4520: 
4521:       <span class="ruby-identifier">cust_rows</span> = <span class="ruby-identifier">customer_screen</span>.<span class="ruby-identifier">rows</span>
4522:       <span class="ruby-identifier">cust_gen_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">cust_rows</span>,[<span class="ruby-identifier">name_custom_field_id</span>])
4523:       <span class="ruby-identifier">cust_gen_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cust_id</span>,<span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
4524:         <span class="ruby-identifier">customer_name</span> = <span class="ruby-identifier">value</span>[<span class="ruby-identifier">name_custom_field_id</span>]
4525:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">customer_name</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>
4526:           <span class="ruby-identifier">customer_names</span>[<span class="ruby-node">&quot;#{cust_id}&quot;</span>] = <span class="ruby-identifier">customer_name</span>
4527:           <span class="ruby-identifier">customer_names_for_sort</span>[<span class="ruby-node">&quot;#{cust_id}&quot;</span>] = <span class="ruby-identifier">customer_name</span>.<span class="ruby-identifier">downcase</span>
4528:         <span class="ruby-keyword kw">end</span>
4529:       <span class="ruby-keyword kw">end</span>
4530:       <span class="ruby-ivar">@customer_names</span> = <span class="ruby-identifier">customer_names_for_sort</span>.<span class="ruby-identifier">sort</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>[<span class="ruby-value">1</span>]<span class="ruby-operator">&lt;=&gt;</span><span class="ruby-identifier">b</span>[<span class="ruby-value">1</span>]}
4531:       <span class="ruby-ivar">@customer_names</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
4532:         <span class="ruby-identifier">c</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">customer_names</span>[<span class="ruby-node">&quot;#{c[0]}&quot;</span>]
4533:       <span class="ruby-keyword kw">end</span>
4534: 
4535:       <span class="ruby-identifier">product_type_rows</span> = <span class="ruby-identifier">product_type_screen</span>.<span class="ruby-identifier">rows</span>
4536:       <span class="ruby-identifier">product_type_gen_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">product_type_rows</span>,[<span class="ruby-identifier">name_custom_field_id</span>])
4537:       <span class="ruby-identifier">product_type_gen_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">product_type_id</span>,<span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
4538:         <span class="ruby-ivar">@product_type_names</span>[<span class="ruby-node">&quot;#{product_type_id}&quot;</span>] = <span class="ruby-identifier">value</span>[<span class="ruby-identifier">name_custom_field_id</span>]
4539:       <span class="ruby-keyword kw">end</span>
4540: 
4541:       <span class="ruby-identifier">rank_rows</span> = <span class="ruby-identifier">rank_screen</span>.<span class="ruby-identifier">rows</span>
4542:       <span class="ruby-identifier">rank_gen_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">rank_rows</span>,[<span class="ruby-identifier">name_custom_field_id</span>,<span class="ruby-identifier">from_custom_field_id</span>])
4543:       <span class="ruby-identifier">rank_gen_rows</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
4544:         <span class="ruby-identifier">rank_names_and_scores</span>[<span class="ruby-node">&quot;#{value[name_custom_field_id]}&quot;</span>] = <span class="ruby-identifier">value</span>[<span class="ruby-identifier">from_custom_field_id</span>].<span class="ruby-identifier">to_f</span>
4545:       <span class="ruby-keyword kw">end</span>
4546:       <span class="ruby-ivar">@rank_names</span> = (<span class="ruby-identifier">rank_names_and_scores</span>.<span class="ruby-identifier">sort</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>[<span class="ruby-value">1</span>]<span class="ruby-operator">&lt;=&gt;</span><span class="ruby-identifier">b</span>[<span class="ruby-value">1</span>]}).<span class="ruby-identifier">reverse</span>
4547: 
4548:       <span class="ruby-comment cmt">#------------------------- Ending generate variable for use in View --------------------------------</span>
4549: 
4550:       <span class="ruby-identifier">business_record_screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-value str">&quot;Business Record&quot;</span> ])
4551:       <span class="ruby-identifier">invoice_date_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Invoice Date&quot;</span>)
4552:       <span class="ruby-identifier">invoice_amount_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Invoice Amount&quot;</span>)
4553:       <span class="ruby-identifier">issue_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Issue Tracking&quot;</span>)
4554:       <span class="ruby-identifier">customer_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Customer_REF&quot;</span>)
4555:       <span class="ruby-identifier">product_type_custom_field_id</span> = <span class="ruby-identifier">get_custom_field_id_by_name</span>(<span class="ruby-value str">&quot;Production_Type_REF&quot;</span>)
4556:       <span class="ruby-ivar">@report_data</span> = {}
4557: 
4558:       <span class="ruby-identifier">filtered_rows</span> =  <span class="ruby-identifier">business_record_screen</span>.<span class="ruby-identifier">rows</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:cells</span>],
4559:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;cells.field_id = ? and cells.value between ? and  ?&quot;</span>, <span class="ruby-identifier">invoice_date_custom_field_id</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_from</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date_to</span>]])
4560: 
4561:       <span class="ruby-identifier">gen_rows</span> = <span class="ruby-identifier">gen_rows_by_fields</span>(<span class="ruby-identifier">filtered_rows</span>,[<span class="ruby-identifier">issue_custom_field_id</span>,<span class="ruby-identifier">customer_custom_field_id</span>,<span class="ruby-identifier">invoice_amount_custom_field_id</span>,<span class="ruby-identifier">product_type_custom_field_id</span>,<span class="ruby-identifier">invoice_date_custom_field_id</span>])
4562:       <span class="ruby-identifier">filtered_rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
4563:         <span class="ruby-identifier">value</span> = <span class="ruby-identifier">gen_rows</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>]
4564:         <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">IssueTracking</span>.<span class="ruby-identifier">cancelled?</span>(<span class="ruby-identifier">value</span>[<span class="ruby-identifier">issue_custom_field_id</span>])
4565:       <span class="ruby-keyword kw">end</span>
4566: 
4567:       <span class="ruby-identifier">gen_rows</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
4568:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">customer_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>[<span class="ruby-identifier">customer_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4569:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">product_type_id</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Reference</span>.<span class="ruby-identifier">cell_ref_row_id</span>(<span class="ruby-identifier">r</span>[<span class="ruby-identifier">product_type_custom_field_id</span>])) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
4570: 
4571:         <span class="ruby-identifier">invoice_amount</span> = <span class="ruby-identifier">r</span>[<span class="ruby-identifier">invoice_amount_custom_field_id</span>]
4572:         <span class="ruby-identifier">date_time</span> = <span class="ruby-identifier">r</span>[<span class="ruby-identifier">invoice_date_custom_field_id</span>]
4573:         <span class="ruby-identifier">year</span> = <span class="ruby-identifier">date_time</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">3</span>].<span class="ruby-identifier">to_i</span>
4574:         <span class="ruby-identifier">month</span> = <span class="ruby-identifier">date_time</span>[<span class="ruby-value">5</span><span class="ruby-operator">..</span><span class="ruby-value">6</span>].<span class="ruby-identifier">to_i</span>
4575:         <span class="ruby-identifier">invoice_year</span> = (<span class="ruby-identifier">month</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">2</span>) <span class="ruby-operator">?</span> (<span class="ruby-identifier">year</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">:</span> (<span class="ruby-identifier">year</span>).<span class="ruby-identifier">to_s</span>
4576:         <span class="ruby-ivar">@report_data</span>[<span class="ruby-identifier">customer_id</span>] = {} <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@report_data</span>[<span class="ruby-identifier">customer_id</span>].<span class="ruby-identifier">nil?</span>
4577:         <span class="ruby-ivar">@report_data</span>[<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">invoice_year</span>] = {} <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@report_data</span>[<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">invoice_year</span>].<span class="ruby-identifier">nil?</span>
4578:         <span class="ruby-ivar">@report_data</span>[<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">invoice_year</span>][<span class="ruby-identifier">product_type_id</span>] = <span class="ruby-value">0</span><span class="ruby-value">.0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@report_data</span>[<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">invoice_year</span>][<span class="ruby-identifier">product_type_id</span>].<span class="ruby-identifier">nil?</span>
4579:         <span class="ruby-ivar">@report_data</span>[<span class="ruby-identifier">customer_id</span>][<span class="ruby-identifier">invoice_year</span>][<span class="ruby-identifier">product_type_id</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">invoice_amount</span>.<span class="ruby-identifier">to_f</span>
4580:       <span class="ruby-keyword kw">end</span>
4581:       <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">store_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>,
4582:         {
4583:           <span class="ruby-identifier">:report_data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@report_data</span>,
4584:           <span class="ruby-identifier">:from_year</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@from_year</span>,
4585:           <span class="ruby-identifier">:to_year</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@to_year</span>,
4586:           <span class="ruby-identifier">:product_type_names</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@product_type_names</span>,
4587:           <span class="ruby-identifier">:customer_names</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@customer_names</span>,
4588:           <span class="ruby-identifier">:rank_names</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@rank_names</span>
4589:         })
4590:     <span class="ruby-keyword kw">else</span>
4591:       <span class="ruby-identifier">vm</span> = <span class="ruby-constant">ReportsController</span>.<span class="ruby-identifier">get_session_report_results</span>(<span class="ruby-identifier">session</span>.<span class="ruby-identifier">session_id</span>, <span class="ruby-value str">&quot;&quot;</span>)
4592:       <span class="ruby-ivar">@report_data</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:report_data</span>]
4593:       <span class="ruby-ivar">@from_year</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:from_year</span>]
4594:       <span class="ruby-ivar">@to_year</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:to_year</span>]
4595:       <span class="ruby-ivar">@product_type_names</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:product_type_names</span>]
4596:       <span class="ruby-ivar">@customer_names</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:customer_names</span>]
4597:       <span class="ruby-ivar">@rank_names</span> = <span class="ruby-identifier">vm</span>[<span class="ruby-identifier">:rank_names</span>]
4598: 
4599:       <span class="ruby-identifier">export_rank_history</span>(<span class="ruby-ivar">@report_data</span>,<span class="ruby-ivar">@from_year</span>,<span class="ruby-ivar">@to_year</span>,<span class="ruby-ivar">@product_type_names</span>,<span class="ruby-ivar">@customer_names</span>,<span class="ruby-ivar">@rank_names</span>)
4600:     <span class="ruby-keyword kw">end</span>
4601:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000565" class="method-detail">
        <a name="M000565"></a>

        <div class="method-heading">
          <a href="#M000565" class="method-signature">
          <span class="method-name">remove_reserve_character</span><span class="method-args">(data)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000565-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000565-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 1000</span>
1000:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">remove_reserve_character</span>(<span class="ruby-identifier">data</span>)
1001:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
1002:       <span class="ruby-identifier">data</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot;\n&quot;</span>,<span class="ruby-value str">''</span>)
1003:       <span class="ruby-identifier">data</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot;\r&quot;</span>,<span class="ruby-value str">''</span>)
1004:       <span class="ruby-identifier">data</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">','</span>,<span class="ruby-value str">''</span>)
1005:     <span class="ruby-keyword kw">end</span>
1006:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000534" class="method-detail">
        <a name="M000534"></a>

        <div class="method-heading">
          <a href="#M000534" class="method-signature">
          <span class="method-name">screen_from_action</span><span class="method-args">(params)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000534-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000534-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 27</span>
27:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">screen_from_action</span>(<span class="ruby-identifier">params</span>)
28:     <span class="ruby-identifier">action</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:action</span>].<span class="ruby-identifier">to_sym</span>
29: 
30:     <span class="ruby-keyword kw">if</span> [<span class="ruby-identifier">:export</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">action</span>)
31:       <span class="ruby-identifier">screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
32:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:screen_id</span>].<span class="ruby-identifier">nil?</span>
33:       <span class="ruby-identifier">screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:screen_id</span>])
34:     <span class="ruby-keyword kw">end</span>
35:     
36:     <span class="ruby-identifier">screen</span> <span class="ruby-operator">||</span> <span class="ruby-keyword kw">super</span>
37:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000606" class="method-detail">
        <a name="M000606"></a>

        <div class="method-heading">
          <a href="#M000606" class="method-signature">
          <span class="method-name">search</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000606-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000606-source">
<pre>
      <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 5046</span>
5046:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">search</span> 
5047:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/development/</span>) <span class="ruby-operator">?</span> <span class="ruby-value str">&quot;&lt;span class='missing_implementation'&gt;Implement how to display the search controls.&lt;/span&gt;&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;&quot;</span>  
5048:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000540" class="method-detail">
        <a name="M000540"></a>

        <div class="method-heading">
          <a href="#M000540" class="method-signature">
          <span class="method-name">select_alias</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
GET /reports/select_alias/1
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000540-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000540-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 107</span>
107:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">select_alias</span>
108:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>].<span class="ruby-identifier">to_i</span>)
109:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000541" class="method-detail">
        <a name="M000541"></a>

        <div class="method-heading">
          <a href="#M000541" class="method-signature">
          <span class="method-name">select_criterias</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
GET /reports/select_criterias/1
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000541-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000541-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 112</span>
112:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">select_criterias</span>
113:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>].<span class="ruby-identifier">to_i</span>)
114:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000542" class="method-detail">
        <a name="M000542"></a>

        <div class="method-heading">
          <a href="#M000542" class="method-signature">
          <span class="method-name">select_fields</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
GET /reports/select_fields/1
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000542-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000542-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 117</span>
117:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">select_fields</span>
118:     <span class="ruby-ivar">@screen</span> = <span class="ruby-identifier">session</span>.<span class="ruby-identifier">active_screen</span>
119:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>].<span class="ruby-identifier">to_i</span>)
120: 
121:     <span class="ruby-ivar">@reference_screens</span> = <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screens</span>
122:     
123:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
124:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment cmt"># new_fields.html.erb</span>
125:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@report</span> }
126:     <span class="ruby-keyword kw">end</span>
127:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000550" class="method-detail">
        <a name="M000550"></a>

        <div class="method-heading">
          <a href="#M000550" class="method-signature">
          <span class="method-name">select_filters</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
GET /reports GET /reports.xml
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000550-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000550-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 279</span>
279:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">select_filters</span>
280:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
281:     <span class="ruby-ivar">@available_field_filters</span> =  <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">fields_for_filters</span>
282:     <span class="ruby-ivar">@set_field_filters</span> = {}
283:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">field_report_filters</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">frf</span><span class="ruby-operator">|</span>
284:       <span class="ruby-ivar">@set_field_filters</span>[<span class="ruby-identifier">frf</span>.<span class="ruby-identifier">reference_screen_index</span>] <span class="ruby-operator">||=</span> {}
285:       <span class="ruby-ivar">@set_field_filters</span>[<span class="ruby-identifier">frf</span>.<span class="ruby-identifier">reference_screen_index</span>][<span class="ruby-identifier">frf</span>.<span class="ruby-identifier">field_id</span>] = <span class="ruby-identifier">frf</span>
286:     }
287: 
288:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
289:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment cmt"># formats.html.erb</span>
290:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@report</span> }
291:     <span class="ruby-keyword kw">end</span>
292:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000547" class="method-detail">
        <a name="M000547"></a>

        <div class="method-heading">
          <a href="#M000547" class="method-signature">
          <span class="method-name">set_criterias</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
POST /reports POST /reports.xml
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000547-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000547-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 203</span>
203:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_criterias</span>
204:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
205:     <span class="ruby-identifier">ref_screen_count</span> = <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screen_ids</span>.<span class="ruby-identifier">size</span>
206:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>] <span class="ruby-operator">||=</span> {}
207:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-identifier">:criterias</span>] <span class="ruby-operator">||=</span> []
208: 
209:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-identifier">:criterias</span>].<span class="ruby-identifier">delete_if</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
210:       <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:a_screen_index</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span>
211:         (<span class="ruby-identifier">c</span>[<span class="ruby-identifier">:a_screen_index</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">ref_screen_count</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:a_field_id</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-operator">||</span>
212:         <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:b_screen_index</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span>
213:         (<span class="ruby-identifier">c</span>[<span class="ruby-identifier">:b_screen_index</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">ref_screen_count</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:b_field_id</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-operator">||</span>
214:         <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:operation</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">empty?</span>
215:     <span class="ruby-keyword kw">end</span>
216: 
217:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-identifier">:criterias</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
218:       <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:a_screen_index</span>] = <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:a_screen_index</span>].<span class="ruby-identifier">to_i</span>
219:       <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:a_field_id</span>] = <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:a_field_id</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:a_screen_index</span>] <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">ref_screen_count</span>
220:       <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:b_screen_index</span>] = <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:b_screen_index</span>].<span class="ruby-identifier">to_i</span>
221:       <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:b_field_id</span>] = <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:b_field_id</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:b_screen_index</span>] <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">ref_screen_count</span>
222:     <span class="ruby-keyword kw">end</span>
223: 
224:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">criterias</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-identifier">:criterias</span>]
225:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">save</span>
226:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000548" class="method-detail">
        <a name="M000548"></a>

        <div class="method-heading">
          <a href="#M000548" class="method-signature">
          <span class="method-name">set_fields</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
POST /reports POST /reports.xml
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000548-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000548-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 230</span>
230:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_fields</span>
231:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
232: 
233:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>] <span class="ruby-operator">||=</span> {}
234:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-identifier">:fields</span>] <span class="ruby-operator">||=</span> []
235: 
236:     <span class="ruby-identifier">org_field_report</span> = <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">fields_reports</span>
237:     <span class="ruby-identifier">new_field_reports</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-identifier">:fields</span>]
238: 
239:     <span class="ruby-comment cmt">#remove not exist in new</span>
240:     <span class="ruby-identifier">rem_field_report_ids</span> = <span class="ruby-identifier">org_field_report</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">fr</span><span class="ruby-operator">|</span> <span class="ruby-identifier">fr</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">compact</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">new_field_reports</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f_r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f_r</span>[<span class="ruby-identifier">:field_report_id</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">f_r</span>[<span class="ruby-identifier">:field_report_id</span>].<span class="ruby-identifier">empty?</span>}.<span class="ruby-identifier">compact</span>
241:     <span class="ruby-identifier">org_field_report</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fr</span><span class="ruby-operator">|</span>
242:       <span class="ruby-identifier">fr</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">rem_field_report_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">fr</span>.<span class="ruby-identifier">id</span>)
243:     <span class="ruby-keyword kw">end</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">rem_field_report_ids</span>.<span class="ruby-identifier">empty?</span>
244: 
245:     <span class="ruby-comment cmt"># merge field_report</span>
246:     <span class="ruby-identifier">new_field_reports</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f_r</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
247:       <span class="ruby-identifier">f_r</span>[<span class="ruby-identifier">:seq_no</span>] = <span class="ruby-identifier">idx</span>
248:       <span class="ruby-identifier">f_r</span>[<span class="ruby-value str">'formula'</span>] = <span class="ruby-constant">YAML</span><span class="ruby-operator">::</span><span class="ruby-identifier">load</span>(<span class="ruby-identifier">f_r</span>[<span class="ruby-value str">'formula'</span>].<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot;^n&quot;</span>,<span class="ruby-value str">&quot;\n&quot;</span>)) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">f_r</span>[<span class="ruby-value str">'formula'</span>].<span class="ruby-identifier">empty?</span>
249:       <span class="ruby-identifier">field_report_id</span> = <span class="ruby-identifier">f_r</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:field_report_id</span>).<span class="ruby-identifier">to_i</span>
250:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">field_report_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
251:         <span class="ruby-identifier">f_r</span>[<span class="ruby-value str">'percentage_weight'</span>] = {<span class="ruby-value str">&quot;-1&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;false&quot;</span>}
252:         
253:         <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">fields_reports</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">FieldsReport</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">f_r</span>)
254:       <span class="ruby-keyword kw">else</span>
255:         <span class="ruby-identifier">field_report</span> = <span class="ruby-constant">FieldsReport</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">field_report_id</span>)
256:         <span class="ruby-identifier">field_report</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">f_r</span>)
257:       <span class="ruby-keyword kw">end</span>
258:     <span class="ruby-keyword kw">end</span>
259: 
260:     <span class="ruby-identifier">ht_report</span> = {}
261:     <span class="ruby-identifier">ht_report</span>[<span class="ruby-identifier">:cell_location</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-identifier">:cell_location</span>]
262:     
263:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">ht_report</span>)
264:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000563" class="method-detail">
        <a name="M000563"></a>

        <div class="method-heading">
          <a href="#M000563" class="method-signature">
          <span class="method-name">set_max_col</span><span class="method-args">(max_col, column, data)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000563-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000563-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 747</span>
747:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_max_col</span>(<span class="ruby-identifier">max_col</span>, <span class="ruby-identifier">column</span>, <span class="ruby-identifier">data</span>)    
748:     <span class="ruby-identifier">max_col</span>[<span class="ruby-identifier">column</span>.<span class="ruby-identifier">to_i</span>] =  [<span class="ruby-value">2</span>, <span class="ruby-identifier">max_col</span>[<span class="ruby-identifier">column</span>.<span class="ruby-identifier">to_i</span>].<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">length</span>].<span class="ruby-identifier">max</span>
749:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000546" class="method-detail">
        <a name="M000546"></a>

        <div class="method-heading">
          <a href="#M000546" class="method-signature">
          <span class="method-name">set_reference_screen_alias</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
POST /reports POST /reports.xml
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000546-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000546-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 182</span>
182:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_reference_screen_alias</span>
183:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
184: 
185:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>] <span class="ruby-operator">||=</span> {}
186:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-identifier">:reference_screen_alias</span>] <span class="ruby-operator">||=</span> {}
187: 
188:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screen_alias</span> = []
189:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screen_outer_joins</span> = []
190:     
191:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screens</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
192:       <span class="ruby-identifier">a</span> = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">label_descr</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[^A-Z]/</span>,<span class="ruby-value str">''</span>).<span class="ruby-identifier">downcase</span>
193:       <span class="ruby-identifier">a</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;_#{@report.reference_screen_alias.select{|x| x =~ Regexp.new(&quot;(^#{a}$|^#{a}_[0-9]+$)&quot;) }.length}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screen_alias</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>)
194:       <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screen_alias</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-identifier">:reference_screen_alias</span>][<span class="ruby-identifier">i</span>.<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">a</span>)
195:       <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screen_outer_joins</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-identifier">:reference_screen_outer_joins</span>][<span class="ruby-identifier">i</span>.<span class="ruby-identifier">to_s</span>]
196:     <span class="ruby-keyword kw">end</span>
197: 
198:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">save</span>
199:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000536" class="method-detail">
        <a name="M000536"></a>

        <div class="method-heading">
          <a href="#M000536" class="method-signature">
          <span class="method-name">show</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
GET /reports/1 GET /reports/1.xml
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000536-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000536-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 55</span>
55:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">show</span>
56:     <span class="ruby-ivar">@screen</span> = <span class="ruby-identifier">session</span>.<span class="ruby-identifier">active_screen</span>
57:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
58: 
59:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
60:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment cmt"># show.html.erb</span>
61:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@report</span> }
62:     <span class="ruby-keyword kw">end</span>
63:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000544" class="method-detail">
        <a name="M000544"></a>

        <div class="method-heading">
          <a href="#M000544" class="method-signature">
          <span class="method-name">update</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
PUT /reports/1 PUT /reports/1.xml
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000544-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000544-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 155</span>
155:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update</span>
156:     <span class="ruby-ivar">@report</span> = <span class="ruby-constant">Report</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
157:     
158:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-value str">'reference_screen_ids'</span>].<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s_id</span>, <span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
159:       <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screen_outer_joins</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value str">&quot;-1&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">s_id</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">-1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screen_outer_joins</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">nil?</span>
160:     <span class="ruby-keyword kw">end</span>
161: 
162:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-value str">'reference_screen_outer_joins'</span>] = <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">reference_screen_outer_joins</span>
163: 
164:     <span class="ruby-ivar">@report</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>])
165: 
166:     <span class="ruby-identifier">clean_field_filters</span>
167: 
168:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
169:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment cmt"># update.html.erb</span>
170:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@report</span> }
171:     <span class="ruby-keyword kw">end</span>
172:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000554" class="method-detail">
        <a name="M000554"></a>

        <div class="method-heading">
          <a href="#M000554" class="method-signature">
          <span class="method-name">update_filter</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
PUT /reports/update_format PUT /reports/update_format/1.xml
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000554-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000554-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 340</span>
340:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_filter</span>
341:     <span class="ruby-identifier">field_report_filter_id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]
342:     
343:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">field_report_filter_id</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/_/</span>
344:       <span class="ruby-comment cmt"># Create</span>
345:       <span class="ruby-ivar">@field_report_filter</span> = <span class="ruby-constant">FieldReportFilter</span>.<span class="ruby-identifier">create</span>(
346:         <span class="ruby-identifier">:reference_screen_index</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:reference_screen_index</span>],
347:         <span class="ruby-identifier">:field_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:field_id</span>],
348:         <span class="ruby-identifier">:report_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report_id</span>],
349:         <span class="ruby-identifier">:value</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:value</span>])
350:     <span class="ruby-keyword kw">else</span>
351:       <span class="ruby-ivar">@field_report_filter</span> = <span class="ruby-constant">FieldReportFilter</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">field_report_filter_id</span>.<span class="ruby-identifier">to_i</span>)
352:       
353:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">:destroy</span>)
354:         <span class="ruby-comment cmt"># Delete</span>
355:         <span class="ruby-ivar">@field_report_filter</span>.<span class="ruby-identifier">destroy</span>
356:       <span class="ruby-keyword kw">else</span>
357:         <span class="ruby-comment cmt"># Update</span>
358:         <span class="ruby-ivar">@field_report_filter</span>.<span class="ruby-identifier">value</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:value</span>]
359:         <span class="ruby-ivar">@field_report_filter</span>.<span class="ruby-identifier">save</span>
360:       <span class="ruby-keyword kw">end</span>
361:     <span class="ruby-keyword kw">end</span>
362:     <span class="ruby-ivar">@set_field_filters</span> = {
363:       <span class="ruby-ivar">@field_report_filter</span>.<span class="ruby-identifier">reference_screen_index</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-ivar">@field_report_filter</span>.<span class="ruby-identifier">field_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@field_report_filter</span> }
364:     }
365:     <span class="ruby-ivar">@available_field_filters</span> =  <span class="ruby-ivar">@field_report_filter</span>.<span class="ruby-identifier">report</span>.<span class="ruby-identifier">fields_for_filters</span>
366: 
367:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
368:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment cmt"># edit_format.html.erb</span>
369:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@field_report_filter</span> }
370:     <span class="ruby-keyword kw">end</span>
371:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000552" class="method-detail">
        <a name="M000552"></a>

        <div class="method-heading">
          <a href="#M000552" class="method-signature">
          <span class="method-name">update_format</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
PUT /reports/update_format PUT /reports/update_format/1.xml
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000552-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000552-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 308</span>
308:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_format</span>
309:     <span class="ruby-ivar">@field_report</span> = <span class="ruby-constant">FieldsReport</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]) 
310: 
311:     <span class="ruby-ivar">@field_report</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:field_report</span>])
312:     
313:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
314:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment cmt"># update_format.html.erb</span>
315:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@report</span> }
316:     <span class="ruby-keyword kw">end</span>
317:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000562" class="method-detail">
        <a name="M000562"></a>

        <div class="method-heading">
          <a href="#M000562" class="method-signature">
          <span class="method-name">xls</span><span class="method-args">(rows)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000562-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000562-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/reports_controller.rb, line 447</span>
447:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">xls</span>(<span class="ruby-identifier">rows</span>)
448: 
449:     <span class="ruby-comment cmt"># XLS File Name</span>
450:     <span class="ruby-comment cmt">#    staff_row = session['user'].staff_row</span>
451:     <span class="ruby-identifier">screen</span> = <span class="ruby-constant">Screen</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:screen_id</span>])
452:     <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-value str">&quot;%Y%m%d%H%M&quot;</span>)
453:     <span class="ruby-identifier">file_name</span> = <span class="ruby-node">&quot;#{screen.name}_#{time}&quot;</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot; &quot;</span>,<span class="ruby-value str">&quot;_&quot;</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot;/&quot;</span>,<span class="ruby-value str">&quot;&quot;</span>)
454:           <span class="ruby-identifier">file_path</span> = <span class="ruby-node">&quot;#{RAILS_ROOT}/public/ReportFile/#{file_name}.xls&quot;</span>
455:     <span class="ruby-identifier">workbook</span>  = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">WriteExcel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;#{file_path}&quot;</span>) 
456:     <span class="ruby-identifier">worksheet</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_worksheet</span>
457:     <span class="ruby-identifier">header_format</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:border</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">:bold</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>, <span class="ruby-identifier">:bg_color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">27</span>, <span class="ruby-identifier">:merge</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">:align</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'vcenter'</span>)
458:           <span class="ruby-identifier">data_format</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:border</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>, <span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">10</span>)
459:     <span class="ruby-identifier">group_format</span> = <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">add_format</span>(<span class="ruby-identifier">:border</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">:bold</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">:bg_color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">27</span> , <span class="ruby-identifier">:valign</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'vcenter'</span>, <span class="ruby-identifier">:align</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'center'</span>)
460:     
461:     <span class="ruby-identifier">display_flag_label</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-value str">&quot;G_List&quot;</span>)
462:     <span class="ruby-identifier">fields</span> = []
463:     <span class="ruby-identifier">custom_field_ids</span> = []
464:     <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span>
465:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">field</span>.<span class="ruby-identifier">display_in_screen?</span>(<span class="ruby-identifier">display_flag_label</span>)
466:         <span class="ruby-identifier">fields</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">field</span>
467:         <span class="ruby-identifier">custom_field_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">field</span>.<span class="ruby-identifier">custom_field_id</span>
468:       <span class="ruby-keyword kw">end</span>
469:     <span class="ruby-keyword kw">end</span>
470: 
471:     <span class="ruby-identifier">custom_field_ids</span>.<span class="ruby-identifier">compact!</span>
472: 
473:     <span class="ruby-comment cmt"># XLS Header</span>
474:     <span class="ruby-identifier">line</span> = <span class="ruby-value">0</span>
475:     <span class="ruby-identifier">column</span> = <span class="ruby-value">0</span>
476:     <span class="ruby-identifier">childs</span> = []
477:     <span class="ruby-identifier">col</span> = <span class="ruby-value">0</span>
478:     <span class="ruby-identifier">max_col</span> = {}
479:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">screen</span>.<span class="ruby-identifier">field_level</span>
480:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;RevisionScreen&quot;</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
481:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">field_level!</span>=<span class="ruby-value">1</span>
482:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">merge_range</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">line</span><span class="ruby-operator">+</span><span class="ruby-identifier">screen</span>.<span class="ruby-identifier">field_level</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>,<span class="ruby-identifier">column</span>, <span class="ruby-value str">&quot;Rev No&quot;</span>,<span class="ruby-identifier">group_format</span>)
483:         <span class="ruby-keyword kw">else</span>
484:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-value str">&quot;Rev No&quot;</span>,<span class="ruby-identifier">header_format</span>)
485:         <span class="ruby-keyword kw">end</span>
486:         <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
487:       <span class="ruby-keyword kw">end</span>
488:       
489:       <span class="ruby-identifier">headers</span> = []
490:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">DetailScreen</span>)
491:         <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">header_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
492:           <span class="ruby-identifier">descrs</span> = []
493:           <span class="ruby-identifier">descrs</span> = [<span class="ruby-identifier">f</span>.<span class="ruby-identifier">descr</span>()].<span class="ruby-identifier">flatten</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Grouping</span>)
494:           <span class="ruby-identifier">headers</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">descrs</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>{<span class="ruby-identifier">:descr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">d</span>,<span class="ruby-identifier">:col_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">col_span</span>(<span class="ruby-identifier">:row_pattern</span> =<span class="ruby-operator">&gt;</span><span class="ruby-ivar">@row_pattern</span>),<span class="ruby-identifier">:row_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">row_span</span>}}
495:         <span class="ruby-keyword kw">end</span>
496:         <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
497:           <span class="ruby-identifier">descrs</span> = []
498:           <span class="ruby-identifier">descrs</span> = [<span class="ruby-identifier">f</span>.<span class="ruby-identifier">descr</span>()].<span class="ruby-identifier">flatten</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Grouping</span>)
499:           <span class="ruby-identifier">headers</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">descrs</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>{<span class="ruby-identifier">:descr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">d</span>,<span class="ruby-identifier">:col_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">col_span</span>(<span class="ruby-identifier">:row_pattern</span> =<span class="ruby-operator">&gt;</span><span class="ruby-ivar">@row_pattern</span>),<span class="ruby-identifier">:row_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">row_span</span>}}
500:         <span class="ruby-keyword kw">end</span>
501:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">RevisionScreen</span>)
502:         <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">header_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
503:           <span class="ruby-identifier">descrs</span> = []
504:           <span class="ruby-identifier">descrs</span> = [<span class="ruby-identifier">f</span>.<span class="ruby-identifier">descr</span>()].<span class="ruby-identifier">flatten</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Grouping</span>)
505:           <span class="ruby-identifier">headers</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">descrs</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>{<span class="ruby-identifier">:descr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">d</span>,<span class="ruby-identifier">:col_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">col_span</span>(<span class="ruby-identifier">:row_pattern</span> =<span class="ruby-operator">&gt;</span><span class="ruby-ivar">@row_pattern</span>),<span class="ruby-identifier">:row_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">row_span</span>}}
506:         <span class="ruby-keyword kw">end</span>
507:       <span class="ruby-keyword kw">end</span>
508:       
509:       <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">list_fields_level</span>(<span class="ruby-identifier">i</span>).<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
510:         <span class="ruby-identifier">descrs</span> = []
511:         <span class="ruby-identifier">descrs</span> = [<span class="ruby-identifier">f</span>.<span class="ruby-identifier">descr</span>(<span class="ruby-identifier">:row_pattern</span> =<span class="ruby-operator">&gt;</span><span class="ruby-ivar">@row_pattern</span>)].<span class="ruby-identifier">flatten</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Grouping</span>)
512:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Calendar</span>)
513:           <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">format</span>
514:           <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:monthly</span>   
515:             <span class="ruby-identifier">start_date</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">DateTimeField</span>.<span class="ruby-identifier">begin_of_period</span>(<span class="ruby-constant">Date</span>.<span class="ruby-identifier">null_date</span>, <span class="ruby-identifier">:year</span>)
516:             <span class="ruby-identifier">end_date</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">DateTimeField</span>.<span class="ruby-identifier">end_of_period</span>(<span class="ruby-constant">Date</span>.<span class="ruby-identifier">null_date</span>, <span class="ruby-identifier">:year</span>)
517: 
518:             <span class="ruby-identifier">diff_year</span> =  <span class="ruby-identifier">start_date</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">end_date</span>.<span class="ruby-identifier">year</span>
519:             <span class="ruby-identifier">headers</span> <span class="ruby-operator">+=</span> [{<span class="ruby-identifier">:descr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;Date&quot;</span>,<span class="ruby-identifier">:col_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">col_span</span>(<span class="ruby-identifier">:row_pattern</span> =<span class="ruby-operator">&gt;</span><span class="ruby-ivar">@row_pattern</span>),<span class="ruby-identifier">:row_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">row_span</span>}]
520:             <span class="ruby-keyword kw">while</span>(<span class="ruby-identifier">start_date</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">end_date</span>)
521:               <span class="ruby-identifier">headers</span> <span class="ruby-operator">+=</span> [{<span class="ruby-identifier">:descr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;Date&quot;</span>,<span class="ruby-identifier">:col_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">col_span</span>(<span class="ruby-identifier">:row_pattern</span> =<span class="ruby-operator">&gt;</span><span class="ruby-ivar">@row_pattern</span>),<span class="ruby-identifier">:row_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">row_span</span>}] <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">start_date</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">end_date</span>.<span class="ruby-identifier">beginning_of_year</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">diff_year</span>
522:               <span class="ruby-identifier">headers</span> <span class="ruby-operator">+=</span> [{<span class="ruby-identifier">:descr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{start_date.strftime(&quot;%b&quot;)}&quot;</span>,<span class="ruby-identifier">:col_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">col_span</span>(<span class="ruby-identifier">:row_pattern</span> =<span class="ruby-operator">&gt;</span><span class="ruby-ivar">@row_pattern</span>),<span class="ruby-identifier">:row_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">row_span</span>}]
523:               <span class="ruby-identifier">start_date</span> = <span class="ruby-identifier">start_date</span>.<span class="ruby-identifier">next_month</span>
524:             <span class="ruby-keyword kw">end</span>
525:           <span class="ruby-keyword kw">end</span>
526:         <span class="ruby-keyword kw">else</span> 
527:           <span class="ruby-identifier">headers</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">descrs</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>{<span class="ruby-identifier">:descr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">d</span>,<span class="ruby-identifier">:col_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">col_span</span>(<span class="ruby-identifier">:row_pattern</span> =<span class="ruby-operator">&gt;</span><span class="ruby-ivar">@row_pattern</span>),<span class="ruby-identifier">:row_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">row_span</span>}}
528:         <span class="ruby-keyword kw">end</span>
529: 
530:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">childs</span>.<span class="ruby-identifier">empty?</span>
531:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">childs</span>.<span class="ruby-identifier">empty?</span>
532:             <span class="ruby-identifier">childs</span> <span class="ruby-operator">+=</span> [{<span class="ruby-identifier">:field</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">childs</span>.<span class="ruby-identifier">first</span>,<span class="ruby-identifier">:column</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">col</span>}]
533:           <span class="ruby-keyword kw">else</span>
534:             <span class="ruby-identifier">childs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
535:               <span class="ruby-identifier">childs</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:field</span>].<span class="ruby-identifier">eql?</span>(<span class="ruby-identifier">f</span>) <span class="ruby-operator">?</span> [{<span class="ruby-identifier">:field</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">childs</span>.<span class="ruby-identifier">first</span>,<span class="ruby-identifier">:column</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:column</span>]}] <span class="ruby-operator">:</span> [{<span class="ruby-identifier">:field</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">childs</span>.<span class="ruby-identifier">first</span>,<span class="ruby-identifier">:column</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">col</span>}]
536:             <span class="ruby-keyword kw">end</span>
537:           <span class="ruby-keyword kw">end</span>
538:         <span class="ruby-keyword kw">end</span>
539:         <span class="ruby-identifier">col</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">headers</span>[<span class="ruby-identifier">index</span>][<span class="ruby-identifier">:col_span</span>]
540:       <span class="ruby-keyword kw">end</span> 
541: 
542:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">HeaderScreen</span>)
543:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">control_revision?</span>
544:           <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
545:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_header_list?</span>
546:               <span class="ruby-identifier">descrs</span> = []
547:               <span class="ruby-identifier">descrs</span> = [<span class="ruby-identifier">f</span>.<span class="ruby-identifier">descr</span>()].<span class="ruby-identifier">flatten</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Grouping</span>)
548:               <span class="ruby-identifier">headers</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">descrs</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>{<span class="ruby-identifier">:descr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">d</span>,<span class="ruby-identifier">:col_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">col_span</span>(<span class="ruby-identifier">:row_pattern</span> =<span class="ruby-operator">&gt;</span><span class="ruby-ivar">@row_pattern</span>),<span class="ruby-identifier">:row_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">row_span</span>}}
549:             <span class="ruby-keyword kw">end</span>
550:           <span class="ruby-keyword kw">end</span>
551:         <span class="ruby-keyword kw">else</span>
552:           <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
553:             <span class="ruby-identifier">descrs</span> = []
554:             <span class="ruby-identifier">descrs</span> = [<span class="ruby-identifier">f</span>.<span class="ruby-identifier">descr</span>()].<span class="ruby-identifier">flatten</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Grouping</span>)
555:             <span class="ruby-identifier">headers</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">descrs</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>{<span class="ruby-identifier">:descr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">d</span>,<span class="ruby-identifier">:col_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">col_span</span>(<span class="ruby-identifier">:row_pattern</span> =<span class="ruby-operator">&gt;</span><span class="ruby-ivar">@row_pattern</span>),<span class="ruby-identifier">:row_span</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">row_span</span>}}
556:           <span class="ruby-keyword kw">end</span>
557:         <span class="ruby-keyword kw">end</span>
558:       <span class="ruby-keyword kw">end</span>
559: 
560:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">childs</span>.<span class="ruby-identifier">empty?</span>
561:         <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">list_fields_level</span>(<span class="ruby-identifier">i</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
562:           <span class="ruby-identifier">column</span> = <span class="ruby-identifier">childs</span>.<span class="ruby-identifier">first</span>[<span class="ruby-identifier">:column</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">childs</span>.<span class="ruby-identifier">first</span>[<span class="ruby-identifier">:field</span>].<span class="ruby-identifier">eql?</span>(<span class="ruby-identifier">f</span>)
563:         <span class="ruby-keyword kw">end</span>
564:         <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">list_fields_level</span>(<span class="ruby-identifier">i</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
565:           <span class="ruby-identifier">childs</span>.<span class="ruby-identifier">delete_if</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>[<span class="ruby-identifier">:field</span>].<span class="ruby-identifier">eql?</span>(<span class="ruby-identifier">f</span>) }
566:         <span class="ruby-keyword kw">end</span>
567:       <span class="ruby-keyword kw">end</span>
568: 
569:       <span class="ruby-identifier">column</span> = <span class="ruby-value">3</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;DetailScreen&quot;</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
570:       <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span>
571: 
572:         <span class="ruby-identifier">set_max_col</span>(<span class="ruby-identifier">max_col</span>, <span class="ruby-identifier">column</span>, <span class="ruby-identifier">h</span>[<span class="ruby-identifier">:descr</span>])
573: 
574:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">:row_span</span>]<span class="ruby-operator">!=</span><span class="ruby-value">1</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">:col_span</span>]<span class="ruby-operator">!=</span><span class="ruby-value">1</span>
575:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">merge_range</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">line</span><span class="ruby-operator">+</span><span class="ruby-identifier">h</span>[<span class="ruby-identifier">:row_span</span>]<span class="ruby-operator">-</span><span class="ruby-value">1</span>,<span class="ruby-identifier">column</span><span class="ruby-operator">+</span><span class="ruby-identifier">h</span>[<span class="ruby-identifier">:col_span</span>]<span class="ruby-operator">-</span><span class="ruby-value">1</span>, (<span class="ruby-identifier">h</span>[<span class="ruby-identifier">:descr</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/&amp;nbsp;/</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">:descr</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">:descr</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">titleize</span>, <span class="ruby-identifier">group_format</span>)
576:         <span class="ruby-keyword kw">else</span>
577:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,(<span class="ruby-identifier">h</span>[<span class="ruby-identifier">:descr</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/&amp;nbsp;/</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">:descr</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">:descr</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">titleize</span>,<span class="ruby-identifier">header_format</span>)
578:         <span class="ruby-keyword kw">end</span>
579:         <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">:col_span</span>]
580:       <span class="ruby-keyword kw">end</span>
581: 
582:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">field_level!</span>=<span class="ruby-value">1</span>
583:         <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">HeaderScreen</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>)
584:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">merge_range</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>, <span class="ruby-identifier">line</span><span class="ruby-operator">+</span><span class="ruby-identifier">screen</span>.<span class="ruby-identifier">field_level</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>, <span class="ruby-identifier">column</span>, <span class="ruby-value str">&quot;Latest Rev no&quot;</span>, <span class="ruby-identifier">group_format</span>)
585:           <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
586:         <span class="ruby-keyword kw">end</span>
587:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">merge_range</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>, <span class="ruby-identifier">line</span><span class="ruby-operator">+</span><span class="ruby-identifier">screen</span>.<span class="ruby-identifier">field_level</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>, <span class="ruby-identifier">column</span>, <span class="ruby-value str">&quot;Remark&quot;</span>, <span class="ruby-identifier">group_format</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
588:       <span class="ruby-keyword kw">else</span>
589:         <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">HeaderScreen</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>)
590:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>, <span class="ruby-identifier">column</span>, <span class="ruby-value str">&quot;Latest Rev no&quot;</span>, <span class="ruby-identifier">header_format</span>)
591:           <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
592:         <span class="ruby-keyword kw">end</span>
593:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>, <span class="ruby-identifier">column</span>, <span class="ruby-value str">&quot;Remark&quot;</span>, <span class="ruby-identifier">header_format</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
594:       <span class="ruby-keyword kw">end</span>
595: 
596:       <span class="ruby-identifier">line</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
597:       <span class="ruby-identifier">column</span> = <span class="ruby-value">0</span>
598:       <span class="ruby-identifier">col</span> = <span class="ruby-value">0</span>
599:       
600:     <span class="ruby-keyword kw">end</span>
601: 
602:     <span class="ruby-comment cmt"># Checking field Screen</span>
603:     <span class="ruby-identifier">header_fields</span> = []
604:     <span class="ruby-identifier">revision_fields</span> = []
605:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">DetailScreen</span>)
606:       <span class="ruby-identifier">revision_fields</span> = <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Grouping</span>)}.<span class="ruby-identifier">compact</span>
607:       <span class="ruby-identifier">header_fields</span> = <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">header_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Grouping</span>)}.<span class="ruby-identifier">compact</span>
608:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">RevisionScreen</span>)
609:       <span class="ruby-identifier">header_fields</span> = <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">header_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Grouping</span>)}.<span class="ruby-identifier">compact</span>
610:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">HeaderScreen</span>)
611:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">control_revision?</span>
612:         <span class="ruby-identifier">revision_fields</span> = <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_header_list?</span>}.<span class="ruby-identifier">compact</span>
613:       <span class="ruby-keyword kw">else</span>
614:         <span class="ruby-identifier">revision_fields</span> = <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">display_in_list?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Grouping</span>)}.<span class="ruby-identifier">compact</span>
615:       <span class="ruby-keyword kw">end</span>
616:     <span class="ruby-keyword kw">end</span>
617:     <span class="ruby-comment cmt"># XLS Data</span>
618:     <span class="ruby-identifier">rows</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>
619:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">row</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">DetailRow</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">DetailScreen</span>)
620:         <span class="ruby-identifier">header_row</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">revision_row</span>.<span class="ruby-identifier">header_row</span>
621:         <span class="ruby-identifier">header_fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">h_field</span><span class="ruby-operator">|</span>
622:           <span class="ruby-identifier">custom_field</span> = <span class="ruby-identifier">h_field</span>.<span class="ruby-identifier">custom_field</span>
623:           <span class="ruby-identifier">cell</span> = <span class="ruby-identifier">header_row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">nil?</span>
624:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">gen_data_xls</span>(<span class="ruby-identifier">h_field</span>, <span class="ruby-identifier">cell</span>, <span class="ruby-identifier">header_row</span>)
625:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">remove_reserve_character</span>(<span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
626:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">data</span>,<span class="ruby-identifier">data_format</span>)
627:           <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
628:         <span class="ruby-keyword kw">end</span>
629: 
630:         <span class="ruby-identifier">revision_row</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">revision_row</span>
631:         <span class="ruby-identifier">revision_fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r_field</span><span class="ruby-operator">|</span>
632:           <span class="ruby-identifier">custom_field</span> = <span class="ruby-identifier">r_field</span>.<span class="ruby-identifier">custom_field</span>
633:           <span class="ruby-identifier">cell</span> = <span class="ruby-identifier">revision_row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">nil?</span>
634:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">gen_data_xls</span>(<span class="ruby-identifier">r_field</span>, <span class="ruby-identifier">cell</span>, <span class="ruby-identifier">revision_row</span>)
635:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">remove_reserve_character</span>(<span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
636:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">data</span>,<span class="ruby-identifier">data_format</span>)
637:           <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
638:         <span class="ruby-keyword kw">end</span>
639: 
640:         <span class="ruby-identifier">data</span> = <span class="ruby-identifier">revision_row</span>.<span class="ruby-identifier">rev_no</span>.<span class="ruby-identifier">to_s</span>
641:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">data</span>,<span class="ruby-identifier">data_format</span>)
642:         <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
643:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">row</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">RevisionRow</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">RevisionScreen</span>)
644:         <span class="ruby-identifier">data</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">rev_no</span>.<span class="ruby-identifier">to_s</span>
645:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">data</span>,<span class="ruby-identifier">data_format</span>)
646:         <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
647:         <span class="ruby-identifier">header_row</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">header_row</span>
648:         <span class="ruby-identifier">header_fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">h_field</span><span class="ruby-operator">|</span>
649:           <span class="ruby-identifier">custom_field</span> = <span class="ruby-identifier">h_field</span>.<span class="ruby-identifier">custom_field</span>
650:           <span class="ruby-identifier">cell</span> = <span class="ruby-identifier">header_row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">nil?</span>
651:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">gen_data_xls</span>(<span class="ruby-identifier">h_field</span>, <span class="ruby-identifier">cell</span>, <span class="ruby-identifier">header_row</span>)
652:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">remove_reserve_character</span>(<span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
653:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">data</span>,<span class="ruby-identifier">data_format</span>)
654:           <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
655:         <span class="ruby-keyword kw">end</span>
656:       <span class="ruby-keyword kw">end</span> 
657: 
658:       <span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span>
659:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">field</span>.<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">Calendar</span>)
660:           <span class="ruby-identifier">custom_field</span> = <span class="ruby-identifier">field</span>.<span class="ruby-identifier">custom_field</span>
661:           <span class="ruby-identifier">cell</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">nil?</span>
662:           <span class="ruby-identifier">detail_fields</span> = <span class="ruby-identifier">cell</span>.<span class="ruby-identifier">field</span>.<span class="ruby-identifier">detail_screen</span>.<span class="ruby-identifier">fields</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span> <span class="ruby-identifier">field</span>.<span class="ruby-identifier">display_in_list?</span> }
663:           <span class="ruby-identifier">display_label</span> = <span class="ruby-identifier">detail_fields</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
664:           <span class="ruby-identifier">selected_date</span> = <span class="ruby-identifier">cell</span>.<span class="ruby-identifier">value</span>[<span class="ruby-identifier">:selected_date</span>].<span class="ruby-identifier">to_date</span>
665:           <span class="ruby-identifier">start_date</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">DateTimeField</span>.<span class="ruby-identifier">begin_of_period</span>(<span class="ruby-identifier">selected_date</span>, <span class="ruby-identifier">:year</span>)
666:           <span class="ruby-identifier">end_date</span> = <span class="ruby-constant">CustomFields</span><span class="ruby-operator">::</span><span class="ruby-constant">DateTimeField</span>.<span class="ruby-identifier">end_of_period</span>(<span class="ruby-identifier">selected_date</span>, <span class="ruby-identifier">:year</span>)
667:           <span class="ruby-identifier">diff_year</span> =  <span class="ruby-identifier">start_date</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">end_date</span>.<span class="ruby-identifier">year</span>
668:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">start_date</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_s</span>
669:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">data</span>,<span class="ruby-identifier">data_format</span>)
670:           <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
671: 
672:           <span class="ruby-identifier">cell</span>.<span class="ruby-identifier">calendar_values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">calendar_value</span><span class="ruby-operator">|</span>
673:             <span class="ruby-identifier">cell_data</span> = <span class="ruby-value str">&quot;&quot;</span>
674:             <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">start_date</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">end_date</span>.<span class="ruby-identifier">beginning_of_year</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">diff_year</span>
675:               <span class="ruby-identifier">data</span> = <span class="ruby-identifier">start_date</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_s</span>
676:               <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">data</span>,<span class="ruby-identifier">data_format</span>)
677:               <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
678:             <span class="ruby-keyword kw">end</span>
679:             <span class="ruby-identifier">cell_data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">detail_fields</span>.<span class="ruby-identifier">collect</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">detail_field</span><span class="ruby-operator">|</span>
680: 
681:               <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">detail_field</span>
682:               <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Fields</span><span class="ruby-operator">::</span><span class="ruby-constant">Data</span>
683:                 <span class="ruby-identifier">cv_cell</span> = <span class="ruby-identifier">calendar_value</span>.<span class="ruby-identifier">row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">detail_field</span>.<span class="ruby-identifier">custom_field_id</span>)
684:                 <span class="ruby-identifier">data</span> = <span class="ruby-identifier">gen_data_xls</span>(<span class="ruby-identifier">detail_field</span>, <span class="ruby-identifier">cv_cell</span>, <span class="ruby-identifier">row</span>).<span class="ruby-identifier">to_s</span>
685:                 <span class="ruby-identifier">data</span> = <span class="ruby-identifier">remove_reserve_character</span>(<span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
686:               <span class="ruby-keyword kw">else</span>
687:                 <span class="ruby-identifier">data</span> = <span class="ruby-identifier">detail_field</span>.<span class="ruby-identifier">evaluate_value</span>(<span class="ruby-identifier">calendar_value</span>.<span class="ruby-identifier">row</span>).<span class="ruby-identifier">to_s</span>
688:               <span class="ruby-keyword kw">end</span>
689: 
690:               <span class="ruby-node">&quot;#{detail_field.label_descr + &quot; : &quot; if display_label}#{data}, &quot;</span>
691:             <span class="ruby-keyword kw">end</span>.<span class="ruby-identifier">join</span>
692:             <span class="ruby-identifier">cell_data</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp re">/, $/</span>, <span class="ruby-value str">''</span>)
693:             <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">cell_data</span>,<span class="ruby-identifier">data_format</span>)
694: 
695:             <span class="ruby-identifier">set_max_col</span>(<span class="ruby-identifier">max_col</span>, <span class="ruby-identifier">column</span>, <span class="ruby-identifier">cell_data</span>)
696: 
697:            <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
698:             <span class="ruby-identifier">start_date</span> = <span class="ruby-identifier">start_date</span> = <span class="ruby-identifier">start_date</span>.<span class="ruby-identifier">next_month</span>
699:           <span class="ruby-keyword kw">end</span>
700: 
701:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">field</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;Fields::Grouping&quot;</span>
702:           <span class="ruby-identifier">data</span> = <span class="ruby-value str">&quot;&quot;</span>
703:           <span class="ruby-identifier">custom_field</span> = <span class="ruby-identifier">field</span>.<span class="ruby-identifier">custom_field</span>
704:           <span class="ruby-identifier">cell</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">nil?</span>
705:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">gen_data_xls</span>(<span class="ruby-identifier">field</span>, <span class="ruby-identifier">cell</span>, <span class="ruby-identifier">row</span>)
706:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">remove_reserve_character</span>(<span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
707:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">data</span>,<span class="ruby-identifier">data_format</span>)
708: 
709:           <span class="ruby-identifier">set_max_col</span>(<span class="ruby-identifier">max_col</span>, <span class="ruby-identifier">column</span>, <span class="ruby-identifier">data</span>)
710: 
711:           <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
712:         <span class="ruby-keyword kw">end</span>
713:       <span class="ruby-keyword kw">end</span>
714:       
715:       <span class="ruby-identifier">max_col</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">col</span>, <span class="ruby-identifier">length</span><span class="ruby-operator">|</span>
716:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">set_column</span>(<span class="ruby-identifier">col</span>, <span class="ruby-identifier">col</span>, <span class="ruby-identifier">length</span>)
717:       <span class="ruby-keyword kw">end</span>
718:       
719:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">row</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">HeaderRow</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">HeaderScreen</span>)
720:         <span class="ruby-identifier">revision_row</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">latest_revision</span>
721:         <span class="ruby-identifier">revision_fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r_field</span><span class="ruby-operator">|</span>
722:           <span class="ruby-identifier">custom_field</span> = <span class="ruby-identifier">r_field</span>.<span class="ruby-identifier">custom_field</span>
723:           <span class="ruby-identifier">cell</span> = <span class="ruby-identifier">revision_row</span>.<span class="ruby-identifier">cell</span>(<span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">custom_field</span>.<span class="ruby-identifier">nil?</span>
724: 
725:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">screen</span>.<span class="ruby-identifier">revision_screen</span>.<span class="ruby-identifier">control_revision?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">r_field</span>.<span class="ruby-identifier">display_in_header_list?</span>)
726: 
727:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">gen_data_xls</span>(<span class="ruby-identifier">r_field</span>, <span class="ruby-identifier">cell</span>, <span class="ruby-identifier">revision_row</span>)
728:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">remove_reserve_character</span>(<span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span>
729:           <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">data</span>,<span class="ruby-identifier">data_format</span>)
730:           <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
731:         <span class="ruby-keyword kw">end</span>
732:         <span class="ruby-identifier">data</span> = <span class="ruby-identifier">row</span>.<span class="ruby-identifier">latest_revision_no</span>.<span class="ruby-identifier">to_s</span>
733:         <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">data</span>,<span class="ruby-identifier">data_format</span>)
734:         <span class="ruby-identifier">column</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
735:       <span class="ruby-keyword kw">end</span>
736: 
737:       <span class="ruby-identifier">remark</span> = <span class="ruby-value str">&quot;&quot;</span>
738:       <span class="ruby-identifier">remark</span> = <span class="ruby-identifier">remove_reserve_character</span>(<span class="ruby-identifier">row</span>.<span class="ruby-identifier">remark</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">row</span>.<span class="ruby-identifier">remark</span>).<span class="ruby-identifier">nil?</span>
739:       <span class="ruby-identifier">worksheet</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">line</span>,<span class="ruby-identifier">column</span>,<span class="ruby-identifier">remark</span>,<span class="ruby-identifier">data_format</span>)
740:       <span class="ruby-identifier">column</span> = <span class="ruby-value">0</span>
741:       <span class="ruby-identifier">line</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
742:     <span class="ruby-keyword kw">end</span>
743:     <span class="ruby-identifier">workbook</span>.<span class="ruby-identifier">close</span>
744:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">file_path</span>,<span class="ruby-value str">&quot;_&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">time</span>
745:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>